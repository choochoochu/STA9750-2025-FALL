<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Sojung Chu">
<meta name="dcterms.date" content="2025-12-18">

<title>When 311 Complaints Stop Measuring NYC Rats – STA 9750 Submission Material</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-1da6786241c1bccb5f16eb615ba2d244.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>

<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">

<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>


  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">STA 9750 Submission Material</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./mp01.html"> 
<span class="menu-text">Netflix Press Release</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp02.html"> 
<span class="menu-text">YIMBY Policy Brief</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp03.html"> 
<span class="menu-text">NYC Tree Proposal</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./mp04.html"> 
<span class="menu-text">BLS Fact Check</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">About Me</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#methodology" id="toc-methodology" class="nav-link" data-scroll-target="#methodology">Methodology</a>
  <ul class="collapse">
  <li><a href="#data-acquisition" id="toc-data-acquisition" class="nav-link" data-scroll-target="#data-acquisition">Data Acquisition</a>
  <ul class="collapse">
  <li><a href="#rodent-inspections" id="toc-rodent-inspections" class="nav-link" data-scroll-target="#rodent-inspections">Rodent Inspections</a></li>
  <li><a href="#rodent-complaints" id="toc-rodent-complaints" class="nav-link" data-scroll-target="#rodent-complaints">311 Rodent Complaints</a></li>
  <li><a href="#neighborhood-tabulation-areas-nta" id="toc-neighborhood-tabulation-areas-nta" class="nav-link" data-scroll-target="#neighborhood-tabulation-areas-nta">Neighborhood Tabulation Areas (NTA)</a></li>
  <li><a href="#community-districts" id="toc-community-districts" class="nav-link" data-scroll-target="#community-districts">Community Districts</a></li>
  </ul></li>
  <li><a href="#data-integration" id="toc-data-integration" class="nav-link" data-scroll-target="#data-integration">Data Integration</a></li>
  <li><a href="#data-construction" id="toc-data-construction" class="nav-link" data-scroll-target="#data-construction">Data Construction</a>
  <ul class="collapse">
  <li><a href="#meter-radius" id="toc-meter-radius" class="nav-link" data-scroll-target="#meter-radius">150 Meter Radius</a></li>
  <li><a href="#nta-level" id="toc-nta-level" class="nav-link" data-scroll-target="#nta-level">NTA Level</a></li>
  <li><a href="#community-district-level" id="toc-community-district-level" class="nav-link" data-scroll-target="#community-district-level">Community District Level</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#exploratory-data-analysis" id="toc-exploratory-data-analysis" class="nav-link" data-scroll-target="#exploratory-data-analysis">Exploratory Data Analysis</a></li>
  <li><a href="#statistical-analysis-using-difference-in-differences" id="toc-statistical-analysis-using-difference-in-differences" class="nav-link" data-scroll-target="#statistical-analysis-using-difference-in-differences">Statistical Analysis Using Difference-in-Differences</a>
  <ul class="collapse">
  <li><a href="#did-model-estimates" id="toc-did-model-estimates" class="nav-link" data-scroll-target="#did-model-estimates">DiD Model Estimates</a>
  <ul class="collapse">
  <li><a href="#m-radius-model" id="toc-m-radius-model" class="nav-link" data-scroll-target="#m-radius-model">150m Radius Model</a></li>
  <li><a href="#nta-model" id="toc-nta-model" class="nav-link" data-scroll-target="#nta-model">NTA Model</a></li>
  <li><a href="#community-district-model" id="toc-community-district-model" class="nav-link" data-scroll-target="#community-district-model">Community District Model</a></li>
  </ul></li>
  <li><a href="#model-validation" id="toc-model-validation" class="nav-link" data-scroll-target="#model-validation">Model Validation</a>
  <ul class="collapse">
  <li><a href="#stable-unit-treatment-value-assumption-sutva" id="toc-stable-unit-treatment-value-assumption-sutva" class="nav-link" data-scroll-target="#stable-unit-treatment-value-assumption-sutva">Stable Unit Treatment Value Assumption (SUTVA)</a></li>
  <li><a href="#parallel-trends" id="toc-parallel-trends" class="nav-link" data-scroll-target="#parallel-trends">Parallel Trends</a></li>
  </ul></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">Results</a></li>
  </ul></li>
  <li><a href="#conclusion-further-steps" id="toc-conclusion-further-steps" class="nav-link" data-scroll-target="#conclusion-further-steps">Conclusion/ Further Steps</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">When 311 Complaints Stop Measuring NYC Rats</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
<p class="subtitle lead">Identifying Bias in Spatial Scale Using Statistical Analysis</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Sojung Chu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 18, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="images/splinter.png" class="img-fluid figure-img" style="width:25.0%"></p>
<figcaption>Master Splinter</figcaption>
</figure>
</div>
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This report is my individual component of a <a href="https://shreyakarki71.github.io/STA9750-2025-FALL/final_project.html">group final course project</a> with <a href="https://shreyakarki71.github.io/STA9750-2025-FALL/individual_report.html">Shreya</a>, <a href="https://rcutsumpas-cloud.github.io/STA9750-2025-FALL/docs/rats_analysis_demo.html">Rachel</a>, <a href="https://ghirschhorn.github.io/STA9750-2025-FALL/final.html">Geraldine</a>, <a href="https://samsmadge.github.io/STA9750-2025-FALL/individual_report.html">David</a>, and <a href="https://git4wing.github.io/STA9750-2025-FALL/Final_individual.html#introduction">Wing</a>. Initially, we wanted to solve the case of the pesky rats that rule over New York City (NYC) by finding a correlation between the 311 rodent complaints, which are often used as markers for where the rats are located, and other factors. While much of the existing research focuses on identifying the factors that lead to rat infestations, our study instead examined whether 311 rodent complaints are an accurate proxy for rat prevalence. We investigated whether reliance on 311 data introduces bias.</p>
<blockquote class="blockquote">
<p><strong>Specific Research Question: Does spatial aggregation cause 311 rodent calls to reflect reporting behavior rather than rat activity?</strong></p>
</blockquote>
<p>My analysis addresses whether spatial aggregation causes rodent complaints to reflect reporting behavior rather than rat activity. In 2017, NYC began designating <a href="https://codelibrary.amlegal.com/codes/newyorkcity/latest/NYCrules/0-0-0-138869">Rat Mitigation Zones</a>, with one criterion being the number of rat-related 311 complaints at the community district level. A difference-in-differences approach was used to compare 311 rodent complaints before and after a rodent inspection, with a passed inspection treated as the event at time zero. With inferring that a passed inspection signals acceptable rat conditions, we expect complaints to decline within the spatial unit after a passed inspection, provided the unit accurately captures rodent activity. This expectation was evaluated at three spatial scales: a local 150‑meter radius, Neighborhood Tabulation Areas (NTA) to maintain consistency with my groupmate’s analysis, and Community Districts to align with how NYC aggregates 311 rat complaints.</p>
<p>The technical details of the analysis, including data acquisition, data cleaning, exploratory data analysis, and model estimation, are documented in this report. Reproducible code and detailed explanations illustrating how difference-in-differences models were developed and evaluated using NYC data are also included. All analyses were conducted in R through associated packages.</p>
</section>
<section id="methodology" class="level1">
<h1>Methodology</h1>
<p>The following methods were used to obtain and reconstruction four datasets to prepare for analysis.</p>
<section id="data-acquisition" class="level2">
<h2 class="anchored" data-anchor-id="data-acquisition">Data Acquisition</h2>
<p>Data was downloaded responsibly through functions that only download the required data if it does not already exist. Before this, the process starts by loading necessary packages through a helper function that installs and loads R packages used throughout this report.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Install and load an R package if it is not already available.</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pkg A character string specifying the name of the package to load.</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Invisibly returns TRUE if the package is successfully loaded.</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' load_package("tidyr")</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>load_package <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg) {</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(pkg, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(pkg)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>PACKAGES <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"httr2"</span>, <span class="st">"jsonlite"</span>, <span class="st">"dplyr"</span>, <span class="st">"sf"</span>, <span class="st">"purrr"</span>, <span class="st">"tidyr"</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>              <span class="st">"lubridate"</span>, <span class="st">"readr"</span>, <span class="st">"tidyverse"</span>, <span class="st">"nngeo"</span>, <span class="st">"ggplot2"</span>, <span class="st">"fixest"</span>, <span class="st">"nngeo"</span>, <span class="st">"scales"</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>              <span class="st">"knitr"</span>, <span class="st">"ggrepel"</span>, <span class="st">"kableExtra"</span>, <span class="st">"shiny"</span>, <span class="st">"leaflet"</span>, <span class="st">"data.table"</span>, <span class="st">"modelsummary"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(PACKAGES, load_package)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "httr2"     "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[7] "methods"   "base"     

[[2]]
[1] "jsonlite"  "httr2"     "stats"     "graphics"  "grDevices" "utils"    
[7] "datasets"  "methods"   "base"     

[[3]]
 [1] "dplyr"     "jsonlite"  "httr2"     "stats"     "graphics"  "grDevices"
 [7] "utils"     "datasets"  "methods"   "base"     

[[4]]
 [1] "sf"        "dplyr"     "jsonlite"  "httr2"     "stats"     "graphics" 
 [7] "grDevices" "utils"     "datasets"  "methods"   "base"     

[[5]]
 [1] "purrr"     "sf"        "dplyr"     "jsonlite"  "httr2"     "stats"    
 [7] "graphics"  "grDevices" "utils"     "datasets"  "methods"   "base"     

[[6]]
 [1] "tidyr"     "purrr"     "sf"        "dplyr"     "jsonlite"  "httr2"    
 [7] "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"  
[13] "base"     

[[7]]
 [1] "lubridate" "tidyr"     "purrr"     "sf"        "dplyr"     "jsonlite" 
 [7] "httr2"     "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[13] "methods"   "base"     

[[8]]
 [1] "readr"     "lubridate" "tidyr"     "purrr"     "sf"        "dplyr"    
 [7] "jsonlite"  "httr2"     "stats"     "graphics"  "grDevices" "utils"    
[13] "datasets"  "methods"   "base"     

[[9]]
 [1] "forcats"   "stringr"   "tibble"    "ggplot2"   "tidyverse" "readr"    
 [7] "lubridate" "tidyr"     "purrr"     "sf"        "dplyr"     "jsonlite" 
[13] "httr2"     "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[19] "methods"   "base"     

[[10]]
 [1] "nngeo"     "forcats"   "stringr"   "tibble"    "ggplot2"   "tidyverse"
 [7] "readr"     "lubridate" "tidyr"     "purrr"     "sf"        "dplyr"    
[13] "jsonlite"  "httr2"     "stats"     "graphics"  "grDevices" "utils"    
[19] "datasets"  "methods"   "base"     

[[11]]
 [1] "nngeo"     "forcats"   "stringr"   "tibble"    "ggplot2"   "tidyverse"
 [7] "readr"     "lubridate" "tidyr"     "purrr"     "sf"        "dplyr"    
[13] "jsonlite"  "httr2"     "stats"     "graphics"  "grDevices" "utils"    
[19] "datasets"  "methods"   "base"     

[[12]]
 [1] "fixest"    "nngeo"     "forcats"   "stringr"   "tibble"    "ggplot2"  
 [7] "tidyverse" "readr"     "lubridate" "tidyr"     "purrr"     "sf"       
[13] "dplyr"     "jsonlite"  "httr2"     "stats"     "graphics"  "grDevices"
[19] "utils"     "datasets"  "methods"   "base"     

[[13]]
 [1] "fixest"    "nngeo"     "forcats"   "stringr"   "tibble"    "ggplot2"  
 [7] "tidyverse" "readr"     "lubridate" "tidyr"     "purrr"     "sf"       
[13] "dplyr"     "jsonlite"  "httr2"     "stats"     "graphics"  "grDevices"
[19] "utils"     "datasets"  "methods"   "base"     

[[14]]
 [1] "scales"    "fixest"    "nngeo"     "forcats"   "stringr"   "tibble"   
 [7] "ggplot2"   "tidyverse" "readr"     "lubridate" "tidyr"     "purrr"    
[13] "sf"        "dplyr"     "jsonlite"  "httr2"     "stats"     "graphics" 
[19] "grDevices" "utils"     "datasets"  "methods"   "base"     

[[15]]
 [1] "knitr"     "scales"    "fixest"    "nngeo"     "forcats"   "stringr"  
 [7] "tibble"    "ggplot2"   "tidyverse" "readr"     "lubridate" "tidyr"    
[13] "purrr"     "sf"        "dplyr"     "jsonlite"  "httr2"     "stats"    
[19] "graphics"  "grDevices" "utils"     "datasets"  "methods"   "base"     

[[16]]
 [1] "ggrepel"   "knitr"     "scales"    "fixest"    "nngeo"     "forcats"  
 [7] "stringr"   "tibble"    "ggplot2"   "tidyverse" "readr"     "lubridate"
[13] "tidyr"     "purrr"     "sf"        "dplyr"     "jsonlite"  "httr2"    
[19] "stats"     "graphics"  "grDevices" "utils"     "datasets"  "methods"  
[25] "base"     

[[17]]
 [1] "kableExtra" "ggrepel"    "knitr"      "scales"     "fixest"    
 [6] "nngeo"      "forcats"    "stringr"    "tibble"     "ggplot2"   
[11] "tidyverse"  "readr"      "lubridate"  "tidyr"      "purrr"     
[16] "sf"         "dplyr"      "jsonlite"   "httr2"      "stats"     
[21] "graphics"   "grDevices"  "utils"      "datasets"   "methods"   
[26] "base"      

[[18]]
 [1] "shiny"      "kableExtra" "ggrepel"    "knitr"      "scales"    
 [6] "fixest"     "nngeo"      "forcats"    "stringr"    "tibble"    
[11] "ggplot2"    "tidyverse"  "readr"      "lubridate"  "tidyr"     
[16] "purrr"      "sf"         "dplyr"      "jsonlite"   "httr2"     
[21] "stats"      "graphics"   "grDevices"  "utils"      "datasets"  
[26] "methods"    "base"      

[[19]]
 [1] "leaflet"    "shiny"      "kableExtra" "ggrepel"    "knitr"     
 [6] "scales"     "fixest"     "nngeo"      "forcats"    "stringr"   
[11] "tibble"     "ggplot2"    "tidyverse"  "readr"      "lubridate" 
[16] "tidyr"      "purrr"      "sf"         "dplyr"      "jsonlite"  
[21] "httr2"      "stats"      "graphics"   "grDevices"  "utils"     
[26] "datasets"   "methods"    "base"      

[[20]]
 [1] "data.table" "leaflet"    "shiny"      "kableExtra" "ggrepel"   
 [6] "knitr"      "scales"     "fixest"     "nngeo"      "forcats"   
[11] "stringr"    "tibble"     "ggplot2"    "tidyverse"  "readr"     
[16] "lubridate"  "tidyr"      "purrr"      "sf"         "dplyr"     
[21] "jsonlite"   "httr2"      "stats"      "graphics"   "grDevices" 
[26] "utils"      "datasets"   "methods"    "base"      

[[21]]
 [1] "modelsummary" "data.table"   "leaflet"      "shiny"        "kableExtra"  
 [6] "ggrepel"      "knitr"        "scales"       "fixest"       "nngeo"       
[11] "forcats"      "stringr"      "tibble"       "ggplot2"      "tidyverse"   
[16] "readr"        "lubridate"    "tidyr"        "purrr"        "sf"          
[21] "dplyr"        "jsonlite"     "httr2"        "stats"        "graphics"    
[26] "grDevices"    "utils"        "datasets"     "methods"      "base"        </code></pre>
</div>
</div>
<section id="rodent-inspections" class="level3">
<h3 class="anchored" data-anchor-id="rodent-inspections">Rodent Inspections</h3>
<p>The NYC Rat Inspection dataset contains records of rodent inspections conducted across the five boroughs in response to public complaints and routine monitoring. This dataset is compiled and published by the New York City Department of Health and Mental Hygiene (DOHMH) and is publicly available through <a href="https://data.cityofnewyork.us/Health/Rodent-Inspection/p937-wjvj/about_data">NYC Open Data</a>. The dataset contains approximately 2.9 million records, with a small number of inspections dated between 1918 and 1971 and two records from 2000, but these early outliers were removed. The majority of observations begin on January 1, 2001, and extend through December 8, 2025. Each record represents an individual inspection and includes information such as the inspection date, inspection outcome, and location details. Some records list inspection dates in 2045. These future-dated entries were identified as data errors and were removed.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and cache NYC rat inspection records from NYC Open Data.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This chunk defines a helper function that retrieves rat inspection records from the</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' NYC Open Data API and stores a local cached copy for reuse in future runs. Because</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' the dataset can exceed single-request limits, the function downloads the data in</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' paginated batches using `$limit` and `$offset`, combines the batches into a single</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' table, and saves the result as a CSV in the project data directory. If a cached file</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' already exists and `refresh = FALSE`, the function reads the local CSV instead of</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' re-downloading the data.</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble containing the full set of rat inspection records returned by the</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' NYC Open Data endpoint.</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' rat_inspection &lt;- load_rat_inspection()</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure a local directory exists for storing cached API downloads.</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Caching downloaded files allows the analysis to be rerun without</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co"># repeatedly querying the NYC Open Data API.</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data/final"</span>)) {</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="st">"data/final"</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>load_rat_inspection <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">refresh =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a local cache path so the dataset can be reused across runs.</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Caching avoids repeated API calls and makes the workflow reproducible.</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/final"</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  f_name     <span class="ot">&lt;-</span> <span class="st">"rat_inspection.csv"</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  file_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create the cache directory if it does not already exist.</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no cached file is available, or if a refresh is requested, download the data.</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otherwise, read the previously saved file from disk.</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path) <span class="sc">||</span> refresh) {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Downloading full rat inspection dataset from NYC Open Data..."</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Specify the NYC Open Data endpoint used to retrieve the inspection records.</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/p937-wjvj.json"</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The Socrata API limits the number of rows returned per request, so the full</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dataset is retrieved in repeated chunks using limit and offset parameters.</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    chunk_limit <span class="ot">&lt;-</span> <span class="dv">50000</span>L</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    all_chunks <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    offset     <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    chunk_id   <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Requesting rows with offset = "</span>, offset, <span class="st">" ..."</span>)</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> <span class="fu">request</span>(base_url) <span class="sc">|&gt;</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req_url_query</span>(</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>          <span class="st">"$limit"</span>  <span class="ot">=</span> chunk_limit,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>          <span class="st">"$offset"</span> <span class="ot">=</span> offset</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req_perform</span>()</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Stop execution if the API request fails.</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Parse the response into a tabular object that can be combined across chunks.</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Flattening is used to bring nested fields into regular columns when present.</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>      raw_json <span class="ot">&lt;-</span> <span class="fu">resp_body_string</span>(resp)</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>      dat_list <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(raw_json, <span class="at">flatten =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>      chunk_tbl <span class="ot">&lt;-</span> dat_list <span class="sc">|&gt;</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>()</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>      n_chunk <span class="ot">&lt;-</span> <span class="fu">nrow</span>(chunk_tbl)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Retrieved "</span>, n_chunk, <span class="st">" rows in chunk "</span>, chunk_id, <span class="st">"."</span>)</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>      <span class="co"># A zero-row response indicates the end of the export.</span></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (n_chunk <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"No more rows returned. Reached end of dataset."</span>)</span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>      all_chunks[[chunk_id]] <span class="ot">&lt;-</span> chunk_tbl</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If the chunk is smaller than the request limit, assume this is the final page.</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (n_chunk <span class="sc">&lt;</span> chunk_limit) {</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Final chunk returned fewer than "</span>, chunk_limit, <span class="st">" rows."</span>)</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Otherwise, advance the offset and request the next batch.</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>      offset   <span class="ot">&lt;-</span> offset <span class="sc">+</span> n_chunk</span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>      chunk_id <span class="ot">&lt;-</span> chunk_id <span class="sc">+</span> <span class="dv">1</span>L</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all retrieved chunks into a single table.</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    rat_inspection <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_chunks)</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Total rows downloaded: "</span>, <span class="fu">nrow</span>(rat_inspection))</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the assembled dataset so it can load it from disk.</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(rat_inspection, file_path)</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing rat inspection data from CSV..."</span>)</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>    rat_inspection <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>  rat_inspection</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>rat_inspection <span class="ot">&lt;-</span> <span class="fu">load_rat_inspection</span>()</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out inspection records with implausible dates that likely reflect data issues.</span></span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a><span class="co"># This removes a small number of records dated 1918–1971, the two records from 2000,</span></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a><span class="co"># and outliers dated in 2045.</span></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>rat_inspection <span class="ot">&lt;-</span> rat_inspection <span class="sc">|&gt;</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inspection_date =</span> <span class="fu">as_date</span>(inspection_date)) <span class="sc">|&gt;</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(inspection_date)) <span class="sc">|&gt;</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(inspection_date) <span class="sc">&gt;=</span> <span class="dv">1972</span>,</span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>         <span class="fu">year</span>(inspection_date) <span class="sc">&lt;=</span> <span class="dv">2024</span>) <span class="sc">|&gt;</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(inspection_date) <span class="sc">!=</span> <span class="dv">2000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="rodent-complaints" class="level3">
<h3 class="anchored" data-anchor-id="rodent-complaints">311 Rodent Complaints</h3>
<p>The New York City 311 Rodent Complaints data set contains records of non-emergency service requests submitted by residents reporting rodent sightings and related issues. This data set is compiled and made publicly available through the NYC Open Data portal and includes complaints submitted to the <a href="https://data.cityofnewyork.us/Social-Services/311-Rodent-Complaints/cvf2-zn8s/about_data">NYC 311 service system</a>. The data set contains approximately 492,000 records and spans from January 2010 through December 2025. Each record represents an individual complaint and includes information such as the date the complaint was submitted, complaint type, location details, and additional service request attributes. The 311 Rodent Complaints data set provides a comprehensive view of public reporting of rodent activity across New York City and is particularly valuable for researchers and urban planners studying urban wildlife interactions, public health concerns, and neighborhood-level patterns in rodent reporting behavior.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and assemble NYC 311 rodent complaint records from NYC Open Data.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This chunk prepares a local data directory and defines a helper function that</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' retrieves NYC 311 rodent complaint data from the NYC Open Data API. Because the</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' dataset can exceed single-request limits, the function downloads the data in</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' paginated batches using `$limit` and `$offset`. Each batch is cached locally as</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' a GeoJSON file to avoid repeated downloads and to make the workflow reproducible.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' The cached batches are then read with `st_read()` and combined into a single dataset.</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An `sf` object containing the full set of rodent complaint records returned</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' by the NYC Open Data endpoint.</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' rodent_complaints &lt;- get_rodent_complaints()</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a helper function to download and assemble NYC 311 rodent complaint data.</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># The function retrieves the data in batches to accommodate API request limits,</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># caches each batch locally as a GeoJSON file, and combines all batches into</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># a single sf object for downstream analysis.</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>get_rodent_complaints <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the NYC Open Data API endpoint for 311 rodent complaints.</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The data are served as GeoJSON and must be retrieved in multiple requests.</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>  ENDPOINT <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/cvf2-zn8s.geojson"</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  BATCH_SIZE    <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  OFFSET        <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  END_OF_EXPORT <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  FILE_INDEX    <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  ALL_DATA      <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue requesting data until the API returns fewer rows than the batch size,</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># which signals that the end of the dataset has been reached.</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="sc">!</span>END_OF_EXPORT) {</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct a stable filename for the current batch so that it can be reused</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># across multiple runs of the analysis.</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    file_name <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"rodent_311_%04d.geojson"</span>, FILE_INDEX)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/final"</span>, file_name)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download the current batch only if it has not already been saved locally.</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This avoids unnecessary API calls and improves reproducibility.</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>      req <span class="ot">&lt;-</span> <span class="fu">request</span>(ENDPOINT) <span class="sc">|&gt;</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req_url_query</span>(</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">$limit</span><span class="st">`</span>  <span class="ot">=</span> BATCH_SIZE,</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">$offset</span><span class="st">`</span> <span class="ot">=</span> OFFSET</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> <span class="fu">req_perform</span>(req)</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resp_body_raw</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="fu">writeBin</span>(<span class="at">con =</span> file_path)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the cached GeoJSON batch into an sf object.</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    batch_data <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append the current batch to the list of all downloaded data.</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">c</span>(ALL_DATA, <span class="fu">list</span>(batch_data))</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the number of returned rows is smaller than the requested batch size,</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the final page has been reached and the loop can terminate.</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">NROW</span>(batch_data) <span class="sc">!=</span> BATCH_SIZE) {</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>      END_OF_EXPORT <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>      OFFSET     <span class="ot">&lt;-</span> OFFSET <span class="sc">+</span> BATCH_SIZE</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>      FILE_INDEX <span class="ot">&lt;-</span> FILE_INDEX <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all downloaded batches into a single sf object.</span></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>  ALL_DATA <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(ALL_DATA)</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ALL_DATA)</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the data download and combination step and store the result.</span></span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>rodent_complaints <span class="ot">&lt;-</span> <span class="fu">get_rodent_complaints</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="neighborhood-tabulation-areas-nta" class="level3">
<h3 class="anchored" data-anchor-id="neighborhood-tabulation-areas-nta">Neighborhood Tabulation Areas (NTA)</h3>
<p>The 2020 <a href="https://www.nyc.gov/content/planning/pages/resources/datasets/neighborhood-tabulation">New York City Neighborhood Tabulation Area</a> (NTA) boundary polygons were downloaded from an ArcGIS REST service provided by the City of New York. These polygons define standardized neighborhood units commonly used for demographic and public health analyses. The boundary file was cached locally to ensure reproducibility and loaded as a spatial object, then transformed to the EPSG:4326 coordinate reference system to align with the rodent inspection and 311 complaint data. A lookup table mapping NTA names to their official NTA codes was also created to facilitate consistent joins across datasets.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and load NYC Neighborhood Tabulation Area (NTA) boundary polygons.</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads the 2020 Neighborhood Tabulation Area boundary polygons from an</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' ArcGIS REST endpoint and caches the GeoJSON locally for reuse. If the file already exists</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' locally, it is read from disk instead of being downloaded again.</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' The boundaries are loaded as an `sf` object and transformed to EPSG:4326 to align with</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' the coordinate reference system used by the rodent datasets.</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nta_url URL of the ArcGIS GeoJSON endpoint (default provided).</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nta_path Local filepath used to cache the downloaded GeoJSON.</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An `sf` object containing NYC Neighborhood Tabulation Area polygon geometries</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'   and associated attributes.</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom httr2 request req_perform resp_check_status resp_body_raw</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom sf st_read st_transform</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>load_nta_boundaries <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">nta_url  =</span> <span class="st">"https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_Neighborhood_Tabulation_Areas_2020/FeatureServer/0/query?where=1=1&amp;outFields=*&amp;outSR=4326&amp;f=pgeojson"</span>,</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">nta_path =</span> <span class="st">"data/final/nta_2020.geojson"</span>,</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh  =</span> <span class="cn">FALSE</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure the output directory exists before attempting to write cached files.</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(nta_path)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)) {</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download the file only if it is not already cached locally.</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This keeps the workflow reproducible and avoids repeated requests to the server.</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(nta_path)) {</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">request</span>(nta_url) <span class="sc">|&gt;</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_perform</span>()</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_body_raw</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">writeBin</span>(<span class="at">con =</span> nta_path)</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the cached NTA boundaries as an sf object and standardize the CRS.</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Using a consistent CRS ensures spatial joins and distance calculations work as expected.</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>  nta <span class="ot">&lt;-</span> <span class="fu">st_read</span>(nta_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(nta)</span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>nta <span class="ot">&lt;-</span> <span class="fu">load_nta_boundaries</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="community-districts" class="level3">
<h3 class="anchored" data-anchor-id="community-districts">Community Districts</h3>
<p>The New York City <a href="https://www.nyc.gov/content/planning/pages/resources/datasets/community-districts">Community District</a> boundary polygons were downloaded from the NYC Department of City Planning’s dataset, using an ArcGIS REST endpoint that provides the boundaries in GeoJSON format. The boundary file was cached locally to support reproducible analyses and to avoid repeated requests to the hosting server. The polygons were then loaded as an sf object and transformed to EPSG:4326 to ensure compatibility with the coordinate reference system used by the rodent inspection and 311 complaint datasets. For spatial joins, the Community District identifier was retained along with the district geometries.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and load NYC Community District boundary polygons.</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads NYC Department of City Planning Community District boundaries</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' from an ArcGIS REST endpoint and caches the GeoJSON locally for reuse. If the file</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' already exists locally, it is read from disk instead of being downloaded again. </span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' The boundaries are loaded as an `sf` object and transformed to to ensure compatibility</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' with other datasets used in the analysis.</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cd_url URL of the ArcGIS GeoJSON endpoint (default provided).</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cd_path Local filepath used to cache the downloaded GeoJSON</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'   (default "data/final/community_districts.geojson").</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An `sf` object containing Community District polygons. The returned object</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co">#'   includes the Community District identifier (`BoroCD`) and geometry.</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom httr2 request req_perform resp_check_status resp_body_raw</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom sf st_read st_transform</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr select</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>load_cd_shapefiles <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd_url  =</span> <span class="st">"https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_Community_Districts/FeatureServer/0/query?where=1=1&amp;outFields=*&amp;outSR=4326&amp;f=pgeojson"</span>,</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd_path =</span> <span class="st">"data/final/community_districts.geojson"</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="cn">FALSE</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure the output directory exists before attempting to write cached files.</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(cd_path)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)) {</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download the GeoJSON only when needed to minimize repeated server requests.</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (refresh <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(cd_path)) {</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">request</span>(cd_url) <span class="sc">|&gt;</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_perform</span>()</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_body_raw</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">writeBin</span>(<span class="at">con =</span> cd_path)</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the cached GeoJSON and standardize to EPSG:4326 for spatial compatibility.</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>  cd <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cd_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only the Community District identifier and geometry used for joins.</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>  cd <span class="ot">&lt;-</span> cd <span class="sc">|&gt;</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(BoroCD, geometry)</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cd)</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>cd_keep <span class="ot">&lt;-</span> <span class="fu">load_cd_shapefiles</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="data-integration" class="level2">
<h2 class="anchored" data-anchor-id="data-integration">Data Integration</h2>
<p>Since the rodent inspection and 311 complaint data are recorded at the point level using latitude and longitude coordinates, I standardized the geographic unit of analysis across the 311 rodent complaint and rodent inspection datasets. Point locations were converted to spatial features and spatially joined to 2020 NTA boundary polygons using a point-in-polygon approach, assigning each record to an NTA.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert rodent complaint coordinates into sf point features.</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract longitude and latitude as numeric values and remove records without valid coordinates.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>rat_coords <span class="ot">&lt;-</span> rodent_complaints <span class="sc">|&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon =</span> <span class="fu">as.numeric</span>(longitude),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> <span class="fu">as.numeric</span>(latitude)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(lon, lat)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the complaint records into an sf object so spatial operations can be applied.</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>rats_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  rat_coords,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">4326</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the NTA polygon boundaries and make sure they are in the same CRS as the complaint points.</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>nta <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/final/nta_2020.geojson"</span>) <span class="sc">|&gt;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Reading layer `nta_2020' from data source 
  `C:\Users\sojun\Documents\STA9750-2025-FALL\data\final\nta_2020.geojson' 
  using driver `GeoJSON'
Simple feature collection with 262 features and 12 fields
Geometry type: POLYGON
Dimension:     XY
Bounding box:  xmin: -74.25559 ymin: 40.49614 xmax: -73.70001 ymax: 40.91554
Geodetic CRS:  WGS 84</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a lookup table mapping NTA names to official NTA codes for later joins.</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>nta_lookup <span class="ot">&lt;-</span> nta <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nta =</span> NTAName,       </span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">nta_code =</span> NTA2020</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join NTA attributes onto each complaint point.</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>rat311_with_nta <span class="ot">&lt;-</span> <span class="fu">st_join</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  rats_sf,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  nta[, <span class="fu">c</span>(<span class="st">"NTA2020"</span>, <span class="st">"NTAName"</span>, <span class="st">"BoroName"</span>)]</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop geometry to work with a regular tabular data frame while keeping the NTA attributes.</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>rat311_with_nta_df <span class="ot">&lt;-</span> rat311_with_nta <span class="sc">|&gt;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Community district polygons were then joined in a similar way.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join: assign each 311 rat point to a Community District (BoroCD)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>rat311_with_cd <span class="ot">&lt;-</span> <span class="fu">st_join</span>(rats_sf, cd_keep)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop geometry for a regular tibble</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>rat311_with_cd_df <span class="ot">&lt;-</span> rat311_with_cd <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop geometry for a regular tabular data frame</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>rat311_with_cd_df <span class="ot">&lt;-</span> rat311_with_cd <span class="sc">|&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Community District (BoroCD) to any NYC dataset with lon/lat columns</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Keeps pipeline modular: load raw data first, enrich later, without modifying originals.</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>add_cd_to_points <span class="ot">&lt;-</span> <span class="cf">function</span>(df,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>                             <span class="at">lon_col =</span> <span class="st">"longitude"</span>,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>                             <span class="at">lat_col =</span> <span class="st">"latitude"</span>,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cd_path =</span> <span class="st">"data/final/community_districts.geojson"</span>) {</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read/prepare Community District polygons (lightweight)</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  cd_keep <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cd_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(BoroCD, geometry)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract coords + drop missing</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>  df_coords <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">lon =</span> <span class="fu">as.numeric</span>(.data[[lon_col]]),</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">lat =</span> <span class="fu">as.numeric</span>(.data[[lat_col]])</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>(lon, lat)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to sf points</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>  df_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(df_coords, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spatial join + return as regular tibble (no geometry column)</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(df_sf, cd_keep, <span class="at">left =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>()</span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>rat_inspection_with_cd_df <span class="ot">&lt;-</span> <span class="fu">add_cd_to_points</span>(rat_inspection)</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>rat311_with_cd_df <span class="ot">&lt;-</span> <span class="fu">add_cd_to_points</span>(rodent_complaints)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="data-construction" class="level2">
<h2 class="anchored" data-anchor-id="data-construction">Data Construction</h2>
<p>In order to implement a event-centered difference-in-differences design, balanced panels were constructed around the timing of passed rodent inspections. For each spatial scale, inspection events were treated as the focal intervention, and 311 rodent complaints were organized relative to the first passed inspection within a given geographic unit. All panels were constructed at a weekly resolution and include both pre- and post-inspection periods, with zero-complaint weeks explicitly retained to support count-based modeling.</p>
<section id="meter-radius" class="level3">
<h3 class="anchored" data-anchor-id="meter-radius">150 Meter Radius</h3>
<p>A distance-based neighborhood radius was constructed around each passed inspection to capture localized responses in 311 complaints. This approach avoids reliance on predefined administrative boundaries. A 150-meter radius was selected to reflect a spatial range over which an inspection could influence nearby complaint behavior while minimizing spillovers from unrelated areas. Each complaint was linked to its nearest passed inspection within this radius, creating inspection-centered neighborhoods that remain fixed over time. Complaint counts were then aggregated weekly, and a balanced panel was constructed around the inspection event. This design prioritizes spatial precision and provides the clearest test of whether 311 complaints respond to localized improvements in rodent conditions.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Construct distance-based difference-in-differences panels around PASS inspections.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' To support the distance-based difference-in-differences analysis, this chunk integrates</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' 311 rodent complaint records with PASS inspection locations using a spatial proximity</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' approach. Both datasets are converted to spatial point features and projected to a</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' coordinate reference system that preserves distances in meters. This allows complaint</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' activity to be measured within a fixed radius of each inspection site and enables</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' spatial proximity to be incorporated directly into the DiD design.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' The resulting data structure supports neighborhood-by-month panels with zero-call</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' months included and is used to estimate Poisson DiD models with neighborhood and</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' month fixed effects.</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the radius, in meters, used to define complaints occurring near a PASS inspection.</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># This value determines the spatial scale at which inspection effects are evaluated.</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># WEEK VERSION (separate names) + recommended filters</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>radius_m_w   <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>window_w_w   <span class="ot">&lt;-</span> <span class="dv">26</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>week_start_w <span class="ot">&lt;-</span> <span class="dv">1</span>   <span class="co"># 1 = Monday, 7 = Sunday</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) 311 calls -&gt; sf points with week</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>calls_sf_w <span class="ot">&lt;-</span> rat311_with_nta_df <span class="sc">%&gt;%</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">%&gt;%</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">created_date_w =</span> <span class="fu">as.Date</span>(created_date),</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">call_week_w    =</span> <span class="fu">floor_date</span>(created_date_w, <span class="st">"week"</span>, <span class="at">week_start =</span> week_start_w)</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">3857</span>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Inspections -&gt; sf points with week (PASS centers)</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>insp_sf_w <span class="ot">&lt;-</span> rat_inspection <span class="sc">%&gt;%</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">%&gt;%</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">inspection_date_w =</span> <span class="fu">ymd</span>(inspection_date),</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">inspection_week_w =</span> <span class="fu">floor_date</span>(inspection_date_w, <span class="st">"week"</span>, <span class="at">week_start =</span> week_start_w)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">3857</span>)</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>pass_sf_w <span class="ot">&lt;-</span> insp_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(result <span class="sc">==</span> <span class="st">"Passed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(inspection_week_w) <span class="sc">%&gt;%</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">neigh_id_w        =</span> <span class="fu">row_number</span>(),</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_pass_week_w =</span> inspection_week_w</span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Nearest PASS for each call within radius</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>nn_out_w <span class="ot">&lt;-</span> <span class="fu">st_nn</span>(</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>  calls_sf_w, pass_sf_w,</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">1</span>, <span class="at">maxdist =</span> radius_m_w,</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">returnDist =</span> <span class="cn">TRUE</span>,</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">progress =</span> <span class="cn">FALSE</span></span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>calls_sf_w <span class="ot">&lt;-</span> calls_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_row_w =</span> <span class="fu">map_int</span>(nn_out_w<span class="sc">$</span>nn, <span class="sc">~</span> <span class="cf">if</span> (<span class="fu">length</span>(.x) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">NA_integer_</span> <span class="cf">else</span> .x[<span class="dv">1</span>]),</span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_to_pass_m_w =</span> <span class="fu">map_dbl</span>(nn_out_w<span class="sc">$</span>dist, <span class="sc">~</span> <span class="cf">if</span> (<span class="fu">length</span>(.x) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">NA_real_</span> <span class="cf">else</span> .x[<span class="dv">1</span>]),</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">neigh_id_w =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(pass_row_w), <span class="cn">NA_integer_</span>, pass_sf_w<span class="sc">$</span>neigh_id_w[pass_row_w])</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pass_row_w)</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Keep only calls within chosen radius of a PASS</span></span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>calls_near_w <span class="ot">&lt;-</span> calls_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dist_to_pass_m_w) <span class="sc">&amp;</span> dist_to_pass_m_w <span class="sc">&lt;=</span> radius_m_w)</span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Aggregate to neighborhood × week: count calls</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>calls_neigh_week_w <span class="ot">&lt;-</span> calls_near_w <span class="sc">%&gt;%</span></span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(neigh_id_w, call_week_w) <span class="sc">%&gt;%</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls_w =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a><span class="co"># PASS event info per neigh_id_w</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>pass_info_w <span class="ot">&lt;-</span> pass_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(neigh_id_w, first_pass_week_w)</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) FULL PANEL: all neighborhoods × all weeks (fill zeros) + event-time vars</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>all_weeks_w <span class="ot">&lt;-</span> <span class="fu">seq</span>(</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">from =</span> <span class="fu">min</span>(calls_neigh_week_w<span class="sc">$</span>call_week_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">to   =</span> <span class="fu">max</span>(calls_neigh_week_w<span class="sc">$</span>call_week_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">by   =</span> <span class="st">"week"</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a><span class="co"># Only neighborhoods that actually get used (nearest for &gt;=1 call within radius)</span></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>all_neigh_w <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(calls_near_w<span class="sc">$</span>neigh_id_w))</span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>full_neigh_panel_w <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">neigh_id_w  =</span> all_neigh_w,</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">call_week_w =</span> all_weeks_w</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>panel_neigh_w <span class="ot">&lt;-</span> full_neigh_panel_w <span class="sc">%&gt;%</span></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_neigh_week_w, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"neigh_id_w"</span>, <span class="st">"call_week_w"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls_w =</span> <span class="fu">replace_na</span>(calls_w, <span class="dv">0</span>L)) <span class="sc">%&gt;%</span></span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pass_info_w, <span class="at">by =</span> <span class="st">"neigh_id_w"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>    <span class="at">rel_week_w  =</span> <span class="fu">as.integer</span>((call_week_w <span class="sc">-</span> first_pass_week_w) <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_pass_w =</span> <span class="fu">as.integer</span>(rel_week_w <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rel_week_w <span class="sc">&gt;=</span> <span class="sc">-</span>window_w_w, rel_week_w <span class="sc">&lt;=</span> window_w_w)</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Recommended filters (balanced window + drop all-zero centers)</span></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>panel_neigh_w <span class="ot">&lt;-</span> panel_neigh_w <span class="sc">%&gt;%</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(neigh_id_w) <span class="sc">%&gt;%</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pre_w        =</span> <span class="fu">sum</span>(rel_week_w <span class="sc">&lt;</span> <span class="dv">0</span>),</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_post_w       =</span> <span class="fu">sum</span>(rel_week_w <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_calls_w  =</span> <span class="fu">sum</span>(calls_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>    n_pre_w <span class="sc">&gt;=</span> <span class="dv">1</span>,</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>    n_post_w <span class="sc">&gt;=</span> <span class="dv">1</span>,</span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>    total_calls_w <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>total_calls_w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="nta-level" class="level3">
<h3 class="anchored" data-anchor-id="nta-level">NTA Level</h3>
<p>311 rodent complaints and inspection dates were aggregated to weekly counts within each Neighborhood Tabulation Area (NTA), and inspection records were used to identify the first passed rodent inspection in each NTA. The first treatment period is defined to begin in the week following the inspection to avoid conflicting inspection-day reporting with post-inspection behavioral or environmental changes. An event-centered panel was constructed by expanding each NTA across a fixed window of relative weeks around the inspection event and merging in weekly complaint counts.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate 311 calls weekly so each NTA has number of calls per week</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Weekly calls by NTA x calendar week (same as you have)</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>calls_weekly <span class="ot">&lt;-</span> rat311_with_nta_df <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">week    =</span> <span class="fu">floor_date</span>(created_date, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id =</span> NTA2020</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(area_id)) <span class="sc">%&gt;%</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id, week) <span class="sc">%&gt;%</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) First PASS week per NTA (same logic, but keep pass_week + treat_start_week)</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>pass_times <span class="ot">&lt;-</span> rat_inspection <span class="sc">%&gt;%</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">area_id =</span> nta_code, <span class="at">pass_date =</span> inspection_date) <span class="sc">%&gt;%</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(area_id), result <span class="sc">==</span> <span class="st">"Passed"</span>, <span class="sc">!</span><span class="fu">is.na</span>(pass_date)) <span class="sc">%&gt;%</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_pass_date   =</span> <span class="fu">min</span>(pass_date),</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_week         =</span> <span class="fu">floor_date</span>(first_pass_date, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_start_week  =</span> pass_week <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">1</span>),</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Build event-centered grid: NTA x rel_week</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>event_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">area_id  =</span> <span class="fu">unique</span>(pass_times<span class="sc">$</span>area_id),</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_week =</span> <span class="sc">-</span><span class="dv">8</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Map each rel_week to the corresponding calendar week for that NTA</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>panel_event <span class="ot">&lt;-</span> event_grid <span class="sc">%&gt;%</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pass_times, <span class="at">by =</span> <span class="st">"area_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> treat_start_week <span class="sc">+</span> <span class="fu">weeks</span>(rel_week),</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_pass =</span> <span class="fu">ifelse</span>(rel_week <span class="sc">&gt;=</span> <span class="dv">0</span>, <span class="dv">1</span>L, <span class="dv">0</span>L)</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_weekly, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"area_id"</span>, <span class="st">"week"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls =</span> <span class="fu">replace_na</span>(calls, <span class="dv">0</span>L))</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional Sanity checks</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a><span class="co"># nrow(panel)</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a><span class="co"># nlevels(panel$area_factor); nlevels(panel$month_factor)</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="co"># table(panel$post_pass)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="community-district-level" class="level3">
<h3 class="anchored" data-anchor-id="community-district-level">Community District Level</h3>
<p>As with the NTA analysis, a symmetric 8-week window before and after the inspection was used. Weekly complaint counts were aligned to event time, to enable direct comparison across spatial scales.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>window_w <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Weekly calls by CD x calendar week</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>calls_weekly_cd <span class="ot">&lt;-</span> rat311_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_cd  =</span> <span class="fu">floor_date</span>(created_date, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">cd_id    =</span> <span class="fu">as.character</span>(BoroCD)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cd_id), <span class="sc">!</span><span class="fu">is.na</span>(week_cd)) <span class="sc">%&gt;%</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id, week_cd) <span class="sc">%&gt;%</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls_cd =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) First PASS week by CD + treat_start_week</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>pass_times_cd <span class="ot">&lt;-</span> rat_inspection_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">cd_id     =</span> <span class="fu">as.character</span>(BoroCD),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_date =</span> inspection_date</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cd_id), result <span class="sc">==</span> <span class="st">"Passed"</span>, <span class="sc">!</span><span class="fu">is.na</span>(pass_date)) <span class="sc">%&gt;%</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_pass_date_cd  =</span> <span class="fu">min</span>(pass_date),</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_week_cd        =</span> <span class="fu">floor_date</span>(first_pass_date_cd, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_start_week_cd =</span> pass_week_cd <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">1</span>),</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Event-centered grid: CD x rel_week</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>event_grid_cd <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd_id      =</span> <span class="fu">unique</span>(pass_times_cd<span class="sc">$</span>cd_id),</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_week_cd =</span> <span class="sc">-</span>window_w<span class="sc">:</span>window_w</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Map rel_week -&gt; calendar week, join calls, fill zeros</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>panel_event_cd <span class="ot">&lt;-</span> event_grid_cd <span class="sc">%&gt;%</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pass_times_cd, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_cd       =</span> treat_start_week_cd <span class="sc">+</span> <span class="fu">weeks</span>(rel_week_cd),</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_pass_cd  =</span> <span class="fu">ifelse</span>(rel_week_cd <span class="sc">&gt;=</span> <span class="dv">0</span>, <span class="dv">1</span>L, <span class="dv">0</span>L)</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_weekly_cd, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"cd_id"</span>, <span class="st">"week_cd"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls_cd =</span> <span class="fu">replace_na</span>(calls_cd, <span class="dv">0</span>L))</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a><span class="co"># (Optional) drop CDs with all-zero calls in the window</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>panel_event_cd <span class="ot">&lt;-</span> panel_event_cd <span class="sc">%&gt;%</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">sum</span>(calls_cd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="exploratory-data-analysis" class="level1">
<h1>Exploratory Data Analysis</h1>
<p>NTAs with many PASS inspections in 2024</p>
<p>Among those, which NTAs still had high 311 rat complaint volumes in 2024</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>passes_2024 <span class="ot">&lt;-</span> rat_inspection <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id =</span> nta_code,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">inspection_date =</span> <span class="fu">ymd</span>(inspection_date),</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(inspection_date)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">==</span> <span class="dv">2024</span>,</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    result <span class="sc">==</span> <span class="st">"Passed"</span>,</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(area_id)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pass_2024 =</span> <span class="fu">n</span>(),</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_pass_2024))</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>passes_2024 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["area_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n_pass_2024"],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"BK0301","2":"11987"},{"1":"BK0302","2":"11220"},{"1":"BK0401","2":"7362"},{"1":"BK0402","2":"7140"},{"1":"MN1002","2":"4907"},{"1":"BK0802","2":"4741"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>calls_2024 <span class="ot">&lt;-</span> rat311_with_nta_df <span class="sc">%&gt;%</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id =</span> NTA2020,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(created_date)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">==</span> <span class="dv">2024</span>,</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(area_id)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">calls_2024 =</span> <span class="fu">n</span>(),</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(calls_2024))</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>calls_2024 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["area_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["calls_2024"],"name":[2],"type":["int"],"align":["right"]}],"data":[{"1":"MN1102","2":"2255"},{"1":"BK0301","2":"930"},{"1":"BK0802","2":"834"},{"1":"MN1002","2":"826"},{"1":"QN0502","2":"799"},{"1":"BK0302","2":"797"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>pass_call_2024 <span class="ot">&lt;-</span> passes_2024 <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_2024, <span class="at">by =</span> <span class="st">"area_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">calls_2024 =</span> <span class="fu">replace_na</span>(calls_2024, <span class="dv">0</span>)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_pass_2024), <span class="fu">desc</span>(calls_2024))</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>pass_call_2024 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["area_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n_pass_2024"],"name":[2],"type":["int"],"align":["right"]},{"label":["calls_2024"],"name":[3],"type":["int"],"align":["right"]}],"data":[{"1":"BK0301","2":"11987","3":"930"},{"1":"BK0302","2":"11220","3":"797"},{"1":"BK0401","2":"7362","3":"706"},{"1":"BK0402","2":"7140","3":"427"},{"1":"MN1002","2":"4907","3":"826"},{"1":"BK0802","2":"4741","3":"834"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>high_pass_threshold <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>n_pass_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>high_call_threshold <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>calls_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>suspicious_areas_2024 <span class="ot">&lt;-</span> pass_call_2024 <span class="sc">%&gt;%</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pass  =</span> n_pass_2024 <span class="sc">&gt;=</span> high_pass_threshold,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_calls =</span> calls_2024 <span class="sc">&gt;=</span> high_call_threshold,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mismatch   =</span> high_pass <span class="sc">&amp;</span> high_calls</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mismatch) <span class="sc">%&gt;%</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_pass_2024), <span class="fu">desc</span>(calls_2024))</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>suspicious_areas_2024</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["area_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["n_pass_2024"],"name":[2],"type":["int"],"align":["right"]},{"label":["calls_2024"],"name":[3],"type":["int"],"align":["right"]},{"label":["high_pass"],"name":[4],"type":["lgl"],"align":["right"]},{"label":["high_calls"],"name":[5],"type":["lgl"],"align":["right"]},{"label":["mismatch"],"name":[6],"type":["lgl"],"align":["right"]}],"data":[{"1":"BK0301","2":"11987","3":"930","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK0302","2":"11220","3":"797","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK0401","2":"7362","3":"706","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK0402","2":"7140","3":"427","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN1002","2":"4907","3":"826","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK0802","2":"4741","3":"834","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN0303","2":"4356","3":"376","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN1102","2":"3972","3":"2255","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN1001","2":"3683","3":"688","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK0901","2":"3197","3":"385","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN0903","2":"3060","3":"378","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN0702","2":"2890","3":"642","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"QN0502","2":"2712","3":"799","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BX0401","2":"2381","3":"257","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN0401","2":"2027","3":"286","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN1101","2":"1801","3":"238","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN0803","2":"1348","3":"636","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN1201","2":"1274","3":"334","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN0701","2":"1166","3":"248","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BX0702","2":"1093","3":"388","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BX0901","2":"1073","3":"390","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BX0703","2":"1002","3":"343","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN0703","2":"991","3":"442","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN1202","2":"962","3":"427","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK0104","2":"849","3":"525","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK0101","2":"684","3":"360","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"MN1203","2":"483","3":"278","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"QN0104","2":"456","3":"245","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK1601","2":"435","3":"294","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"QN0301","2":"400","3":"292","4":"TRUE","5":"TRUE","6":"TRUE"},{"1":"BK1001","2":"348","3":"571","4":"TRUE","5":"TRUE","6":"TRUE"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create table output using kableExtra</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>nta_lookup <span class="ot">&lt;-</span> nta <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id  =</span> NTA2020,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">nta_name =</span> NTAName</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>pass_call_2024 <span class="sc">%&gt;%</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(nta_lookup, <span class="at">by =</span> <span class="st">"area_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(n_pass_2024, <span class="at">n =</span> <span class="dv">6</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">NTA Code</span><span class="st">`</span> <span class="ot">=</span> area_id,</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">NTA Name</span><span class="st">`</span> <span class="ot">=</span> nta_name,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Passed inspections (2024)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">comma</span>(n_pass_2024),</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">311 complaints (2024)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">comma</span>(calls_2024)</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>),</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Top NTAs by passed inspections and their 311 complaint volume (2024)."</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<caption>Top NTAs by passed inspections and their 311 complaint volume (2024).</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">NTA Code</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">NTA Name</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Passed inspections (2024)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">311 complaints (2024)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">BK0301</td>
<td style="text-align: left;">Bedford-Stuyvesant (West)</td>
<td style="text-align: right;">11,987</td>
<td style="text-align: right;">930</td>
</tr>
<tr class="even">
<td style="text-align: left;">BK0302</td>
<td style="text-align: left;">Bedford-Stuyvesant (East)</td>
<td style="text-align: right;">11,220</td>
<td style="text-align: right;">797</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BK0401</td>
<td style="text-align: left;">Bushwick (West)</td>
<td style="text-align: right;">7,362</td>
<td style="text-align: right;">706</td>
</tr>
<tr class="even">
<td style="text-align: left;">BK0402</td>
<td style="text-align: left;">Bushwick (East)</td>
<td style="text-align: right;">7,140</td>
<td style="text-align: right;">427</td>
</tr>
<tr class="odd">
<td style="text-align: left;">MN1002</td>
<td style="text-align: left;">Harlem (North)</td>
<td style="text-align: right;">4,907</td>
<td style="text-align: right;">826</td>
</tr>
<tr class="even">
<td style="text-align: left;">BK0802</td>
<td style="text-align: left;">Crown Heights (North)</td>
<td style="text-align: right;">4,741</td>
<td style="text-align: right;">834</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>NTAs in the top percentile of both inspection volume and complaint volume were flagged as areas where intensive inspection activity coincided with high reporting levels. The above table highlights neighborhoods where complaint volume remains elevated despite frequent inspections in 2024, motivating a closer examination of how spatial scale shapes the relationship between inspections and 311 complaints.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Create flags (including mismatch) ONCE</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>x_cut <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>n_pass_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>y_cut <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>calls_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> pass_call_2024 <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pass  =</span> n_pass_2024 <span class="sc">&gt;=</span> x_cut,</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_calls =</span> calls_2024 <span class="sc">&gt;=</span> y_cut,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mismatch   =</span> high_pass <span class="sc">&amp;</span> high_calls,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> n_pass_2024 <span class="sc">+</span> <span class="dv">1</span>,   <span class="co"># +1 so log scale works with zeros</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> calls_2024 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) (Optional) label only the top 8 mismatch NTAs by complaints</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>label_df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mismatch) <span class="sc">%&gt;%</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(calls_2024, <span class="at">n =</span> <span class="dv">8</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Plot</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> mismatch), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> x_cut <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> y_cut <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> label_df,</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> area_id),</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="cn">Inf</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.25</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PASSED inspections vs 311 rodent complaints by NTA (2024)"</span>,</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed lines mark the 75th percentile; labels show top mismatch NTAs"</span>,</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PASSED inspections in 2024 (log scale)"</span>,</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"311 rodent complaints in 2024 (log scale)"</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="final_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>These areas are now plotted above. NTAs with high volumes of passed inspections and high 311 complaint volumes are highlighted, showing where inspection activity and resident reporting remain simultaneously elevated.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 2024 PASSES by CD</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>passes_cd_2024 <span class="ot">&lt;-</span> rat_inspection_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cd_id =</span> <span class="fu">as.character</span>(BoroCD),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">year  =</span> <span class="fu">year</span>(inspection_date)) <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2024</span>, result <span class="sc">==</span> <span class="st">"Passed"</span>, <span class="sc">!</span><span class="fu">is.na</span>(cd_id)) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_pass_2024 =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2024 CALLS by CD</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>calls_cd_2024 <span class="ot">&lt;-</span> rat311_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cd_id =</span> <span class="fu">as.character</span>(BoroCD),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">year  =</span> <span class="fu">year</span>(created_date)) <span class="sc">%&gt;%</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2024</span>, <span class="sc">!</span><span class="fu">is.na</span>(cd_id)) <span class="sc">%&gt;%</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls_2024 =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>pass_call_cd_2024 <span class="ot">&lt;-</span> passes_cd_2024 <span class="sc">%&gt;%</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_cd_2024, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls_2024 =</span> <span class="fu">replace_na</span>(calls_2024, <span class="dv">0</span>L))</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>pass_call_cd_2024 <span class="sc">|&gt;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(n_pass_2024, <span class="at">n =</span> <span class="dv">6</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pass_2024 =</span> <span class="fu">comma</span>(n_pass_2024),</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">calls_2024  =</span> <span class="fu">comma</span>(calls_2024)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Community District"</span>, <span class="st">"Passed Inspections (2024)"</span>, <span class="st">"311 Complaints (2024)"</span>),</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>),</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Top Community Districts by passed inspections and their 311 complaint volume (2024)."</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-striped table-hover caption-top table-sm small" data-quarto-postprocess="true">
<caption>Top Community Districts by passed inspections and their 311 complaint volume (2024).</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Community District</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Passed Inspections (2024)</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">311 Complaints (2024)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">303</td>
<td style="text-align: right;">23,660</td>
<td style="text-align: right;">1,708</td>
</tr>
<tr class="even">
<td style="text-align: left;">304</td>
<td style="text-align: right;">14,257</td>
<td style="text-align: right;">1,133</td>
</tr>
<tr class="odd">
<td style="text-align: left;">110</td>
<td style="text-align: right;">8,516</td>
<td style="text-align: right;">1,514</td>
</tr>
<tr class="even">
<td style="text-align: left;">103</td>
<td style="text-align: right;">8,459</td>
<td style="text-align: right;">583</td>
</tr>
<tr class="odd">
<td style="text-align: left;">111</td>
<td style="text-align: right;">5,846</td>
<td style="text-align: right;">2,494</td>
</tr>
<tr class="even">
<td style="text-align: left;">308</td>
<td style="text-align: right;">5,794</td>
<td style="text-align: right;">1,025</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Flags + plot</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>x_cut_cd <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_cd_2024<span class="sc">$</span>n_pass_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>y_cut_cd <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_cd_2024<span class="sc">$</span>calls_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>df_cd <span class="ot">&lt;-</span> pass_call_cd_2024 <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pass  =</span> n_pass_2024 <span class="sc">&gt;=</span> x_cut_cd,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_calls =</span> calls_2024 <span class="sc">&gt;=</span> y_cut_cd,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">mismatch   =</span> high_pass <span class="sc">&amp;</span> high_calls,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> n_pass_2024 <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> calls_2024 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>label_df_cd <span class="ot">&lt;-</span> df_cd <span class="sc">%&gt;%</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mismatch) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(calls_2024, <span class="at">n =</span> <span class="dv">8</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_cd, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> mismatch), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> x_cut_cd <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> y_cut_cd <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> label_df_cd, <span class="fu">aes</span>(<span class="at">label =</span> cd_id),</span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">3</span>, <span class="at">max.overlaps =</span> <span class="cn">Inf</span>) <span class="sc">+</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.25</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PASSED inspections vs 311 rodent complaints by Community District (2024)"</span>,</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed lines mark the 75th percentile; labels show top mismatch districts"</span>,</span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PASSED inspections in 2024 (log scale)"</span>,</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"311 rodent complaints in 2024 (log scale)"</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="final_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="statistical-analysis-using-difference-in-differences" class="level1">
<h1>Statistical Analysis Using Difference-in-Differences</h1>
<p>A weekly panel of rat-related 311 complaints by local area was constructed, and the week in which each neighborhood first received a passed inspection (PASS) was identified. An event-centered difference-in-differences design is adopted, in which time is indexed relative to the first passed inspection in each neighborhood. A Poisson regression with neighborhood fixed effects and an indicator for weeks following a passed inspection is estimated using a balanced window of eight weeks before and after the inspection. The Poisson specification is appropriate given the count nature of the outcome and allows for a flexible mean–variance relationship while accommodating a large share of zero-valued observations. This specification compares changes in 311 complaint volume before and after a passed inspection within the same neighborhood, net of time-invariant neighborhood characteristics. Identification relies on the assumption that, absent a passed inspection, complaint trends within neighborhoods would have evolved similarly in the pre- and post-inspection periods.</p>
<section id="did-model-estimates" class="level2">
<h2 class="anchored" data-anchor-id="did-model-estimates">DiD Model Estimates</h2>
<p>All three specifications are estimated using the <code>fixest</code> package to maintain a consistent estimation framework across different spatial scales. In each case, the outcome is a count of rat-related 311 complaints aggregated to the relevant week. Models are estimated with <code>fepois</code>, which fits a fixed-effects Poisson regression via Poisson quasi–maximum likelihood while efficiently absorbing high-dimensional fixed effects. This approach is well suited to complaint counts that are nonnegative and often zero, and it allows unit fixed effects to be included without manually creating large sets of dummy variables. Across specifications, standard errors are clustered at the unit level to account for within-unit serial correlation in complaint activity over time.</p>
<section id="m-radius-model" class="level3">
<h3 class="anchored" data-anchor-id="m-radius-model">150m Radius Model</h3>
<p>First, the following code segment shows the model used for the 150 radius spatial scale.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Poisson DiD model using fixed-effects Poisson using fixest package</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>m150_w <span class="ot">&lt;-</span> <span class="fu">fepois</span>(</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  calls_w <span class="sc">~</span> post_pass_w <span class="sc">|</span> neigh_id_w,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> panel_neigh_w,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> neigh_id_w</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(m150_w)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":[""],"name":[1],"type":["chr"],"align":["left"]},{"label":["m150_w"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Dependent Var.:","2":"calls_w","_rn_":"1"},{"1":"","2":"","_rn_":"2"},{"1":"post_pass_w","2":"-1.135*** (0.0171)","_rn_":"3"},{"1":"Fixed-Effects:","2":"------------------","_rn_":"4"},{"1":"neigh_id_w","2":"Yes","_rn_":"5"},{"1":"_______________","2":"__________________","_rn_":"6"},{"1":"S.E.: Clustered","2":"by: neigh_id_w","_rn_":"7"},{"1":"Observations","2":"3,828,557","_rn_":"8"},{"1":"Squared Cor.","2":"0.02328","_rn_":"9"},{"1":"Pseudo R2","2":"0.08942","_rn_":"10"},{"1":"BIC","2":"2,045,509.4","_rn_":"11"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="nta-model" class="level3">
<h3 class="anchored" data-anchor-id="nta-model">NTA Model</h3>
<p>Next, the following code segment shows the model used for the NTA level spatial scale.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">fepois</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  calls <span class="sc">~</span> post_pass <span class="sc">|</span> area_id,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> panel_event,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> area_id   <span class="co"># cluster by area</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(m)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":[""],"name":[1],"type":["chr"],"align":["left"]},{"label":["m"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Dependent Var.:","2":"calls","_rn_":"1"},{"1":"","2":"","_rn_":"2"},{"1":"post_pass","2":"-0.3691 (0.4187)","_rn_":"3"},{"1":"Fixed-Effects:","2":"----------------","_rn_":"4"},{"1":"area_id","2":"Yes","_rn_":"5"},{"1":"_______________","2":"________________","_rn_":"6"},{"1":"S.E.: Clustered","2":"by: area_id","_rn_":"7"},{"1":"Observations","2":"323","_rn_":"8"},{"1":"Squared Cor.","2":"0.02424","_rn_":"9"},{"1":"Pseudo R2","2":"0.03865","_rn_":"10"},{"1":"BIC","2":"330.21","_rn_":"11"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="community-district-model" class="level3">
<h3 class="anchored" data-anchor-id="community-district-model">Community District Model</h3>
<p>Lastly, the following code segment shows the model used for the Community District level spatial scale.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>m_cd <span class="ot">&lt;-</span> <span class="fu">fepois</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  calls_cd <span class="sc">~</span> post_pass_cd <span class="sc">|</span> cd_id,</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> panel_event_cd,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> cd_id</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(m_cd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":[""],"name":[1],"type":["chr"],"align":["left"]},{"label":["m_cd"],"name":[2],"type":["chr"],"align":["left"]}],"data":[{"1":"Dependent Var.:","2":"calls_cd","_rn_":"1"},{"1":"","2":"","_rn_":"2"},{"1":"post_pass_cd","2":"18.48*** (1e-6)","_rn_":"3"},{"1":"Fixed-Effects:","2":"---------------","_rn_":"4"},{"1":"cd_id","2":"Yes","_rn_":"5"},{"1":"_______________","2":"_______________","_rn_":"6"},{"1":"S.E.: Clustered","2":"by: cd_id","_rn_":"7"},{"1":"Observations","2":"34","_rn_":"8"},{"1":"Squared Cor.","2":"0.10633","_rn_":"9"},{"1":"Pseudo R2","2":"0.20206","_rn_":"10"},{"1":"BIC","2":"26.990","_rn_":"11"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
</section>
<section id="model-validation" class="level2">
<h2 class="anchored" data-anchor-id="model-validation">Model Validation</h2>
<p>Before presenting the main estimates, diagnostic checks were considered to assess the plausibility of the identifying assumptions.</p>
<section id="stable-unit-treatment-value-assumption-sutva" class="level3">
<h3 class="anchored" data-anchor-id="stable-unit-treatment-value-assumption-sutva">Stable Unit Treatment Value Assumption (SUTVA)</h3>
<p>Spillovers across neighborhoods are likely to be limited because rat inspections target specific properties and complaint reporting is highly localized. Residents typically report conditions in their immediate vicinity, making it unlikely that a passed inspection in one neighborhood directly affects complaint behavior in non-adjacent areas.</p>
</section>
<section id="parallel-trends" class="level3">
<h3 class="anchored" data-anchor-id="parallel-trends">Parallel Trends</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>avg_trend_150 <span class="ot">&lt;-</span> panel_neigh_w <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rel_week_w) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_calls =</span> <span class="fu">mean</span>(calls_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rel_week_w)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  avg_trend_150<span class="sc">$</span>rel_week_w,</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  avg_trend_150<span class="sc">$</span>mean_calls,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"b"</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Weeks Relative to PASS"</span>,</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Average 311 Complaints (within 150 m)"</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Pre-Trends: 150 m Inspection-Centered Neighborhoods"</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="final_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Event-time averages for inspection-centered neighborhoods exhibit a pronounced increase in complaint activity immediately prior to PASS inspections, reflecting the fact that inspections are triggered by accumulated complaints. For this reason, the identifying variation comes from comparing post-inspection outcomes to the immediate pre-inspection period rather than to distant pre-periods. The analysis therefore relies on a local parallel trends assumption, under which complaint levels would have remained at their pre-inspection level absent a PASS result.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>avg_trend <span class="ot">&lt;-</span> panel_event <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rel_week) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_calls =</span> <span class="fu">mean</span>(calls, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rel_week)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  avg_trend<span class="sc">$</span>rel_week,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  avg_trend<span class="sc">$</span>mean_calls,</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"b"</span>,</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Weeks Relative to PASS"</span>,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Average 311 Complaints"</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="final_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Event-time averages exhibit some week-to-week variability in the pre-inspection period, which is expected given low complaint counts and aggregation at the neighborhood level. However, there is no evidence of a systematic downward trend prior to PASS inspections. In addition, placebo timing tests yield null effects, providing no evidence of differential pre-trends.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>avg_trend_cd <span class="ot">&lt;-</span> panel_event_cd <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rel_week_cd) <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_calls =</span> <span class="fu">mean</span>(calls_cd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rel_week_cd)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  avg_trend_cd<span class="sc">$</span>rel_week_cd,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  avg_trend_cd<span class="sc">$</span>mean_calls,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"b"</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Weeks Relative to PASS"</span>,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Average 311 Complaints (Community District)"</span>,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Pre-Trends: Community Districts"</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="final_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>At the community district level, average complaint activity shows no pronounced pre-inspection pattern and remains close to zero prior to PASS inspections. This reflects the coarse spatial aggregation of community districts, within which localized inspection-related complaint dynamics are largely diluted.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>Raw coefficient results are not intuitive because Poisson was used in the model. Instead percentage changes can be reported using the following formula:</p>
<p><span class="math display">\[
\% \Delta = 100 \times \left(\exp(\beta) - 1\right)
\]</span> The table below reports the difference-in-differences estimates of the effect of PASS inspections on rat-related 311 complaints across three spatial scales. At the community district level, the estimated effect is small and statistically indistinguishable from zero, reflecting substantial spatial dilution. Estimates at the NTA level are larger in magnitude but imprecise. In contrast, inspection-centered neighborhoods defined within a 150 m radius exhibit a large and statistically significant decline in complaints following a PASS inspection, consistent with highly localized treatment effects.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Models to compare ----</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Community District"</span> <span class="ot">=</span> m_cd,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NTA"</span>                <span class="ot">=</span> m,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"150 m radius"</span>       <span class="ot">=</span> m150_w</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Implied percent change for Poisson coefficients: %Δ = 100 * (exp(β) - 1) ----</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>post_betas <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Community District"</span> <span class="ot">=</span> <span class="fu">coef</span>(m_cd)[[<span class="st">"post_pass_cd"</span>]],</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NTA"</span>                <span class="ot">=</span> <span class="fu">coef</span>(m)[[<span class="st">"post_pass"</span>]],</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"150 m radius"</span>       <span class="ot">=</span> <span class="fu">coef</span>(m150_w)[[<span class="st">"post_pass_w"</span>]]</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>pct_change <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">*</span> (<span class="fu">exp</span>(post_betas) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>pct_change_fmt <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, pct_change)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure names exist and match the table columns (prevents "subscript out of bounds")</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>pct_change_fmt <span class="ot">&lt;-</span> <span class="fu">setNames</span>(</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>  pct_change_fmt,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Community District"</span>, <span class="st">"NTA"</span>, <span class="st">"150 m radius"</span>)</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>add_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="st">"Implied % change (100×(exp(β)−1))"</span>,</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Community District"</span> <span class="ot">=</span> pct_change_fmt[[<span class="st">"Community District"</span>]],</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NTA"</span>                <span class="ot">=</span> pct_change_fmt[[<span class="st">"NTA"</span>]],</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"150 m radius"</span>       <span class="ot">=</span> pct_change_fmt[[<span class="st">"150 m radius"</span>]],</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Results table ----</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>  models,</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">statistic =</span> <span class="st">"({std.error})"</span>,</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">stars =</span> <span class="cn">TRUE</span>,</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_map =</span> <span class="fu">c</span>(</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"post_pass_cd"</span> <span class="ot">=</span> <span class="st">"Post-PASS"</span>,</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"post_pass"</span>    <span class="ot">=</span> <span class="st">"Post-PASS"</span>,</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"post_pass_w"</span>  <span class="ot">=</span> <span class="st">"Post-PASS"</span></span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">add_rows =</span> add_row,</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"html"</span></span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<!-- preamble start -->

    <script src="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.js"></script>

    <script>
      // Create table-specific functions using external factory
      const tableFns_z9vqwm7in2twaygtcpk8 = TinyTable.createTableFunctions("tinytable_z9vqwm7in2twaygtcpk8");
      // tinytable span after
      window.addEventListener('load', function () {
          var cellsToStyle = [
            // tinytable style arrays after
          { positions: [ { i: '15', j: 2 }, { i: '15', j: 3 }, { i: '15', j: 4 } ], css_id: 'tinytable_css_lt1m0i4lrtg6bxgh5s3h',}, 
          { positions: [ { i: '2', j: 2 }, { i: '2', j: 3 }, { i: '2', j: 4 } ], css_id: 'tinytable_css_sy4hve51037toccbciyr',}, 
          { positions: [ { i: '1', j: 2 }, { i: '3', j: 2 }, { i: '4', j: 2 }, { i: '5', j: 2 }, { i: '6', j: 2 }, { i: '7', j: 2 }, { i: '8', j: 2 }, { i: '9', j: 2 }, { i: '10', j: 2 }, { i: '11', j: 2 }, { i: '12', j: 2 }, { i: '13', j: 2 }, { i: '14', j: 2 }, { i: '1', j: 3 }, { i: '3', j: 3 }, { i: '4', j: 3 }, { i: '5', j: 3 }, { i: '6', j: 3 }, { i: '7', j: 3 }, { i: '8', j: 3 }, { i: '9', j: 3 }, { i: '10', j: 3 }, { i: '11', j: 3 }, { i: '12', j: 3 }, { i: '13', j: 3 }, { i: '14', j: 3 }, { i: '1', j: 4 }, { i: '3', j: 4 }, { i: '4', j: 4 }, { i: '5', j: 4 }, { i: '6', j: 4 }, { i: '7', j: 4 }, { i: '8', j: 4 }, { i: '9', j: 4 }, { i: '10', j: 4 }, { i: '11', j: 4 }, { i: '12', j: 4 }, { i: '13', j: 4 }, { i: '14', j: 4 } ], css_id: 'tinytable_css_97pzfhjzgel3jsr7mz3e',}, 
          { positions: [ { i: '0', j: 2 }, { i: '0', j: 3 }, { i: '0', j: 4 } ], css_id: 'tinytable_css_8ypu4j6jllg11a4dglav',}, 
          { positions: [ { i: '15', j: 1 } ], css_id: 'tinytable_css_uu1t6r0tf17w0vbybzvh',}, 
          { positions: [ { i: '2', j: 1 } ], css_id: 'tinytable_css_y9dgjlyvzo06x9d0ch49',}, 
          { positions: [ { i: '1', j: 1 }, { i: '3', j: 1 }, { i: '4', j: 1 }, { i: '5', j: 1 }, { i: '6', j: 1 }, { i: '7', j: 1 }, { i: '8', j: 1 }, { i: '9', j: 1 }, { i: '10', j: 1 }, { i: '11', j: 1 }, { i: '12', j: 1 }, { i: '13', j: 1 }, { i: '14', j: 1 } ], css_id: 'tinytable_css_ujohbbnm67lt7x2yurzr',}, 
          { positions: [ { i: '0', j: 1 } ], css_id: 'tinytable_css_x2il4z937rvylq185vr7',}, 
          ];

          // Loop over the arrays to style the cells
          cellsToStyle.forEach(function (group) {
              group.positions.forEach(function (cell) {
                  tableFns_z9vqwm7in2twaygtcpk8.styleCell(cell.i, cell.j, group.css_id);
              });
          });
      });
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/vincentarelbundock/tinytable@main/inst/tinytable.css">
    <style>
    /* tinytable css entries after */
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_lt1m0i4lrtg6bxgh5s3h, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_lt1m0i4lrtg6bxgh5s3h {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: black; --line-color-left: black; --line-color-right: black; --line-color-top: black; --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%; ; text-align: center }
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_sy4hve51037toccbciyr, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_sy4hve51037toccbciyr {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: black; --line-color-left: black; --line-color-right: black; --line-color-top: black; --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%; ; text-align: center }
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_97pzfhjzgel3jsr7mz3e, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_97pzfhjzgel3jsr7mz3e { text-align: center }
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_8ypu4j6jllg11a4dglav, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_8ypu4j6jllg11a4dglav {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: black; --line-color-left: black; --line-color-right: black; --line-color-top: black; --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%; ; text-align: center }
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_uu1t6r0tf17w0vbybzvh, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_uu1t6r0tf17w0vbybzvh {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: black; --line-color-left: black; --line-color-right: black; --line-color-top: black; --line-width-bottom: 0.1em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%; ; text-align: left }
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_y9dgjlyvzo06x9d0ch49, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_y9dgjlyvzo06x9d0ch49 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 0; --line-color-bottom: black; --line-color-left: black; --line-color-right: black; --line-color-top: black; --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%; ; text-align: left }
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_ujohbbnm67lt7x2yurzr, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_ujohbbnm67lt7x2yurzr { text-align: left }
    #tinytable_z9vqwm7in2twaygtcpk8 td.tinytable_css_x2il4z937rvylq185vr7, #tinytable_z9vqwm7in2twaygtcpk8 th.tinytable_css_x2il4z937rvylq185vr7 {  position: relative; --border-bottom: 1; --border-left: 0; --border-right: 0; --border-top: 1; --line-color-bottom: black; --line-color-left: black; --line-color-right: black; --line-color-top: black; --line-width-bottom: 0.05em; --line-width-left: 0.1em; --line-width-right: 0.1em; --line-width-top: 0.1em; --trim-bottom-left: 0%; --trim-bottom-right: 0%; --trim-left-bottom: 0%; --trim-left-top: 0%; --trim-right-bottom: 0%; --trim-right-top: 0%; --trim-top-left: 0%; --trim-top-right: 0%; ; text-align: left }
    </style>
    <div class="container">
      <table class="tinytable" id="tinytable_z9vqwm7in2twaygtcpk8" style="width: auto; margin-left: auto; margin-right: auto;" data-quarto-disable-processing="true">
        
        <thead>
              <tr>
                <th scope="col" data-row="0" data-col="1"> </th>
                <th scope="col" data-row="0" data-col="2">Community District</th>
                <th scope="col" data-row="0" data-col="3">NTA</th>
                <th scope="col" data-row="0" data-col="4">150 m radius</th>
              </tr>
        </thead>
        <tfoot><tr><td colspan="4">+ p &lt; 0.1, * p &lt; 0.05, ** p &lt; 0.01, *** p &lt; 0.001</td></tr></tfoot>
        <tbody>
                <tr>
                  <td data-row="1" data-col="1">Post-PASS</td>
                  <td data-row="1" data-col="2">18.484***</td>
                  <td data-row="1" data-col="3">−0.369</td>
                  <td data-row="1" data-col="4">−1.135***</td>
                </tr>
                <tr>
                  <td data-row="2" data-col="1"></td>
                  <td data-row="2" data-col="2">(0.000)</td>
                  <td data-row="2" data-col="3">(0.419)</td>
                  <td data-row="2" data-col="4">(0.017)</td>
                </tr>
                <tr>
                  <td data-row="3" data-col="1">Num.Obs.</td>
                  <td data-row="3" data-col="2">34</td>
                  <td data-row="3" data-col="3">323</td>
                  <td data-row="3" data-col="4">3828557</td>
                </tr>
                <tr>
                  <td data-row="4" data-col="1">R2</td>
                  <td data-row="4" data-col="2">0.202</td>
                  <td data-row="4" data-col="3">0.039</td>
                  <td data-row="4" data-col="4">0.089</td>
                </tr>
                <tr>
                  <td data-row="5" data-col="1">R2 Adj.</td>
                  <td data-row="5" data-col="2">0.008</td>
                  <td data-row="5" data-col="3">−0.132</td>
                  <td data-row="5" data-col="4">−0.050</td>
                </tr>
                <tr>
                  <td data-row="6" data-col="1">R2 Within</td>
                  <td data-row="6" data-col="2">0.189</td>
                  <td data-row="6" data-col="3">0.005</td>
                  <td data-row="6" data-col="4">0.032</td>
                </tr>
                <tr>
                  <td data-row="7" data-col="1">R2 Within Adj.</td>
                  <td data-row="7" data-col="2">0.090</td>
                  <td data-row="7" data-col="3">−0.004</td>
                  <td data-row="7" data-col="4">0.032</td>
                </tr>
                <tr>
                  <td data-row="8" data-col="1">AIC</td>
                  <td data-row="8" data-col="2">22.4</td>
                  <td data-row="8" data-col="3">254.7</td>
                  <td data-row="8" data-col="4">1091186.1</td>
                </tr>
                <tr>
                  <td data-row="9" data-col="1">BIC</td>
                  <td data-row="9" data-col="2">27.0</td>
                  <td data-row="9" data-col="3">330.2</td>
                  <td data-row="9" data-col="4">2045509.4</td>
                </tr>
                <tr>
                  <td data-row="10" data-col="1">RMSE</td>
                  <td data-row="10" data-col="2">0.27</td>
                  <td data-row="10" data-col="3">0.38</td>
                  <td data-row="10" data-col="4">0.25</td>
                </tr>
                <tr>
                  <td data-row="11" data-col="1">Std.Errors</td>
                  <td data-row="11" data-col="2">by: cd_id</td>
                  <td data-row="11" data-col="3">by: area_id</td>
                  <td data-row="11" data-col="4">by: neigh_id_w</td>
                </tr>
                <tr>
                  <td data-row="12" data-col="1">FE: cd_id</td>
                  <td data-row="12" data-col="2">X</td>
                  <td data-row="12" data-col="3"></td>
                  <td data-row="12" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="13" data-col="1">FE: area_id</td>
                  <td data-row="13" data-col="2"></td>
                  <td data-row="13" data-col="3">X</td>
                  <td data-row="13" data-col="4"></td>
                </tr>
                <tr>
                  <td data-row="14" data-col="1">FE: neigh_id_w</td>
                  <td data-row="14" data-col="2"></td>
                  <td data-row="14" data-col="3"></td>
                  <td data-row="14" data-col="4">X</td>
                </tr>
                <tr>
                  <td data-row="15" data-col="1">Implied % change (100×(exp(β)−1))</td>
                  <td data-row="15" data-col="2">10652785848.9%</td>
                  <td data-row="15" data-col="3">-30.9%</td>
                  <td data-row="15" data-col="4">-67.9%</td>
                </tr>
        </tbody>
      </table>
    </div>
<!-- hack to avoid NA insertion in last line -->
</div>
</div>
<p>Comparative Point Plot Across Spatial Scales</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: convert log effect + SE into percent change + 95% interval</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>to_pct_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(beta, se, <span class="at">z =</span> <span class="fl">1.96</span>) {</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> beta <span class="sc">-</span> z <span class="sc">*</span> se</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  hi <span class="ot">&lt;-</span> beta <span class="sc">+</span> z <span class="sc">*</span> se</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate_pct =</span> (<span class="fu">exp</span>(beta) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_pct    =</span> (<span class="fu">exp</span>(lo)   <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_pct    =</span> (<span class="fu">exp</span>(hi)   <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Community Districts: m_cd (fixest::fepois), coefficient is post_pass_cd</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>b_cd  <span class="ot">&lt;-</span> <span class="fu">coef</span>(m_cd)[[<span class="st">"post_pass_cd"</span>]]</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>se_cd <span class="ot">&lt;-</span> <span class="fu">se</span>(m_cd)[[<span class="st">"post_pass_cd"</span>]]</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>ci_cd <span class="ot">&lt;-</span> <span class="fu">to_pct_ci</span>(b_cd, se_cd)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) 150m: m150_w (fixest::fepois), coefficient is post_pass_w</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>b_150  <span class="ot">&lt;-</span> <span class="fu">coef</span>(m150_w)[[<span class="st">"post_pass_w"</span>]]</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>se_150 <span class="ot">&lt;-</span> <span class="fu">se</span>(m150_w)[[<span class="st">"post_pass_w"</span>]]</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>ci_150 <span class="ot">&lt;-</span> <span class="fu">to_pct_ci</span>(b_150, se_150)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) NTA: model (glm), coefficient is post_pass</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>b_nta  <span class="ot">&lt;-</span> <span class="fu">coef</span>(m)[[<span class="st">"post_pass"</span>]]</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>se_nta <span class="ot">&lt;-</span> <span class="fu">coef</span>(m)[[<span class="st">"post_pass"</span>]]</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>ci_nta <span class="ot">&lt;-</span> <span class="fu">to_pct_ci</span>(b_nta, se_nta)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into one table (ready for a comparative point plot)</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>results_all <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="fu">c</span>(<span class="st">"150m radius"</span>, <span class="st">"NTA"</span>, <span class="st">"Community District"</span>),</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate_pct =</span> <span class="fu">c</span>(ci_150[<span class="st">"estimate_pct"</span>], ci_nta[<span class="st">"estimate_pct"</span>], ci_cd[<span class="st">"estimate_pct"</span>]),</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower_pct    =</span> <span class="fu">c</span>(ci_150[<span class="st">"lower_pct"</span>],    ci_nta[<span class="st">"lower_pct"</span>],    ci_cd[<span class="st">"lower_pct"</span>]),</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper_pct    =</span> <span class="fu">c</span>(ci_150[<span class="st">"upper_pct"</span>],    ci_nta[<span class="st">"upper_pct"</span>],    ci_cd[<span class="st">"upper_pct"</span>]),</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">NULL</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>results_all</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["scale"],"name":[1],"type":["chr"],"align":["left"]},{"label":["estimate_pct"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["lower_pct"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["upper_pct"],"name":[4],"type":["dbl"],"align":["right"]}],"data":[{"1":"150m radius","2":"-6.787179e+01","3":"-6.893132e+01","4":"-6.677613e+01"},{"1":"NTA","2":"-3.086420e+01","3":"4.252305e+01","4":"-6.646326e+01"},{"1":"Community District","2":"1.065279e+10","3":"1.065276e+10","4":"1.065281e+10"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Compute “complaint drop” vs “expected drop” per NTA.</p>
<p>actual_drop = how much calls actually fell after PASS</p>
<p>pred_drop = how much the model says they should have fallen</p>
<p>drop_score = pred_drop – actual_drop</p>
<p>Big positive drop_score = “calls didn’t drop as much as expected” → bias signal.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted calls from the model</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>panel_event<span class="sc">$</span>pred_calls <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, <span class="at">newdata =</span> panel_event, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre/post averages and DropScore</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>drops <span class="ot">&lt;-</span> panel_event <span class="sc">%&gt;%</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_pre  =</span> <span class="fu">mean</span>(calls[post_pass <span class="sc">==</span> <span class="dv">0</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_post =</span> <span class="fu">mean</span>(calls[post_pass <span class="sc">==</span> <span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_pre    =</span> <span class="fu">mean</span>(pred_calls[post_pass <span class="sc">==</span> <span class="dv">0</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_post   =</span> <span class="fu">mean</span>(pred_calls[post_pass <span class="sc">==</span> <span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_drop =</span> actual_pre <span class="sc">-</span> actual_post,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_drop   =</span> pred_pre   <span class="sc">-</span> pred_post,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_score  =</span> pred_drop  <span class="sc">-</span> actual_drop</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Flag “bias NTAs” High calls before PASS + no drop afterward = bias.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Thresholds for unusually high pre-PASS calls and unusually high non-response score</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>q75_pre  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(drops<span class="sc">$</span>actual_pre,  <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>q75_drop <span class="ot">&lt;-</span> <span class="fu">quantile</span>(drops<span class="sc">$</span>drop_score, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>biased_areas <span class="ot">&lt;-</span> drops <span class="sc">%&gt;%</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pre  =</span> actual_pre <span class="sc">&gt;=</span> q75_pre,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_drop =</span> drop_score <span class="sc">&gt;=</span> q75_drop,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">bias_flag =</span> high_pre <span class="sc">&amp;</span> high_drop</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(drop_score))</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>biased_areas <span class="sc">%&gt;%</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(bias_flag) <span class="sc">%&gt;%</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":["area_id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["actual_pre"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["actual_post"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["pred_pre"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["pred_post"],"name":[5],"type":["dbl"],"align":["right"]},{"label":["actual_drop"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["pred_drop"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["drop_score"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["high_pre"],"name":[9],"type":["lgl"],"align":["right"]},{"label":["high_drop"],"name":[10],"type":["lgl"],"align":["right"]},{"label":["bias_flag"],"name":[11],"type":["lgl"],"align":["right"]}],"data":[{"1":"QN1103","2":"0","3":"0.3333333","4":"0.2109375","5":"0.14583333","6":"-0.3333333","7":"0.06510417","8":"0.3984375","9":"TRUE","10":"TRUE","11":"TRUE"},{"1":"BK0503","2":"0","3":"0.1111111","4":"0.0703125","5":"0.04861111","6":"-0.1111111","7":"0.02170139","8":"0.1328125","9":"TRUE","10":"TRUE","11":"TRUE"},{"1":"BK0703","2":"0","3":"0.1111111","4":"0.0703125","5":"0.04861111","6":"-0.1111111","7":"0.02170139","8":"0.1328125","9":"TRUE","10":"TRUE","11":"TRUE"},{"1":"BK0771","2":"0","3":"0.1111111","4":"0.0703125","5":"0.04861111","6":"-0.1111111","7":"0.02170139","8":"0.1328125","9":"TRUE","10":"TRUE","11":"TRUE"},{"1":"QN0574","2":"0","3":"0.1111111","4":"0.0703125","5":"0.04861111","6":"-0.1111111","7":"0.02170139","8":"0.1328125","9":"TRUE","10":"TRUE","11":"TRUE"},{"1":"QN0703","2":"0","3":"0.1111111","4":"0.0703125","5":"0.04861111","6":"-0.1111111","7":"0.02170139","8":"0.1328125","9":"TRUE","10":"TRUE","11":"TRUE"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
</section>
<section id="conclusion-further-steps" class="level1">
<h1>Conclusion/ Further Steps</h1>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/choochoochu\.github\.io\/STA9750-2025-FALL\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb32" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "When 311 Complaints Stop Measuring NYC Rats"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="an">subtitle:</span><span class="co"> "Identifying Bias in Spatial Scale Using Statistical Analysis"</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Sojung Chu"</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-12-18</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a><span class="an">date-format:</span><span class="co"> "MMMM D, YYYY"</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-location: right</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a><span class="co">    number-sections: false</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-depth: 3</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">    df-print: paged</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co">    # runtime: shiny</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: true</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: true</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="co">  warning: false</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a><span class="co">  message: false</span></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> individual_report.bib</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="an">csl:</span><span class="co"> apa.csl</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="al">![Master Splinter](images/splinter.png)</span>{width=25%}</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="fu"># Introduction</span></span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>This report is my individual component of a <span class="co">[</span><span class="ot">group final course project</span><span class="co">](https://shreyakarki71.github.io/STA9750-2025-FALL/final_project.html)</span> with <span class="co">[</span><span class="ot">Shreya</span><span class="co">](https://shreyakarki71.github.io/STA9750-2025-FALL/individual_report.html)</span>, <span class="co">[</span><span class="ot">Rachel</span><span class="co">](https://rcutsumpas-cloud.github.io/STA9750-2025-FALL/docs/rats_analysis_demo.html)</span>, <span class="co">[</span><span class="ot">Geraldine</span><span class="co">](https://ghirschhorn.github.io/STA9750-2025-FALL/final.html)</span>, <span class="co">[</span><span class="ot">David</span><span class="co">](https://samsmadge.github.io/STA9750-2025-FALL/individual_report.html)</span>, and <span class="co">[</span><span class="ot">Wing</span><span class="co">](https://git4wing.github.io/STA9750-2025-FALL/Final_individual.html#introduction)</span>. Initially, we wanted to solve the case of the pesky rats that rule over New York City (NYC) by finding a correlation between the 311 rodent complaints, which are often used as markers for where the rats are located, and other factors. While much of the existing research focuses on identifying the factors that lead to rat infestations, our study instead examined whether 311 rodent complaints are an accurate proxy for rat prevalence. We investigated whether reliance on 311 data introduces bias.</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; **Specific Research Question: Does spatial aggregation cause 311 rodent calls to reflect reporting behavior rather than rat activity?**</span></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>My analysis addresses whether spatial aggregation causes rodent complaints to reflect reporting behavior rather than rat activity. In 2017, NYC began designating <span class="co">[</span><span class="ot">Rat Mitigation Zones</span><span class="co">](https://codelibrary.amlegal.com/codes/newyorkcity/latest/NYCrules/0-0-0-138869)</span>, with one criterion being the number of rat-related 311 complaints at the community district level. A difference-in-differences approach was used to compare 311 rodent complaints before and after a rodent inspection, with a passed inspection treated as the event at time zero. With inferring that a passed inspection signals acceptable rat conditions, we expect complaints to decline within the spatial unit after a passed inspection, provided the unit accurately captures rodent activity. This expectation was evaluated at three spatial scales: a local 150‑meter radius, Neighborhood Tabulation Areas (NTA) to maintain consistency with my groupmate’s analysis, and Community Districts to align with how NYC aggregates 311 rat complaints.</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>The technical details of the analysis, including data acquisition, data cleaning, exploratory data analysis, and model estimation, are documented in this report. Reproducible code and detailed explanations illustrating how difference-in-differences models were developed and evaluated using NYC data are also included. All analyses were conducted in R through associated packages.</span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="fu"># Methodology</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>The following methods were used to obtain and reconstruction four datasets to prepare for analysis.</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Acquisition</span></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a>Data was downloaded responsibly through functions that only download the required data if it does not already exist. Before this, the process starts by loading necessary packages through a helper function that installs and loads R packages used throughout this report. </span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="co">#' Install and load an R package if it is not already available.</span></span>
<span id="cb32-50"><a href="#cb32-50" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-51"><a href="#cb32-51" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param pkg A character string specifying the name of the package to load.</span></span>
<span id="cb32-52"><a href="#cb32-52" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return Invisibly returns TRUE if the package is successfully loaded.</span></span>
<span id="cb32-53"><a href="#cb32-53" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb32-54"><a href="#cb32-54" aria-hidden="true" tabindex="-1"></a><span class="co">#' load_package("tidyr")</span></span>
<span id="cb32-55"><a href="#cb32-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-56"><a href="#cb32-56" aria-hidden="true" tabindex="-1"></a>load_package <span class="ot">&lt;-</span> <span class="cf">function</span>(pkg) {</span>
<span id="cb32-57"><a href="#cb32-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(pkg, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb32-58"><a href="#cb32-58" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(pkg)</span>
<span id="cb32-59"><a href="#cb32-59" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-60"><a href="#cb32-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">suppressPackageStartupMessages</span>(<span class="fu">library</span>(pkg, <span class="at">character.only =</span> <span class="cn">TRUE</span>))</span>
<span id="cb32-61"><a href="#cb32-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-62"><a href="#cb32-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-63"><a href="#cb32-63" aria-hidden="true" tabindex="-1"></a>PACKAGES <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"httr2"</span>, <span class="st">"jsonlite"</span>, <span class="st">"dplyr"</span>, <span class="st">"sf"</span>, <span class="st">"purrr"</span>, <span class="st">"tidyr"</span>,</span>
<span id="cb32-64"><a href="#cb32-64" aria-hidden="true" tabindex="-1"></a>              <span class="st">"lubridate"</span>, <span class="st">"readr"</span>, <span class="st">"tidyverse"</span>, <span class="st">"nngeo"</span>, <span class="st">"ggplot2"</span>, <span class="st">"fixest"</span>, <span class="st">"nngeo"</span>, <span class="st">"scales"</span>,</span>
<span id="cb32-65"><a href="#cb32-65" aria-hidden="true" tabindex="-1"></a>              <span class="st">"knitr"</span>, <span class="st">"ggrepel"</span>, <span class="st">"kableExtra"</span>, <span class="st">"shiny"</span>, <span class="st">"leaflet"</span>, <span class="st">"data.table"</span>, <span class="st">"modelsummary"</span>)</span>
<span id="cb32-66"><a href="#cb32-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-67"><a href="#cb32-67" aria-hidden="true" tabindex="-1"></a><span class="fu">lapply</span>(PACKAGES, load_package)</span>
<span id="cb32-68"><a href="#cb32-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-69"><a href="#cb32-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-70"><a href="#cb32-70" aria-hidden="true" tabindex="-1"></a><span class="fu">### Rodent Inspections</span></span>
<span id="cb32-71"><a href="#cb32-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-72"><a href="#cb32-72" aria-hidden="true" tabindex="-1"></a>The NYC Rat Inspection dataset contains records of rodent inspections conducted across the five boroughs in response to public complaints and routine monitoring. This dataset is compiled and published by the New York City Department of Health and Mental Hygiene (DOHMH) and is publicly available through <span class="co">[</span><span class="ot">NYC Open Data</span><span class="co">](https://data.cityofnewyork.us/Health/Rodent-Inspection/p937-wjvj/about_data)</span>. The dataset contains approximately 2.9 million records, with a small number of inspections dated between 1918 and 1971 and two records from 2000, but these early outliers were removed. The majority of observations begin on January 1, 2001, and extend through December 8, 2025. Each record represents an individual inspection and includes information such as the inspection date, inspection outcome, and location details. Some records list inspection dates in 2045. These future-dated entries were identified as data errors and were removed. </span>
<span id="cb32-73"><a href="#cb32-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-76"><a href="#cb32-76" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-77"><a href="#cb32-77" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and cache NYC rat inspection records from NYC Open Data.</span></span>
<span id="cb32-78"><a href="#cb32-78" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-79"><a href="#cb32-79" aria-hidden="true" tabindex="-1"></a><span class="co">#' This chunk defines a helper function that retrieves rat inspection records from the</span></span>
<span id="cb32-80"><a href="#cb32-80" aria-hidden="true" tabindex="-1"></a><span class="co">#' NYC Open Data API and stores a local cached copy for reuse in future runs. Because</span></span>
<span id="cb32-81"><a href="#cb32-81" aria-hidden="true" tabindex="-1"></a><span class="co">#' the dataset can exceed single-request limits, the function downloads the data in</span></span>
<span id="cb32-82"><a href="#cb32-82" aria-hidden="true" tabindex="-1"></a><span class="co">#' paginated batches using `$limit` and `$offset`, combines the batches into a single</span></span>
<span id="cb32-83"><a href="#cb32-83" aria-hidden="true" tabindex="-1"></a><span class="co">#' table, and saves the result as a CSV in the project data directory. If a cached file</span></span>
<span id="cb32-84"><a href="#cb32-84" aria-hidden="true" tabindex="-1"></a><span class="co">#' already exists and `refresh = FALSE`, the function reads the local CSV instead of</span></span>
<span id="cb32-85"><a href="#cb32-85" aria-hidden="true" tabindex="-1"></a><span class="co">#' re-downloading the data.</span></span>
<span id="cb32-86"><a href="#cb32-86" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-87"><a href="#cb32-87" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A tibble containing the full set of rat inspection records returned by the</span></span>
<span id="cb32-88"><a href="#cb32-88" aria-hidden="true" tabindex="-1"></a><span class="co">#' NYC Open Data endpoint.</span></span>
<span id="cb32-89"><a href="#cb32-89" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb32-90"><a href="#cb32-90" aria-hidden="true" tabindex="-1"></a><span class="co">#' rat_inspection &lt;- load_rat_inspection()</span></span>
<span id="cb32-91"><a href="#cb32-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-92"><a href="#cb32-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure a local directory exists for storing cached API downloads.</span></span>
<span id="cb32-93"><a href="#cb32-93" aria-hidden="true" tabindex="-1"></a><span class="co"># Caching downloaded files allows the analysis to be rerun without</span></span>
<span id="cb32-94"><a href="#cb32-94" aria-hidden="true" tabindex="-1"></a><span class="co"># repeatedly querying the NYC Open Data API.</span></span>
<span id="cb32-95"><a href="#cb32-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-96"><a href="#cb32-96" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="st">"data/final"</span>)) {</span>
<span id="cb32-97"><a href="#cb32-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="st">"data/final"</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-98"><a href="#cb32-98" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-99"><a href="#cb32-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-100"><a href="#cb32-100" aria-hidden="true" tabindex="-1"></a>load_rat_inspection <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">refresh =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb32-101"><a href="#cb32-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-102"><a href="#cb32-102" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define a local cache path so the dataset can be reused across runs.</span></span>
<span id="cb32-103"><a href="#cb32-103" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Caching avoids repeated API calls and makes the workflow reproducible.</span></span>
<span id="cb32-104"><a href="#cb32-104" aria-hidden="true" tabindex="-1"></a>  target_dir <span class="ot">&lt;-</span> <span class="st">"data/final"</span></span>
<span id="cb32-105"><a href="#cb32-105" aria-hidden="true" tabindex="-1"></a>  f_name     <span class="ot">&lt;-</span> <span class="st">"rat_inspection.csv"</span></span>
<span id="cb32-106"><a href="#cb32-106" aria-hidden="true" tabindex="-1"></a>  file_path  <span class="ot">&lt;-</span> <span class="fu">file.path</span>(target_dir, f_name)</span>
<span id="cb32-107"><a href="#cb32-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-108"><a href="#cb32-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create the cache directory if it does not already exist.</span></span>
<span id="cb32-109"><a href="#cb32-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(target_dir)) {</span>
<span id="cb32-110"><a href="#cb32-110" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(target_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-111"><a href="#cb32-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-112"><a href="#cb32-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-113"><a href="#cb32-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># If no cached file is available, or if a refresh is requested, download the data.</span></span>
<span id="cb32-114"><a href="#cb32-114" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Otherwise, read the previously saved file from disk.</span></span>
<span id="cb32-115"><a href="#cb32-115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path) <span class="sc">||</span> refresh) {</span>
<span id="cb32-116"><a href="#cb32-116" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Downloading full rat inspection dataset from NYC Open Data..."</span>)</span>
<span id="cb32-117"><a href="#cb32-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-118"><a href="#cb32-118" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Specify the NYC Open Data endpoint used to retrieve the inspection records.</span></span>
<span id="cb32-119"><a href="#cb32-119" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/p937-wjvj.json"</span></span>
<span id="cb32-120"><a href="#cb32-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-121"><a href="#cb32-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The Socrata API limits the number of rows returned per request, so the full</span></span>
<span id="cb32-122"><a href="#cb32-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># dataset is retrieved in repeated chunks using limit and offset parameters.</span></span>
<span id="cb32-123"><a href="#cb32-123" aria-hidden="true" tabindex="-1"></a>    chunk_limit <span class="ot">&lt;-</span> <span class="dv">50000</span>L</span>
<span id="cb32-124"><a href="#cb32-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-125"><a href="#cb32-125" aria-hidden="true" tabindex="-1"></a>    all_chunks <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-126"><a href="#cb32-126" aria-hidden="true" tabindex="-1"></a>    offset     <span class="ot">&lt;-</span> <span class="dv">0</span>L</span>
<span id="cb32-127"><a href="#cb32-127" aria-hidden="true" tabindex="-1"></a>    chunk_id   <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb32-128"><a href="#cb32-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-129"><a href="#cb32-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">repeat</span> {</span>
<span id="cb32-130"><a href="#cb32-130" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Requesting rows with offset = "</span>, offset, <span class="st">" ..."</span>)</span>
<span id="cb32-131"><a href="#cb32-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-132"><a href="#cb32-132" aria-hidden="true" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> <span class="fu">request</span>(base_url) <span class="sc">|&gt;</span></span>
<span id="cb32-133"><a href="#cb32-133" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req_url_query</span>(</span>
<span id="cb32-134"><a href="#cb32-134" aria-hidden="true" tabindex="-1"></a>          <span class="st">"$limit"</span>  <span class="ot">=</span> chunk_limit,</span>
<span id="cb32-135"><a href="#cb32-135" aria-hidden="true" tabindex="-1"></a>          <span class="st">"$offset"</span> <span class="ot">=</span> offset</span>
<span id="cb32-136"><a href="#cb32-136" aria-hidden="true" tabindex="-1"></a>        ) <span class="sc">|&gt;</span></span>
<span id="cb32-137"><a href="#cb32-137" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req_perform</span>()</span>
<span id="cb32-138"><a href="#cb32-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-139"><a href="#cb32-139" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Stop execution if the API request fails.</span></span>
<span id="cb32-140"><a href="#cb32-140" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb32-141"><a href="#cb32-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-142"><a href="#cb32-142" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Parse the response into a tabular object that can be combined across chunks.</span></span>
<span id="cb32-143"><a href="#cb32-143" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Flattening is used to bring nested fields into regular columns when present.</span></span>
<span id="cb32-144"><a href="#cb32-144" aria-hidden="true" tabindex="-1"></a>      raw_json <span class="ot">&lt;-</span> <span class="fu">resp_body_string</span>(resp)</span>
<span id="cb32-145"><a href="#cb32-145" aria-hidden="true" tabindex="-1"></a>      dat_list <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(raw_json, <span class="at">flatten =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-146"><a href="#cb32-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-147"><a href="#cb32-147" aria-hidden="true" tabindex="-1"></a>      chunk_tbl <span class="ot">&lt;-</span> dat_list <span class="sc">|&gt;</span></span>
<span id="cb32-148"><a href="#cb32-148" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>()</span>
<span id="cb32-149"><a href="#cb32-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-150"><a href="#cb32-150" aria-hidden="true" tabindex="-1"></a>      n_chunk <span class="ot">&lt;-</span> <span class="fu">nrow</span>(chunk_tbl)</span>
<span id="cb32-151"><a href="#cb32-151" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Retrieved "</span>, n_chunk, <span class="st">" rows in chunk "</span>, chunk_id, <span class="st">"."</span>)</span>
<span id="cb32-152"><a href="#cb32-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-153"><a href="#cb32-153" aria-hidden="true" tabindex="-1"></a>      <span class="co"># A zero-row response indicates the end of the export.</span></span>
<span id="cb32-154"><a href="#cb32-154" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (n_chunk <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb32-155"><a href="#cb32-155" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"No more rows returned. Reached end of dataset."</span>)</span>
<span id="cb32-156"><a href="#cb32-156" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb32-157"><a href="#cb32-157" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb32-158"><a href="#cb32-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-159"><a href="#cb32-159" aria-hidden="true" tabindex="-1"></a>      all_chunks[[chunk_id]] <span class="ot">&lt;-</span> chunk_tbl</span>
<span id="cb32-160"><a href="#cb32-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-161"><a href="#cb32-161" aria-hidden="true" tabindex="-1"></a>      <span class="co"># If the chunk is smaller than the request limit, assume this is the final page.</span></span>
<span id="cb32-162"><a href="#cb32-162" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (n_chunk <span class="sc">&lt;</span> chunk_limit) {</span>
<span id="cb32-163"><a href="#cb32-163" aria-hidden="true" tabindex="-1"></a>        <span class="fu">message</span>(<span class="st">"Final chunk returned fewer than "</span>, chunk_limit, <span class="st">" rows."</span>)</span>
<span id="cb32-164"><a href="#cb32-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span>
<span id="cb32-165"><a href="#cb32-165" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb32-166"><a href="#cb32-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-167"><a href="#cb32-167" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Otherwise, advance the offset and request the next batch.</span></span>
<span id="cb32-168"><a href="#cb32-168" aria-hidden="true" tabindex="-1"></a>      offset   <span class="ot">&lt;-</span> offset <span class="sc">+</span> n_chunk</span>
<span id="cb32-169"><a href="#cb32-169" aria-hidden="true" tabindex="-1"></a>      chunk_id <span class="ot">&lt;-</span> chunk_id <span class="sc">+</span> <span class="dv">1</span>L</span>
<span id="cb32-170"><a href="#cb32-170" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-171"><a href="#cb32-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-172"><a href="#cb32-172" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Combine all retrieved chunks into a single table.</span></span>
<span id="cb32-173"><a href="#cb32-173" aria-hidden="true" tabindex="-1"></a>    rat_inspection <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(all_chunks)</span>
<span id="cb32-174"><a href="#cb32-174" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Total rows downloaded: "</span>, <span class="fu">nrow</span>(rat_inspection))</span>
<span id="cb32-175"><a href="#cb32-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-176"><a href="#cb32-176" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Save the assembled dataset so it can load it from disk.</span></span>
<span id="cb32-177"><a href="#cb32-177" aria-hidden="true" tabindex="-1"></a>    <span class="fu">write_csv</span>(rat_inspection, file_path)</span>
<span id="cb32-178"><a href="#cb32-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-179"><a href="#cb32-179" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb32-180"><a href="#cb32-180" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Reading existing rat inspection data from CSV..."</span>)</span>
<span id="cb32-181"><a href="#cb32-181" aria-hidden="true" tabindex="-1"></a>    rat_inspection <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(file_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb32-182"><a href="#cb32-182" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-183"><a href="#cb32-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-184"><a href="#cb32-184" aria-hidden="true" tabindex="-1"></a>  rat_inspection</span>
<span id="cb32-185"><a href="#cb32-185" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-186"><a href="#cb32-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-187"><a href="#cb32-187" aria-hidden="true" tabindex="-1"></a>rat_inspection <span class="ot">&lt;-</span> <span class="fu">load_rat_inspection</span>()</span>
<span id="cb32-188"><a href="#cb32-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-189"><a href="#cb32-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter out inspection records with implausible dates that likely reflect data issues.</span></span>
<span id="cb32-190"><a href="#cb32-190" aria-hidden="true" tabindex="-1"></a><span class="co"># This removes a small number of records dated 1918–1971, the two records from 2000,</span></span>
<span id="cb32-191"><a href="#cb32-191" aria-hidden="true" tabindex="-1"></a><span class="co"># and outliers dated in 2045.</span></span>
<span id="cb32-192"><a href="#cb32-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-193"><a href="#cb32-193" aria-hidden="true" tabindex="-1"></a>rat_inspection <span class="ot">&lt;-</span> rat_inspection <span class="sc">|&gt;</span></span>
<span id="cb32-194"><a href="#cb32-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">inspection_date =</span> <span class="fu">as_date</span>(inspection_date)) <span class="sc">|&gt;</span></span>
<span id="cb32-195"><a href="#cb32-195" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(inspection_date)) <span class="sc">|&gt;</span></span>
<span id="cb32-196"><a href="#cb32-196" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(inspection_date) <span class="sc">&gt;=</span> <span class="dv">1972</span>,</span>
<span id="cb32-197"><a href="#cb32-197" aria-hidden="true" tabindex="-1"></a>         <span class="fu">year</span>(inspection_date) <span class="sc">&lt;=</span> <span class="dv">2024</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-198"><a href="#cb32-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">year</span>(inspection_date) <span class="sc">!=</span> <span class="dv">2000</span>)</span>
<span id="cb32-199"><a href="#cb32-199" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-200"><a href="#cb32-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-201"><a href="#cb32-201" aria-hidden="true" tabindex="-1"></a><span class="fu">### 311 Rodent Complaints</span></span>
<span id="cb32-202"><a href="#cb32-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-203"><a href="#cb32-203" aria-hidden="true" tabindex="-1"></a>The New York City 311 Rodent Complaints data set contains records of non-emergency service requests submitted by residents reporting rodent sightings and related issues. This data set is compiled and made publicly available through the NYC Open Data portal and includes complaints submitted to the <span class="co">[</span><span class="ot">NYC 311 service system</span><span class="co">](https://data.cityofnewyork.us/Social-Services/311-Rodent-Complaints/cvf2-zn8s/about_data)</span>. The data set contains approximately 492,000 records and spans from January 2010 through December 2025. Each record represents an individual complaint and includes information such as the date the complaint was submitted, complaint type, location details, and additional service request attributes. The 311 Rodent Complaints data set provides a comprehensive view of public reporting of rodent activity across New York City and is particularly valuable for researchers and urban planners studying urban wildlife interactions, public health concerns, and neighborhood-level patterns in rodent reporting behavior.</span>
<span id="cb32-204"><a href="#cb32-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-207"><a href="#cb32-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-208"><a href="#cb32-208" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and assemble NYC 311 rodent complaint records from NYC Open Data.</span></span>
<span id="cb32-209"><a href="#cb32-209" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-210"><a href="#cb32-210" aria-hidden="true" tabindex="-1"></a><span class="co">#' This chunk prepares a local data directory and defines a helper function that</span></span>
<span id="cb32-211"><a href="#cb32-211" aria-hidden="true" tabindex="-1"></a><span class="co">#' retrieves NYC 311 rodent complaint data from the NYC Open Data API. Because the</span></span>
<span id="cb32-212"><a href="#cb32-212" aria-hidden="true" tabindex="-1"></a><span class="co">#' dataset can exceed single-request limits, the function downloads the data in</span></span>
<span id="cb32-213"><a href="#cb32-213" aria-hidden="true" tabindex="-1"></a><span class="co">#' paginated batches using `$limit` and `$offset`. Each batch is cached locally as</span></span>
<span id="cb32-214"><a href="#cb32-214" aria-hidden="true" tabindex="-1"></a><span class="co">#' a GeoJSON file to avoid repeated downloads and to make the workflow reproducible.</span></span>
<span id="cb32-215"><a href="#cb32-215" aria-hidden="true" tabindex="-1"></a><span class="co">#' The cached batches are then read with `st_read()` and combined into a single dataset.</span></span>
<span id="cb32-216"><a href="#cb32-216" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-217"><a href="#cb32-217" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An `sf` object containing the full set of rodent complaint records returned</span></span>
<span id="cb32-218"><a href="#cb32-218" aria-hidden="true" tabindex="-1"></a><span class="co">#' by the NYC Open Data endpoint.</span></span>
<span id="cb32-219"><a href="#cb32-219" aria-hidden="true" tabindex="-1"></a><span class="co">#' @examples</span></span>
<span id="cb32-220"><a href="#cb32-220" aria-hidden="true" tabindex="-1"></a><span class="co">#' rodent_complaints &lt;- get_rodent_complaints()</span></span>
<span id="cb32-221"><a href="#cb32-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-222"><a href="#cb32-222" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a helper function to download and assemble NYC 311 rodent complaint data.</span></span>
<span id="cb32-223"><a href="#cb32-223" aria-hidden="true" tabindex="-1"></a><span class="co"># The function retrieves the data in batches to accommodate API request limits,</span></span>
<span id="cb32-224"><a href="#cb32-224" aria-hidden="true" tabindex="-1"></a><span class="co"># caches each batch locally as a GeoJSON file, and combines all batches into</span></span>
<span id="cb32-225"><a href="#cb32-225" aria-hidden="true" tabindex="-1"></a><span class="co"># a single sf object for downstream analysis.</span></span>
<span id="cb32-226"><a href="#cb32-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-227"><a href="#cb32-227" aria-hidden="true" tabindex="-1"></a>get_rodent_complaints <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb32-228"><a href="#cb32-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-229"><a href="#cb32-229" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Define the NYC Open Data API endpoint for 311 rodent complaints.</span></span>
<span id="cb32-230"><a href="#cb32-230" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The data are served as GeoJSON and must be retrieved in multiple requests.</span></span>
<span id="cb32-231"><a href="#cb32-231" aria-hidden="true" tabindex="-1"></a>  ENDPOINT <span class="ot">&lt;-</span> <span class="st">"https://data.cityofnewyork.us/resource/cvf2-zn8s.geojson"</span></span>
<span id="cb32-232"><a href="#cb32-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-233"><a href="#cb32-233" aria-hidden="true" tabindex="-1"></a>  BATCH_SIZE    <span class="ot">&lt;-</span> <span class="dv">50000</span></span>
<span id="cb32-234"><a href="#cb32-234" aria-hidden="true" tabindex="-1"></a>  OFFSET        <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb32-235"><a href="#cb32-235" aria-hidden="true" tabindex="-1"></a>  END_OF_EXPORT <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb32-236"><a href="#cb32-236" aria-hidden="true" tabindex="-1"></a>  FILE_INDEX    <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb32-237"><a href="#cb32-237" aria-hidden="true" tabindex="-1"></a>  ALL_DATA      <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb32-238"><a href="#cb32-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-239"><a href="#cb32-239" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Continue requesting data until the API returns fewer rows than the batch size,</span></span>
<span id="cb32-240"><a href="#cb32-240" aria-hidden="true" tabindex="-1"></a>  <span class="co"># which signals that the end of the dataset has been reached.</span></span>
<span id="cb32-241"><a href="#cb32-241" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> (<span class="sc">!</span>END_OF_EXPORT) {</span>
<span id="cb32-242"><a href="#cb32-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-243"><a href="#cb32-243" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct a stable filename for the current batch so that it can be reused</span></span>
<span id="cb32-244"><a href="#cb32-244" aria-hidden="true" tabindex="-1"></a>    <span class="co"># across multiple runs of the analysis.</span></span>
<span id="cb32-245"><a href="#cb32-245" aria-hidden="true" tabindex="-1"></a>    file_name <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"rodent_311_%04d.geojson"</span>, FILE_INDEX)</span>
<span id="cb32-246"><a href="#cb32-246" aria-hidden="true" tabindex="-1"></a>    file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="st">"data/final"</span>, file_name)</span>
<span id="cb32-247"><a href="#cb32-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-248"><a href="#cb32-248" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Download the current batch only if it has not already been saved locally.</span></span>
<span id="cb32-249"><a href="#cb32-249" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This avoids unnecessary API calls and improves reproducibility.</span></span>
<span id="cb32-250"><a href="#cb32-250" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(file_path)) {</span>
<span id="cb32-251"><a href="#cb32-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-252"><a href="#cb32-252" aria-hidden="true" tabindex="-1"></a>      req <span class="ot">&lt;-</span> <span class="fu">request</span>(ENDPOINT) <span class="sc">|&gt;</span></span>
<span id="cb32-253"><a href="#cb32-253" aria-hidden="true" tabindex="-1"></a>        <span class="fu">req_url_query</span>(</span>
<span id="cb32-254"><a href="#cb32-254" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">$limit</span><span class="st">`</span>  <span class="ot">=</span> BATCH_SIZE,</span>
<span id="cb32-255"><a href="#cb32-255" aria-hidden="true" tabindex="-1"></a>          <span class="st">`</span><span class="at">$offset</span><span class="st">`</span> <span class="ot">=</span> OFFSET</span>
<span id="cb32-256"><a href="#cb32-256" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb32-257"><a href="#cb32-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-258"><a href="#cb32-258" aria-hidden="true" tabindex="-1"></a>      resp <span class="ot">&lt;-</span> <span class="fu">req_perform</span>(req)</span>
<span id="cb32-259"><a href="#cb32-259" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb32-260"><a href="#cb32-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-261"><a href="#cb32-261" aria-hidden="true" tabindex="-1"></a>      <span class="fu">resp_body_raw</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb32-262"><a href="#cb32-262" aria-hidden="true" tabindex="-1"></a>        <span class="fu">writeBin</span>(<span class="at">con =</span> file_path)</span>
<span id="cb32-263"><a href="#cb32-263" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-264"><a href="#cb32-264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-265"><a href="#cb32-265" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the cached GeoJSON batch into an sf object.</span></span>
<span id="cb32-266"><a href="#cb32-266" aria-hidden="true" tabindex="-1"></a>    batch_data <span class="ot">&lt;-</span> <span class="fu">st_read</span>(file_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-267"><a href="#cb32-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-268"><a href="#cb32-268" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Append the current batch to the list of all downloaded data.</span></span>
<span id="cb32-269"><a href="#cb32-269" aria-hidden="true" tabindex="-1"></a>    ALL_DATA <span class="ot">&lt;-</span> <span class="fu">c</span>(ALL_DATA, <span class="fu">list</span>(batch_data))</span>
<span id="cb32-270"><a href="#cb32-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-271"><a href="#cb32-271" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the number of returned rows is smaller than the requested batch size,</span></span>
<span id="cb32-272"><a href="#cb32-272" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the final page has been reached and the loop can terminate.</span></span>
<span id="cb32-273"><a href="#cb32-273" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">NROW</span>(batch_data) <span class="sc">!=</span> BATCH_SIZE) {</span>
<span id="cb32-274"><a href="#cb32-274" aria-hidden="true" tabindex="-1"></a>      END_OF_EXPORT <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb32-275"><a href="#cb32-275" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb32-276"><a href="#cb32-276" aria-hidden="true" tabindex="-1"></a>      OFFSET     <span class="ot">&lt;-</span> OFFSET <span class="sc">+</span> BATCH_SIZE</span>
<span id="cb32-277"><a href="#cb32-277" aria-hidden="true" tabindex="-1"></a>      FILE_INDEX <span class="ot">&lt;-</span> FILE_INDEX <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb32-278"><a href="#cb32-278" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb32-279"><a href="#cb32-279" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-280"><a href="#cb32-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-281"><a href="#cb32-281" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Combine all downloaded batches into a single sf object.</span></span>
<span id="cb32-282"><a href="#cb32-282" aria-hidden="true" tabindex="-1"></a>  ALL_DATA <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(ALL_DATA)</span>
<span id="cb32-283"><a href="#cb32-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-284"><a href="#cb32-284" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(ALL_DATA)</span>
<span id="cb32-285"><a href="#cb32-285" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-286"><a href="#cb32-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-287"><a href="#cb32-287" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute the data download and combination step and store the result.</span></span>
<span id="cb32-288"><a href="#cb32-288" aria-hidden="true" tabindex="-1"></a>rodent_complaints <span class="ot">&lt;-</span> <span class="fu">get_rodent_complaints</span>()</span>
<span id="cb32-289"><a href="#cb32-289" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-290"><a href="#cb32-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-291"><a href="#cb32-291" aria-hidden="true" tabindex="-1"></a><span class="fu">### Neighborhood Tabulation Areas (NTA)</span></span>
<span id="cb32-292"><a href="#cb32-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-293"><a href="#cb32-293" aria-hidden="true" tabindex="-1"></a>The 2020 <span class="co">[</span><span class="ot">New York City Neighborhood Tabulation Area</span><span class="co">](https://www.nyc.gov/content/planning/pages/resources/datasets/neighborhood-tabulation)</span> (NTA) boundary polygons were downloaded from an ArcGIS REST service provided by the City of New York. These polygons define standardized neighborhood units commonly used for demographic and public health analyses. The boundary file was cached locally to ensure reproducibility and loaded as a spatial object, then transformed to the EPSG:4326 coordinate reference system to align with the rodent inspection and 311 complaint data. A lookup table mapping NTA names to their official NTA codes was also created to facilitate consistent joins across datasets.</span>
<span id="cb32-294"><a href="#cb32-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-297"><a href="#cb32-297" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-298"><a href="#cb32-298" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and load NYC Neighborhood Tabulation Area (NTA) boundary polygons.</span></span>
<span id="cb32-299"><a href="#cb32-299" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-300"><a href="#cb32-300" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads the 2020 Neighborhood Tabulation Area boundary polygons from an</span></span>
<span id="cb32-301"><a href="#cb32-301" aria-hidden="true" tabindex="-1"></a><span class="co">#' ArcGIS REST endpoint and caches the GeoJSON locally for reuse. If the file already exists</span></span>
<span id="cb32-302"><a href="#cb32-302" aria-hidden="true" tabindex="-1"></a><span class="co">#' locally, it is read from disk instead of being downloaded again.</span></span>
<span id="cb32-303"><a href="#cb32-303" aria-hidden="true" tabindex="-1"></a><span class="co">#' The boundaries are loaded as an `sf` object and transformed to EPSG:4326 to align with</span></span>
<span id="cb32-304"><a href="#cb32-304" aria-hidden="true" tabindex="-1"></a><span class="co">#' the coordinate reference system used by the rodent datasets.</span></span>
<span id="cb32-305"><a href="#cb32-305" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-306"><a href="#cb32-306" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nta_url URL of the ArcGIS GeoJSON endpoint (default provided).</span></span>
<span id="cb32-307"><a href="#cb32-307" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param nta_path Local filepath used to cache the downloaded GeoJSON.</span></span>
<span id="cb32-308"><a href="#cb32-308" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An `sf` object containing NYC Neighborhood Tabulation Area polygon geometries</span></span>
<span id="cb32-309"><a href="#cb32-309" aria-hidden="true" tabindex="-1"></a><span class="co">#'   and associated attributes.</span></span>
<span id="cb32-310"><a href="#cb32-310" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom httr2 request req_perform resp_check_status resp_body_raw</span></span>
<span id="cb32-311"><a href="#cb32-311" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom sf st_read st_transform</span></span>
<span id="cb32-312"><a href="#cb32-312" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb32-313"><a href="#cb32-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-314"><a href="#cb32-314" aria-hidden="true" tabindex="-1"></a>load_nta_boundaries <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb32-315"><a href="#cb32-315" aria-hidden="true" tabindex="-1"></a>  <span class="at">nta_url  =</span> <span class="st">"https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_Neighborhood_Tabulation_Areas_2020/FeatureServer/0/query?where=1=1&amp;outFields=*&amp;outSR=4326&amp;f=pgeojson"</span>,</span>
<span id="cb32-316"><a href="#cb32-316" aria-hidden="true" tabindex="-1"></a>  <span class="at">nta_path =</span> <span class="st">"data/final/nta_2020.geojson"</span>,</span>
<span id="cb32-317"><a href="#cb32-317" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh  =</span> <span class="cn">FALSE</span></span>
<span id="cb32-318"><a href="#cb32-318" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb32-319"><a href="#cb32-319" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure the output directory exists before attempting to write cached files.</span></span>
<span id="cb32-320"><a href="#cb32-320" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(nta_path)</span>
<span id="cb32-321"><a href="#cb32-321" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)) {</span>
<span id="cb32-322"><a href="#cb32-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-323"><a href="#cb32-323" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-324"><a href="#cb32-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-325"><a href="#cb32-325" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download the file only if it is not already cached locally.</span></span>
<span id="cb32-326"><a href="#cb32-326" aria-hidden="true" tabindex="-1"></a>  <span class="co"># This keeps the workflow reproducible and avoids repeated requests to the server.</span></span>
<span id="cb32-327"><a href="#cb32-327" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(nta_path)) {</span>
<span id="cb32-328"><a href="#cb32-328" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">request</span>(nta_url) <span class="sc">|&gt;</span></span>
<span id="cb32-329"><a href="#cb32-329" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_perform</span>()</span>
<span id="cb32-330"><a href="#cb32-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-331"><a href="#cb32-331" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb32-332"><a href="#cb32-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-333"><a href="#cb32-333" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_body_raw</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb32-334"><a href="#cb32-334" aria-hidden="true" tabindex="-1"></a>      <span class="fu">writeBin</span>(<span class="at">con =</span> nta_path)</span>
<span id="cb32-335"><a href="#cb32-335" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-336"><a href="#cb32-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-337"><a href="#cb32-337" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the cached NTA boundaries as an sf object and standardize the CRS.</span></span>
<span id="cb32-338"><a href="#cb32-338" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Using a consistent CRS ensures spatial joins and distance calculations work as expected.</span></span>
<span id="cb32-339"><a href="#cb32-339" aria-hidden="true" tabindex="-1"></a>  nta <span class="ot">&lt;-</span> <span class="fu">st_read</span>(nta_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-340"><a href="#cb32-340" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb32-341"><a href="#cb32-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-342"><a href="#cb32-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(nta)</span>
<span id="cb32-343"><a href="#cb32-343" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-344"><a href="#cb32-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-345"><a href="#cb32-345" aria-hidden="true" tabindex="-1"></a>nta <span class="ot">&lt;-</span> <span class="fu">load_nta_boundaries</span>()</span>
<span id="cb32-346"><a href="#cb32-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-347"><a href="#cb32-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-348"><a href="#cb32-348" aria-hidden="true" tabindex="-1"></a><span class="fu">### Community Districts</span></span>
<span id="cb32-349"><a href="#cb32-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-350"><a href="#cb32-350" aria-hidden="true" tabindex="-1"></a>The New York City <span class="co">[</span><span class="ot">Community District</span><span class="co">](https://www.nyc.gov/content/planning/pages/resources/datasets/community-districts)</span> boundary polygons were downloaded from the NYC Department of City Planning’s dataset, using an ArcGIS REST endpoint that provides the boundaries in GeoJSON format. The boundary file was cached locally to support reproducible analyses and to avoid repeated requests to the hosting server. The polygons were then loaded as an sf object and transformed to EPSG:4326 to ensure compatibility with the coordinate reference system used by the rodent inspection and 311 complaint datasets. For spatial joins, the Community District identifier was retained along with the district geometries.</span>
<span id="cb32-351"><a href="#cb32-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-354"><a href="#cb32-354" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-355"><a href="#cb32-355" aria-hidden="true" tabindex="-1"></a><span class="co">#' Download and load NYC Community District boundary polygons.</span></span>
<span id="cb32-356"><a href="#cb32-356" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-357"><a href="#cb32-357" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function downloads NYC Department of City Planning Community District boundaries</span></span>
<span id="cb32-358"><a href="#cb32-358" aria-hidden="true" tabindex="-1"></a><span class="co">#' from an ArcGIS REST endpoint and caches the GeoJSON locally for reuse. If the file</span></span>
<span id="cb32-359"><a href="#cb32-359" aria-hidden="true" tabindex="-1"></a><span class="co">#' already exists locally, it is read from disk instead of being downloaded again. </span></span>
<span id="cb32-360"><a href="#cb32-360" aria-hidden="true" tabindex="-1"></a><span class="co">#' The boundaries are loaded as an `sf` object and transformed to to ensure compatibility</span></span>
<span id="cb32-361"><a href="#cb32-361" aria-hidden="true" tabindex="-1"></a><span class="co">#' with other datasets used in the analysis.</span></span>
<span id="cb32-362"><a href="#cb32-362" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-363"><a href="#cb32-363" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cd_url URL of the ArcGIS GeoJSON endpoint (default provided).</span></span>
<span id="cb32-364"><a href="#cb32-364" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param cd_path Local filepath used to cache the downloaded GeoJSON</span></span>
<span id="cb32-365"><a href="#cb32-365" aria-hidden="true" tabindex="-1"></a><span class="co">#'   (default "data/final/community_districts.geojson").</span></span>
<span id="cb32-366"><a href="#cb32-366" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return An `sf` object containing Community District polygons. The returned object</span></span>
<span id="cb32-367"><a href="#cb32-367" aria-hidden="true" tabindex="-1"></a><span class="co">#'   includes the Community District identifier (`BoroCD`) and geometry.</span></span>
<span id="cb32-368"><a href="#cb32-368" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom httr2 request req_perform resp_check_status resp_body_raw</span></span>
<span id="cb32-369"><a href="#cb32-369" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom sf st_read st_transform</span></span>
<span id="cb32-370"><a href="#cb32-370" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr select</span></span>
<span id="cb32-371"><a href="#cb32-371" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb32-372"><a href="#cb32-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-373"><a href="#cb32-373" aria-hidden="true" tabindex="-1"></a>load_cd_shapefiles <span class="ot">&lt;-</span> <span class="cf">function</span>(</span>
<span id="cb32-374"><a href="#cb32-374" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd_url  =</span> <span class="st">"https://services5.arcgis.com/GfwWNkhOj9bNBqoJ/arcgis/rest/services/NYC_Community_Districts/FeatureServer/0/query?where=1=1&amp;outFields=*&amp;outSR=4326&amp;f=pgeojson"</span>,</span>
<span id="cb32-375"><a href="#cb32-375" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd_path =</span> <span class="st">"data/final/community_districts.geojson"</span>,</span>
<span id="cb32-376"><a href="#cb32-376" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="cn">FALSE</span></span>
<span id="cb32-377"><a href="#cb32-377" aria-hidden="true" tabindex="-1"></a>) {</span>
<span id="cb32-378"><a href="#cb32-378" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Ensure the output directory exists before attempting to write cached files.</span></span>
<span id="cb32-379"><a href="#cb32-379" aria-hidden="true" tabindex="-1"></a>  out_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(cd_path)</span>
<span id="cb32-380"><a href="#cb32-380" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(out_dir)) {</span>
<span id="cb32-381"><a href="#cb32-381" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-382"><a href="#cb32-382" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-383"><a href="#cb32-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-384"><a href="#cb32-384" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download the GeoJSON only when needed to minimize repeated server requests.</span></span>
<span id="cb32-385"><a href="#cb32-385" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (refresh <span class="sc">||</span> <span class="sc">!</span><span class="fu">file.exists</span>(cd_path)) {</span>
<span id="cb32-386"><a href="#cb32-386" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">request</span>(cd_url) <span class="sc">|&gt;</span></span>
<span id="cb32-387"><a href="#cb32-387" aria-hidden="true" tabindex="-1"></a>      <span class="fu">req_perform</span>()</span>
<span id="cb32-388"><a href="#cb32-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-389"><a href="#cb32-389" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_check_status</span>(resp)</span>
<span id="cb32-390"><a href="#cb32-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-391"><a href="#cb32-391" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resp_body_raw</span>(resp) <span class="sc">|&gt;</span></span>
<span id="cb32-392"><a href="#cb32-392" aria-hidden="true" tabindex="-1"></a>      <span class="fu">writeBin</span>(<span class="at">con =</span> cd_path)</span>
<span id="cb32-393"><a href="#cb32-393" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb32-394"><a href="#cb32-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-395"><a href="#cb32-395" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the cached GeoJSON and standardize to EPSG:4326 for spatial compatibility.</span></span>
<span id="cb32-396"><a href="#cb32-396" aria-hidden="true" tabindex="-1"></a>  cd <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cd_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-397"><a href="#cb32-397" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb32-398"><a href="#cb32-398" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-399"><a href="#cb32-399" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Keep only the Community District identifier and geometry used for joins.</span></span>
<span id="cb32-400"><a href="#cb32-400" aria-hidden="true" tabindex="-1"></a>  cd <span class="ot">&lt;-</span> cd <span class="sc">|&gt;</span></span>
<span id="cb32-401"><a href="#cb32-401" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(BoroCD, geometry)</span>
<span id="cb32-402"><a href="#cb32-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-403"><a href="#cb32-403" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(cd)</span>
<span id="cb32-404"><a href="#cb32-404" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-405"><a href="#cb32-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-406"><a href="#cb32-406" aria-hidden="true" tabindex="-1"></a>cd_keep <span class="ot">&lt;-</span> <span class="fu">load_cd_shapefiles</span>()</span>
<span id="cb32-407"><a href="#cb32-407" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-408"><a href="#cb32-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-409"><a href="#cb32-409" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Integration</span></span>
<span id="cb32-410"><a href="#cb32-410" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-411"><a href="#cb32-411" aria-hidden="true" tabindex="-1"></a>Since the rodent inspection and 311 complaint data are recorded at the point level using latitude and longitude coordinates, I standardized the geographic unit of analysis across the 311 rodent complaint and rodent inspection datasets. Point locations were converted to spatial features and spatially joined to 2020 NTA boundary polygons using a point-in-polygon approach, assigning each record to an NTA. </span>
<span id="cb32-412"><a href="#cb32-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-415"><a href="#cb32-415" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-416"><a href="#cb32-416" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert rodent complaint coordinates into sf point features.</span></span>
<span id="cb32-417"><a href="#cb32-417" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-418"><a href="#cb32-418" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract longitude and latitude as numeric values and remove records without valid coordinates.</span></span>
<span id="cb32-419"><a href="#cb32-419" aria-hidden="true" tabindex="-1"></a>rat_coords <span class="ot">&lt;-</span> rodent_complaints <span class="sc">|&gt;</span></span>
<span id="cb32-420"><a href="#cb32-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-421"><a href="#cb32-421" aria-hidden="true" tabindex="-1"></a>    <span class="at">lon =</span> <span class="fu">as.numeric</span>(longitude),</span>
<span id="cb32-422"><a href="#cb32-422" aria-hidden="true" tabindex="-1"></a>    <span class="at">lat =</span> <span class="fu">as.numeric</span>(latitude)</span>
<span id="cb32-423"><a href="#cb32-423" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-424"><a href="#cb32-424" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(lon, lat)</span>
<span id="cb32-425"><a href="#cb32-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-426"><a href="#cb32-426" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the complaint records into an sf object so spatial operations can be applied.</span></span>
<span id="cb32-427"><a href="#cb32-427" aria-hidden="true" tabindex="-1"></a>rats_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb32-428"><a href="#cb32-428" aria-hidden="true" tabindex="-1"></a>  rat_coords,</span>
<span id="cb32-429"><a href="#cb32-429" aria-hidden="true" tabindex="-1"></a>  <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>),</span>
<span id="cb32-430"><a href="#cb32-430" aria-hidden="true" tabindex="-1"></a>  <span class="at">crs =</span> <span class="dv">4326</span></span>
<span id="cb32-431"><a href="#cb32-431" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-432"><a href="#cb32-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-433"><a href="#cb32-433" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the NTA polygon boundaries and make sure they are in the same CRS as the complaint points.</span></span>
<span id="cb32-434"><a href="#cb32-434" aria-hidden="true" tabindex="-1"></a>nta <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">"data/final/nta_2020.geojson"</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-435"><a href="#cb32-435" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb32-436"><a href="#cb32-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-437"><a href="#cb32-437" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a lookup table mapping NTA names to official NTA codes for later joins.</span></span>
<span id="cb32-438"><a href="#cb32-438" aria-hidden="true" tabindex="-1"></a>nta_lookup <span class="ot">&lt;-</span> nta <span class="sc">|&gt;</span></span>
<span id="cb32-439"><a href="#cb32-439" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb32-440"><a href="#cb32-440" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb32-441"><a href="#cb32-441" aria-hidden="true" tabindex="-1"></a>    <span class="at">nta =</span> NTAName,       </span>
<span id="cb32-442"><a href="#cb32-442" aria-hidden="true" tabindex="-1"></a>    <span class="at">nta_code =</span> NTA2020</span>
<span id="cb32-443"><a href="#cb32-443" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-444"><a href="#cb32-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb32-445"><a href="#cb32-445" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-446"><a href="#cb32-446" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join NTA attributes onto each complaint point.</span></span>
<span id="cb32-447"><a href="#cb32-447" aria-hidden="true" tabindex="-1"></a>rat311_with_nta <span class="ot">&lt;-</span> <span class="fu">st_join</span>(</span>
<span id="cb32-448"><a href="#cb32-448" aria-hidden="true" tabindex="-1"></a>  rats_sf,</span>
<span id="cb32-449"><a href="#cb32-449" aria-hidden="true" tabindex="-1"></a>  nta[, <span class="fu">c</span>(<span class="st">"NTA2020"</span>, <span class="st">"NTAName"</span>, <span class="st">"BoroName"</span>)]</span>
<span id="cb32-450"><a href="#cb32-450" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-451"><a href="#cb32-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-452"><a href="#cb32-452" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop geometry to work with a regular tabular data frame while keeping the NTA attributes.</span></span>
<span id="cb32-453"><a href="#cb32-453" aria-hidden="true" tabindex="-1"></a>rat311_with_nta_df <span class="ot">&lt;-</span> rat311_with_nta <span class="sc">|&gt;</span></span>
<span id="cb32-454"><a href="#cb32-454" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb32-455"><a href="#cb32-455" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-456"><a href="#cb32-456" aria-hidden="true" tabindex="-1"></a>Community district polygons were then joined in a similar way.</span>
<span id="cb32-457"><a href="#cb32-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-460"><a href="#cb32-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-461"><a href="#cb32-461" aria-hidden="true" tabindex="-1"></a><span class="co"># Spatial join: assign each 311 rat point to a Community District (BoroCD)</span></span>
<span id="cb32-462"><a href="#cb32-462" aria-hidden="true" tabindex="-1"></a>rat311_with_cd <span class="ot">&lt;-</span> <span class="fu">st_join</span>(rats_sf, cd_keep)</span>
<span id="cb32-463"><a href="#cb32-463" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-464"><a href="#cb32-464" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop geometry for a regular tibble</span></span>
<span id="cb32-465"><a href="#cb32-465" aria-hidden="true" tabindex="-1"></a>rat311_with_cd_df <span class="ot">&lt;-</span> rat311_with_cd <span class="sc">|&gt;</span></span>
<span id="cb32-466"><a href="#cb32-466" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb32-467"><a href="#cb32-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-468"><a href="#cb32-468" aria-hidden="true" tabindex="-1"></a><span class="co"># Drop geometry for a regular tabular data frame</span></span>
<span id="cb32-469"><a href="#cb32-469" aria-hidden="true" tabindex="-1"></a>rat311_with_cd_df <span class="ot">&lt;-</span> rat311_with_cd <span class="sc">|&gt;</span></span>
<span id="cb32-470"><a href="#cb32-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>()</span>
<span id="cb32-471"><a href="#cb32-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-472"><a href="#cb32-472" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Community District (BoroCD) to any NYC dataset with lon/lat columns</span></span>
<span id="cb32-473"><a href="#cb32-473" aria-hidden="true" tabindex="-1"></a><span class="co"># Keeps pipeline modular: load raw data first, enrich later, without modifying originals.</span></span>
<span id="cb32-474"><a href="#cb32-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-475"><a href="#cb32-475" aria-hidden="true" tabindex="-1"></a>add_cd_to_points <span class="ot">&lt;-</span> <span class="cf">function</span>(df,</span>
<span id="cb32-476"><a href="#cb32-476" aria-hidden="true" tabindex="-1"></a>                             <span class="at">lon_col =</span> <span class="st">"longitude"</span>,</span>
<span id="cb32-477"><a href="#cb32-477" aria-hidden="true" tabindex="-1"></a>                             <span class="at">lat_col =</span> <span class="st">"latitude"</span>,</span>
<span id="cb32-478"><a href="#cb32-478" aria-hidden="true" tabindex="-1"></a>                             <span class="at">cd_path =</span> <span class="st">"data/final/community_districts.geojson"</span>) {</span>
<span id="cb32-479"><a href="#cb32-479" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read/prepare Community District polygons (lightweight)</span></span>
<span id="cb32-480"><a href="#cb32-480" aria-hidden="true" tabindex="-1"></a>  cd_keep <span class="ot">&lt;-</span> <span class="fu">st_read</span>(cd_path, <span class="at">quiet =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-481"><a href="#cb32-481" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_transform</span>(<span class="dv">4326</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-482"><a href="#cb32-482" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(BoroCD, geometry)</span>
<span id="cb32-483"><a href="#cb32-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-484"><a href="#cb32-484" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract coords + drop missing</span></span>
<span id="cb32-485"><a href="#cb32-485" aria-hidden="true" tabindex="-1"></a>  df_coords <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span></span>
<span id="cb32-486"><a href="#cb32-486" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb32-487"><a href="#cb32-487" aria-hidden="true" tabindex="-1"></a>      <span class="at">lon =</span> <span class="fu">as.numeric</span>(.data[[lon_col]]),</span>
<span id="cb32-488"><a href="#cb32-488" aria-hidden="true" tabindex="-1"></a>      <span class="at">lat =</span> <span class="fu">as.numeric</span>(.data[[lat_col]])</span>
<span id="cb32-489"><a href="#cb32-489" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb32-490"><a href="#cb32-490" aria-hidden="true" tabindex="-1"></a>    <span class="fu">drop_na</span>(lon, lat)</span>
<span id="cb32-491"><a href="#cb32-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-492"><a href="#cb32-492" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert to sf points</span></span>
<span id="cb32-493"><a href="#cb32-493" aria-hidden="true" tabindex="-1"></a>  df_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(df_coords, <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"lon"</span>, <span class="st">"lat"</span>), <span class="at">crs =</span> <span class="dv">4326</span>)</span>
<span id="cb32-494"><a href="#cb32-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-495"><a href="#cb32-495" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spatial join + return as regular tibble (no geometry column)</span></span>
<span id="cb32-496"><a href="#cb32-496" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_join</span>(df_sf, cd_keep, <span class="at">left =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-497"><a href="#cb32-497" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_drop_geometry</span>()</span>
<span id="cb32-498"><a href="#cb32-498" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-499"><a href="#cb32-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-500"><a href="#cb32-500" aria-hidden="true" tabindex="-1"></a>rat_inspection_with_cd_df <span class="ot">&lt;-</span> <span class="fu">add_cd_to_points</span>(rat_inspection)</span>
<span id="cb32-501"><a href="#cb32-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-502"><a href="#cb32-502" aria-hidden="true" tabindex="-1"></a>rat311_with_cd_df <span class="ot">&lt;-</span> <span class="fu">add_cd_to_points</span>(rodent_complaints)</span>
<span id="cb32-503"><a href="#cb32-503" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-504"><a href="#cb32-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-505"><a href="#cb32-505" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Construction</span></span>
<span id="cb32-506"><a href="#cb32-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-507"><a href="#cb32-507" aria-hidden="true" tabindex="-1"></a>In order to implement a event-centered difference-in-differences design, balanced panels were constructed around the timing of passed rodent inspections. For each spatial scale, inspection events were treated as the focal intervention, and 311 rodent complaints were organized relative to the first passed inspection within a given geographic unit. All panels were constructed at a weekly resolution and include both pre- and post-inspection periods, with zero-complaint weeks explicitly retained to support count-based modeling.</span>
<span id="cb32-508"><a href="#cb32-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-509"><a href="#cb32-509" aria-hidden="true" tabindex="-1"></a><span class="fu">### 150 Meter Radius</span></span>
<span id="cb32-510"><a href="#cb32-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-511"><a href="#cb32-511" aria-hidden="true" tabindex="-1"></a>A distance-based neighborhood radius was constructed around each passed inspection to capture localized responses in 311 complaints. This approach avoids reliance on predefined administrative boundaries. A 150-meter radius was selected to reflect a spatial range over which an inspection could influence nearby complaint behavior while minimizing spillovers from unrelated areas. Each complaint was linked to its nearest passed inspection within this radius, creating inspection-centered neighborhoods that remain fixed over time. Complaint counts were then aggregated weekly, and a balanced panel was constructed around the inspection event. This design prioritizes spatial precision and provides the clearest test of whether 311 complaints respond to localized improvements in rodent conditions.</span>
<span id="cb32-512"><a href="#cb32-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-515"><a href="#cb32-515" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-516"><a href="#cb32-516" aria-hidden="true" tabindex="-1"></a><span class="co">#' Construct distance-based difference-in-differences panels around PASS inspections.</span></span>
<span id="cb32-517"><a href="#cb32-517" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-518"><a href="#cb32-518" aria-hidden="true" tabindex="-1"></a><span class="co">#' To support the distance-based difference-in-differences analysis, this chunk integrates</span></span>
<span id="cb32-519"><a href="#cb32-519" aria-hidden="true" tabindex="-1"></a><span class="co">#' 311 rodent complaint records with PASS inspection locations using a spatial proximity</span></span>
<span id="cb32-520"><a href="#cb32-520" aria-hidden="true" tabindex="-1"></a><span class="co">#' approach. Both datasets are converted to spatial point features and projected to a</span></span>
<span id="cb32-521"><a href="#cb32-521" aria-hidden="true" tabindex="-1"></a><span class="co">#' coordinate reference system that preserves distances in meters. This allows complaint</span></span>
<span id="cb32-522"><a href="#cb32-522" aria-hidden="true" tabindex="-1"></a><span class="co">#' activity to be measured within a fixed radius of each inspection site and enables</span></span>
<span id="cb32-523"><a href="#cb32-523" aria-hidden="true" tabindex="-1"></a><span class="co">#' spatial proximity to be incorporated directly into the DiD design.</span></span>
<span id="cb32-524"><a href="#cb32-524" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb32-525"><a href="#cb32-525" aria-hidden="true" tabindex="-1"></a><span class="co">#' The resulting data structure supports neighborhood-by-month panels with zero-call</span></span>
<span id="cb32-526"><a href="#cb32-526" aria-hidden="true" tabindex="-1"></a><span class="co">#' months included and is used to estimate Poisson DiD models with neighborhood and</span></span>
<span id="cb32-527"><a href="#cb32-527" aria-hidden="true" tabindex="-1"></a><span class="co">#' month fixed effects.</span></span>
<span id="cb32-528"><a href="#cb32-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-529"><a href="#cb32-529" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the radius, in meters, used to define complaints occurring near a PASS inspection.</span></span>
<span id="cb32-530"><a href="#cb32-530" aria-hidden="true" tabindex="-1"></a><span class="co"># This value determines the spatial scale at which inspection effects are evaluated.</span></span>
<span id="cb32-531"><a href="#cb32-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-532"><a href="#cb32-532" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb32-533"><a href="#cb32-533" aria-hidden="true" tabindex="-1"></a><span class="co"># WEEK VERSION (separate names) + recommended filters</span></span>
<span id="cb32-534"><a href="#cb32-534" aria-hidden="true" tabindex="-1"></a><span class="co"># -----------------------------</span></span>
<span id="cb32-535"><a href="#cb32-535" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-536"><a href="#cb32-536" aria-hidden="true" tabindex="-1"></a>radius_m_w   <span class="ot">&lt;-</span> <span class="dv">150</span></span>
<span id="cb32-537"><a href="#cb32-537" aria-hidden="true" tabindex="-1"></a>window_w_w   <span class="ot">&lt;-</span> <span class="dv">26</span></span>
<span id="cb32-538"><a href="#cb32-538" aria-hidden="true" tabindex="-1"></a>week_start_w <span class="ot">&lt;-</span> <span class="dv">1</span>   <span class="co"># 1 = Monday, 7 = Sunday</span></span>
<span id="cb32-539"><a href="#cb32-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-540"><a href="#cb32-540" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) 311 calls -&gt; sf points with week</span></span>
<span id="cb32-541"><a href="#cb32-541" aria-hidden="true" tabindex="-1"></a>calls_sf_w <span class="ot">&lt;-</span> rat311_with_nta_df <span class="sc">%&gt;%</span></span>
<span id="cb32-542"><a href="#cb32-542" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">%&gt;%</span></span>
<span id="cb32-543"><a href="#cb32-543" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-544"><a href="#cb32-544" aria-hidden="true" tabindex="-1"></a>    <span class="at">created_date_w =</span> <span class="fu">as.Date</span>(created_date),</span>
<span id="cb32-545"><a href="#cb32-545" aria-hidden="true" tabindex="-1"></a>    <span class="at">call_week_w    =</span> <span class="fu">floor_date</span>(created_date_w, <span class="st">"week"</span>, <span class="at">week_start =</span> week_start_w)</span>
<span id="cb32-546"><a href="#cb32-546" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-547"><a href="#cb32-547" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-548"><a href="#cb32-548" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">3857</span>)</span>
<span id="cb32-549"><a href="#cb32-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-550"><a href="#cb32-550" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) Inspections -&gt; sf points with week (PASS centers)</span></span>
<span id="cb32-551"><a href="#cb32-551" aria-hidden="true" tabindex="-1"></a>insp_sf_w <span class="ot">&lt;-</span> rat_inspection <span class="sc">%&gt;%</span></span>
<span id="cb32-552"><a href="#cb32-552" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(longitude), <span class="sc">!</span><span class="fu">is.na</span>(latitude)) <span class="sc">%&gt;%</span></span>
<span id="cb32-553"><a href="#cb32-553" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-554"><a href="#cb32-554" aria-hidden="true" tabindex="-1"></a>    <span class="at">inspection_date_w =</span> <span class="fu">ymd</span>(inspection_date),</span>
<span id="cb32-555"><a href="#cb32-555" aria-hidden="true" tabindex="-1"></a>    <span class="at">inspection_week_w =</span> <span class="fu">floor_date</span>(inspection_date_w, <span class="st">"week"</span>, <span class="at">week_start =</span> week_start_w)</span>
<span id="cb32-556"><a href="#cb32-556" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-557"><a href="#cb32-557" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"longitude"</span>, <span class="st">"latitude"</span>), <span class="at">crs =</span> <span class="dv">4326</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-558"><a href="#cb32-558" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">3857</span>)</span>
<span id="cb32-559"><a href="#cb32-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-560"><a href="#cb32-560" aria-hidden="true" tabindex="-1"></a>pass_sf_w <span class="ot">&lt;-</span> insp_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb32-561"><a href="#cb32-561" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(result <span class="sc">==</span> <span class="st">"Passed"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-562"><a href="#cb32-562" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(inspection_week_w) <span class="sc">%&gt;%</span></span>
<span id="cb32-563"><a href="#cb32-563" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-564"><a href="#cb32-564" aria-hidden="true" tabindex="-1"></a>    <span class="at">neigh_id_w        =</span> <span class="fu">row_number</span>(),</span>
<span id="cb32-565"><a href="#cb32-565" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_pass_week_w =</span> inspection_week_w</span>
<span id="cb32-566"><a href="#cb32-566" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-567"><a href="#cb32-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-568"><a href="#cb32-568" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Nearest PASS for each call within radius</span></span>
<span id="cb32-569"><a href="#cb32-569" aria-hidden="true" tabindex="-1"></a>nn_out_w <span class="ot">&lt;-</span> <span class="fu">st_nn</span>(</span>
<span id="cb32-570"><a href="#cb32-570" aria-hidden="true" tabindex="-1"></a>  calls_sf_w, pass_sf_w,</span>
<span id="cb32-571"><a href="#cb32-571" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="dv">1</span>, <span class="at">maxdist =</span> radius_m_w,</span>
<span id="cb32-572"><a href="#cb32-572" aria-hidden="true" tabindex="-1"></a>  <span class="at">returnDist =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-573"><a href="#cb32-573" aria-hidden="true" tabindex="-1"></a>  <span class="at">progress =</span> <span class="cn">FALSE</span></span>
<span id="cb32-574"><a href="#cb32-574" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-575"><a href="#cb32-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-576"><a href="#cb32-576" aria-hidden="true" tabindex="-1"></a>calls_sf_w <span class="ot">&lt;-</span> calls_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb32-577"><a href="#cb32-577" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-578"><a href="#cb32-578" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_row_w =</span> <span class="fu">map_int</span>(nn_out_w<span class="sc">$</span>nn, <span class="sc">~</span> <span class="cf">if</span> (<span class="fu">length</span>(.x) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">NA_integer_</span> <span class="cf">else</span> .x[<span class="dv">1</span>]),</span>
<span id="cb32-579"><a href="#cb32-579" aria-hidden="true" tabindex="-1"></a>    <span class="at">dist_to_pass_m_w =</span> <span class="fu">map_dbl</span>(nn_out_w<span class="sc">$</span>dist, <span class="sc">~</span> <span class="cf">if</span> (<span class="fu">length</span>(.x) <span class="sc">==</span> <span class="dv">0</span>) <span class="cn">NA_real_</span> <span class="cf">else</span> .x[<span class="dv">1</span>]),</span>
<span id="cb32-580"><a href="#cb32-580" aria-hidden="true" tabindex="-1"></a>    <span class="at">neigh_id_w =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(pass_row_w), <span class="cn">NA_integer_</span>, pass_sf_w<span class="sc">$</span>neigh_id_w[pass_row_w])</span>
<span id="cb32-581"><a href="#cb32-581" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-582"><a href="#cb32-582" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>pass_row_w)</span>
<span id="cb32-583"><a href="#cb32-583" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-584"><a href="#cb32-584" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Keep only calls within chosen radius of a PASS</span></span>
<span id="cb32-585"><a href="#cb32-585" aria-hidden="true" tabindex="-1"></a>calls_near_w <span class="ot">&lt;-</span> calls_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb32-586"><a href="#cb32-586" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(dist_to_pass_m_w) <span class="sc">&amp;</span> dist_to_pass_m_w <span class="sc">&lt;=</span> radius_m_w)</span>
<span id="cb32-587"><a href="#cb32-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-588"><a href="#cb32-588" aria-hidden="true" tabindex="-1"></a><span class="co"># 5) Aggregate to neighborhood × week: count calls</span></span>
<span id="cb32-589"><a href="#cb32-589" aria-hidden="true" tabindex="-1"></a>calls_neigh_week_w <span class="ot">&lt;-</span> calls_near_w <span class="sc">%&gt;%</span></span>
<span id="cb32-590"><a href="#cb32-590" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-591"><a href="#cb32-591" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(neigh_id_w, call_week_w) <span class="sc">%&gt;%</span></span>
<span id="cb32-592"><a href="#cb32-592" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls_w =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb32-593"><a href="#cb32-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-594"><a href="#cb32-594" aria-hidden="true" tabindex="-1"></a><span class="co"># PASS event info per neigh_id_w</span></span>
<span id="cb32-595"><a href="#cb32-595" aria-hidden="true" tabindex="-1"></a>pass_info_w <span class="ot">&lt;-</span> pass_sf_w <span class="sc">%&gt;%</span></span>
<span id="cb32-596"><a href="#cb32-596" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-597"><a href="#cb32-597" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(neigh_id_w, first_pass_week_w)</span>
<span id="cb32-598"><a href="#cb32-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-599"><a href="#cb32-599" aria-hidden="true" tabindex="-1"></a><span class="co"># 6) FULL PANEL: all neighborhoods × all weeks (fill zeros) + event-time vars</span></span>
<span id="cb32-600"><a href="#cb32-600" aria-hidden="true" tabindex="-1"></a>all_weeks_w <span class="ot">&lt;-</span> <span class="fu">seq</span>(</span>
<span id="cb32-601"><a href="#cb32-601" aria-hidden="true" tabindex="-1"></a>  <span class="at">from =</span> <span class="fu">min</span>(calls_neigh_week_w<span class="sc">$</span>call_week_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-602"><a href="#cb32-602" aria-hidden="true" tabindex="-1"></a>  <span class="at">to   =</span> <span class="fu">max</span>(calls_neigh_week_w<span class="sc">$</span>call_week_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-603"><a href="#cb32-603" aria-hidden="true" tabindex="-1"></a>  <span class="at">by   =</span> <span class="st">"week"</span></span>
<span id="cb32-604"><a href="#cb32-604" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-605"><a href="#cb32-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-606"><a href="#cb32-606" aria-hidden="true" tabindex="-1"></a><span class="co"># Only neighborhoods that actually get used (nearest for &gt;=1 call within radius)</span></span>
<span id="cb32-607"><a href="#cb32-607" aria-hidden="true" tabindex="-1"></a>all_neigh_w <span class="ot">&lt;-</span> <span class="fu">sort</span>(<span class="fu">unique</span>(calls_near_w<span class="sc">$</span>neigh_id_w))</span>
<span id="cb32-608"><a href="#cb32-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-609"><a href="#cb32-609" aria-hidden="true" tabindex="-1"></a>full_neigh_panel_w <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb32-610"><a href="#cb32-610" aria-hidden="true" tabindex="-1"></a>  <span class="at">neigh_id_w  =</span> all_neigh_w,</span>
<span id="cb32-611"><a href="#cb32-611" aria-hidden="true" tabindex="-1"></a>  <span class="at">call_week_w =</span> all_weeks_w</span>
<span id="cb32-612"><a href="#cb32-612" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-613"><a href="#cb32-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-614"><a href="#cb32-614" aria-hidden="true" tabindex="-1"></a>panel_neigh_w <span class="ot">&lt;-</span> full_neigh_panel_w <span class="sc">%&gt;%</span></span>
<span id="cb32-615"><a href="#cb32-615" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_neigh_week_w, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"neigh_id_w"</span>, <span class="st">"call_week_w"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-616"><a href="#cb32-616" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls_w =</span> <span class="fu">replace_na</span>(calls_w, <span class="dv">0</span>L)) <span class="sc">%&gt;%</span></span>
<span id="cb32-617"><a href="#cb32-617" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pass_info_w, <span class="at">by =</span> <span class="st">"neigh_id_w"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-618"><a href="#cb32-618" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-619"><a href="#cb32-619" aria-hidden="true" tabindex="-1"></a>    <span class="at">rel_week_w  =</span> <span class="fu">as.integer</span>((call_week_w <span class="sc">-</span> first_pass_week_w) <span class="sc">/</span> <span class="dv">7</span>),</span>
<span id="cb32-620"><a href="#cb32-620" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_pass_w =</span> <span class="fu">as.integer</span>(rel_week_w <span class="sc">&gt;=</span> <span class="dv">0</span>)</span>
<span id="cb32-621"><a href="#cb32-621" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-622"><a href="#cb32-622" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(rel_week_w <span class="sc">&gt;=</span> <span class="sc">-</span>window_w_w, rel_week_w <span class="sc">&lt;=</span> window_w_w)</span>
<span id="cb32-623"><a href="#cb32-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-624"><a href="#cb32-624" aria-hidden="true" tabindex="-1"></a><span class="co"># 7) Recommended filters (balanced window + drop all-zero centers)</span></span>
<span id="cb32-625"><a href="#cb32-625" aria-hidden="true" tabindex="-1"></a>panel_neigh_w <span class="ot">&lt;-</span> panel_neigh_w <span class="sc">%&gt;%</span></span>
<span id="cb32-626"><a href="#cb32-626" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(neigh_id_w) <span class="sc">%&gt;%</span></span>
<span id="cb32-627"><a href="#cb32-627" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-628"><a href="#cb32-628" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pre_w        =</span> <span class="fu">sum</span>(rel_week_w <span class="sc">&lt;</span> <span class="dv">0</span>),</span>
<span id="cb32-629"><a href="#cb32-629" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_post_w       =</span> <span class="fu">sum</span>(rel_week_w <span class="sc">&gt;=</span> <span class="dv">0</span>),</span>
<span id="cb32-630"><a href="#cb32-630" aria-hidden="true" tabindex="-1"></a>    <span class="at">total_calls_w  =</span> <span class="fu">sum</span>(calls_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-631"><a href="#cb32-631" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-632"><a href="#cb32-632" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-633"><a href="#cb32-633" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb32-634"><a href="#cb32-634" aria-hidden="true" tabindex="-1"></a>    n_pre_w <span class="sc">&gt;=</span> <span class="dv">1</span>,</span>
<span id="cb32-635"><a href="#cb32-635" aria-hidden="true" tabindex="-1"></a>    n_post_w <span class="sc">&gt;=</span> <span class="dv">1</span>,</span>
<span id="cb32-636"><a href="#cb32-636" aria-hidden="true" tabindex="-1"></a>    total_calls_w <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb32-637"><a href="#cb32-637" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-638"><a href="#cb32-638" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>total_calls_w)</span>
<span id="cb32-639"><a href="#cb32-639" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-640"><a href="#cb32-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-641"><a href="#cb32-641" aria-hidden="true" tabindex="-1"></a><span class="fu">### NTA Level</span></span>
<span id="cb32-642"><a href="#cb32-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-643"><a href="#cb32-643" aria-hidden="true" tabindex="-1"></a>311 rodent complaints and inspection dates were aggregated to weekly counts within each Neighborhood Tabulation Area (NTA), and inspection records were used to identify the first passed rodent inspection in each NTA. The first treatment period is defined to begin in the week following the inspection to avoid conflicting inspection-day reporting with post-inspection behavioral or environmental changes. An event-centered panel was constructed by expanding each NTA across a fixed window of relative weeks around the inspection event and merging in weekly complaint counts. </span>
<span id="cb32-644"><a href="#cb32-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-647"><a href="#cb32-647" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-648"><a href="#cb32-648" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate 311 calls weekly so each NTA has number of calls per week</span></span>
<span id="cb32-649"><a href="#cb32-649" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-650"><a href="#cb32-650" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb32-651"><a href="#cb32-651" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb32-652"><a href="#cb32-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-653"><a href="#cb32-653" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Weekly calls by NTA x calendar week (same as you have)</span></span>
<span id="cb32-654"><a href="#cb32-654" aria-hidden="true" tabindex="-1"></a>calls_weekly <span class="ot">&lt;-</span> rat311_with_nta_df <span class="sc">%&gt;%</span></span>
<span id="cb32-655"><a href="#cb32-655" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-656"><a href="#cb32-656" aria-hidden="true" tabindex="-1"></a>    <span class="at">week    =</span> <span class="fu">floor_date</span>(created_date, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb32-657"><a href="#cb32-657" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id =</span> NTA2020</span>
<span id="cb32-658"><a href="#cb32-658" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-659"><a href="#cb32-659" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(area_id)) <span class="sc">%&gt;%</span></span>
<span id="cb32-660"><a href="#cb32-660" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id, week) <span class="sc">%&gt;%</span></span>
<span id="cb32-661"><a href="#cb32-661" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb32-662"><a href="#cb32-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-663"><a href="#cb32-663" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) First PASS week per NTA (same logic, but keep pass_week + treat_start_week)</span></span>
<span id="cb32-664"><a href="#cb32-664" aria-hidden="true" tabindex="-1"></a>pass_times <span class="ot">&lt;-</span> rat_inspection <span class="sc">%&gt;%</span></span>
<span id="cb32-665"><a href="#cb32-665" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">area_id =</span> nta_code, <span class="at">pass_date =</span> inspection_date) <span class="sc">%&gt;%</span></span>
<span id="cb32-666"><a href="#cb32-666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(area_id), result <span class="sc">==</span> <span class="st">"Passed"</span>, <span class="sc">!</span><span class="fu">is.na</span>(pass_date)) <span class="sc">%&gt;%</span></span>
<span id="cb32-667"><a href="#cb32-667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-668"><a href="#cb32-668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb32-669"><a href="#cb32-669" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_pass_date   =</span> <span class="fu">min</span>(pass_date),</span>
<span id="cb32-670"><a href="#cb32-670" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_week         =</span> <span class="fu">floor_date</span>(first_pass_date, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb32-671"><a href="#cb32-671" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_start_week  =</span> pass_week <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">1</span>),</span>
<span id="cb32-672"><a href="#cb32-672" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb32-673"><a href="#cb32-673" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-674"><a href="#cb32-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-675"><a href="#cb32-675" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Build event-centered grid: NTA x rel_week</span></span>
<span id="cb32-676"><a href="#cb32-676" aria-hidden="true" tabindex="-1"></a>event_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb32-677"><a href="#cb32-677" aria-hidden="true" tabindex="-1"></a>  <span class="at">area_id  =</span> <span class="fu">unique</span>(pass_times<span class="sc">$</span>area_id),</span>
<span id="cb32-678"><a href="#cb32-678" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_week =</span> <span class="sc">-</span><span class="dv">8</span><span class="sc">:</span><span class="dv">8</span></span>
<span id="cb32-679"><a href="#cb32-679" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-680"><a href="#cb32-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-681"><a href="#cb32-681" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Map each rel_week to the corresponding calendar week for that NTA</span></span>
<span id="cb32-682"><a href="#cb32-682" aria-hidden="true" tabindex="-1"></a>panel_event <span class="ot">&lt;-</span> event_grid <span class="sc">%&gt;%</span></span>
<span id="cb32-683"><a href="#cb32-683" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pass_times, <span class="at">by =</span> <span class="st">"area_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-684"><a href="#cb32-684" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-685"><a href="#cb32-685" aria-hidden="true" tabindex="-1"></a>    <span class="at">week =</span> treat_start_week <span class="sc">+</span> <span class="fu">weeks</span>(rel_week),</span>
<span id="cb32-686"><a href="#cb32-686" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_pass =</span> <span class="fu">ifelse</span>(rel_week <span class="sc">&gt;=</span> <span class="dv">0</span>, <span class="dv">1</span>L, <span class="dv">0</span>L)</span>
<span id="cb32-687"><a href="#cb32-687" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-688"><a href="#cb32-688" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_weekly, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"area_id"</span>, <span class="st">"week"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-689"><a href="#cb32-689" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls =</span> <span class="fu">replace_na</span>(calls, <span class="dv">0</span>L))</span>
<span id="cb32-690"><a href="#cb32-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-691"><a href="#cb32-691" aria-hidden="true" tabindex="-1"></a><span class="co"># Optional Sanity checks</span></span>
<span id="cb32-692"><a href="#cb32-692" aria-hidden="true" tabindex="-1"></a><span class="co"># nrow(panel)</span></span>
<span id="cb32-693"><a href="#cb32-693" aria-hidden="true" tabindex="-1"></a><span class="co"># nlevels(panel$area_factor); nlevels(panel$month_factor)</span></span>
<span id="cb32-694"><a href="#cb32-694" aria-hidden="true" tabindex="-1"></a><span class="co"># table(panel$post_pass)</span></span>
<span id="cb32-695"><a href="#cb32-695" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-696"><a href="#cb32-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-697"><a href="#cb32-697" aria-hidden="true" tabindex="-1"></a><span class="fu">### Community District Level</span></span>
<span id="cb32-698"><a href="#cb32-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-699"><a href="#cb32-699" aria-hidden="true" tabindex="-1"></a>As with the NTA analysis, a symmetric 8-week window before and after the inspection was used. Weekly complaint counts were aligned to event time, to enable direct comparison across spatial scales.</span>
<span id="cb32-700"><a href="#cb32-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-703"><a href="#cb32-703" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-704"><a href="#cb32-704" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-705"><a href="#cb32-705" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb32-706"><a href="#cb32-706" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb32-707"><a href="#cb32-707" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fixest)</span>
<span id="cb32-708"><a href="#cb32-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-709"><a href="#cb32-709" aria-hidden="true" tabindex="-1"></a>window_w <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb32-710"><a href="#cb32-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-711"><a href="#cb32-711" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-712"><a href="#cb32-712" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Weekly calls by CD x calendar week</span></span>
<span id="cb32-713"><a href="#cb32-713" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-714"><a href="#cb32-714" aria-hidden="true" tabindex="-1"></a>calls_weekly_cd <span class="ot">&lt;-</span> rat311_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb32-715"><a href="#cb32-715" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-716"><a href="#cb32-716" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_cd  =</span> <span class="fu">floor_date</span>(created_date, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb32-717"><a href="#cb32-717" aria-hidden="true" tabindex="-1"></a>    <span class="at">cd_id    =</span> <span class="fu">as.character</span>(BoroCD)</span>
<span id="cb32-718"><a href="#cb32-718" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-719"><a href="#cb32-719" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cd_id), <span class="sc">!</span><span class="fu">is.na</span>(week_cd)) <span class="sc">%&gt;%</span></span>
<span id="cb32-720"><a href="#cb32-720" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id, week_cd) <span class="sc">%&gt;%</span></span>
<span id="cb32-721"><a href="#cb32-721" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls_cd =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb32-722"><a href="#cb32-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-723"><a href="#cb32-723" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-724"><a href="#cb32-724" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) First PASS week by CD + treat_start_week</span></span>
<span id="cb32-725"><a href="#cb32-725" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-726"><a href="#cb32-726" aria-hidden="true" tabindex="-1"></a>pass_times_cd <span class="ot">&lt;-</span> rat_inspection_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb32-727"><a href="#cb32-727" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-728"><a href="#cb32-728" aria-hidden="true" tabindex="-1"></a>    <span class="at">cd_id     =</span> <span class="fu">as.character</span>(BoroCD),</span>
<span id="cb32-729"><a href="#cb32-729" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_date =</span> inspection_date</span>
<span id="cb32-730"><a href="#cb32-730" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-731"><a href="#cb32-731" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(cd_id), result <span class="sc">==</span> <span class="st">"Passed"</span>, <span class="sc">!</span><span class="fu">is.na</span>(pass_date)) <span class="sc">%&gt;%</span></span>
<span id="cb32-732"><a href="#cb32-732" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-733"><a href="#cb32-733" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb32-734"><a href="#cb32-734" aria-hidden="true" tabindex="-1"></a>    <span class="at">first_pass_date_cd  =</span> <span class="fu">min</span>(pass_date),</span>
<span id="cb32-735"><a href="#cb32-735" aria-hidden="true" tabindex="-1"></a>    <span class="at">pass_week_cd        =</span> <span class="fu">floor_date</span>(first_pass_date_cd, <span class="st">"week"</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb32-736"><a href="#cb32-736" aria-hidden="true" tabindex="-1"></a>    <span class="at">treat_start_week_cd =</span> pass_week_cd <span class="sc">+</span> <span class="fu">weeks</span>(<span class="dv">1</span>),</span>
<span id="cb32-737"><a href="#cb32-737" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb32-738"><a href="#cb32-738" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-739"><a href="#cb32-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-740"><a href="#cb32-740" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-741"><a href="#cb32-741" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Event-centered grid: CD x rel_week</span></span>
<span id="cb32-742"><a href="#cb32-742" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-743"><a href="#cb32-743" aria-hidden="true" tabindex="-1"></a>event_grid_cd <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(</span>
<span id="cb32-744"><a href="#cb32-744" aria-hidden="true" tabindex="-1"></a>  <span class="at">cd_id      =</span> <span class="fu">unique</span>(pass_times_cd<span class="sc">$</span>cd_id),</span>
<span id="cb32-745"><a href="#cb32-745" aria-hidden="true" tabindex="-1"></a>  <span class="at">rel_week_cd =</span> <span class="sc">-</span>window_w<span class="sc">:</span>window_w</span>
<span id="cb32-746"><a href="#cb32-746" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-747"><a href="#cb32-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-748"><a href="#cb32-748" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-749"><a href="#cb32-749" aria-hidden="true" tabindex="-1"></a><span class="co"># 4) Map rel_week -&gt; calendar week, join calls, fill zeros</span></span>
<span id="cb32-750"><a href="#cb32-750" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-751"><a href="#cb32-751" aria-hidden="true" tabindex="-1"></a>panel_event_cd <span class="ot">&lt;-</span> event_grid_cd <span class="sc">%&gt;%</span></span>
<span id="cb32-752"><a href="#cb32-752" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(pass_times_cd, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-753"><a href="#cb32-753" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-754"><a href="#cb32-754" aria-hidden="true" tabindex="-1"></a>    <span class="at">week_cd       =</span> treat_start_week_cd <span class="sc">+</span> <span class="fu">weeks</span>(rel_week_cd),</span>
<span id="cb32-755"><a href="#cb32-755" aria-hidden="true" tabindex="-1"></a>    <span class="at">post_pass_cd  =</span> <span class="fu">ifelse</span>(rel_week_cd <span class="sc">&gt;=</span> <span class="dv">0</span>, <span class="dv">1</span>L, <span class="dv">0</span>L)</span>
<span id="cb32-756"><a href="#cb32-756" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-757"><a href="#cb32-757" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_weekly_cd, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"cd_id"</span>, <span class="st">"week_cd"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-758"><a href="#cb32-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls_cd =</span> <span class="fu">replace_na</span>(calls_cd, <span class="dv">0</span>L))</span>
<span id="cb32-759"><a href="#cb32-759" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-760"><a href="#cb32-760" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-761"><a href="#cb32-761" aria-hidden="true" tabindex="-1"></a><span class="co"># (Optional) drop CDs with all-zero calls in the window</span></span>
<span id="cb32-762"><a href="#cb32-762" aria-hidden="true" tabindex="-1"></a><span class="do">############################################</span></span>
<span id="cb32-763"><a href="#cb32-763" aria-hidden="true" tabindex="-1"></a>panel_event_cd <span class="ot">&lt;-</span> panel_event_cd <span class="sc">%&gt;%</span></span>
<span id="cb32-764"><a href="#cb32-764" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-765"><a href="#cb32-765" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">sum</span>(calls_cd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-766"><a href="#cb32-766" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb32-767"><a href="#cb32-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-768"><a href="#cb32-768" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-769"><a href="#cb32-769" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-770"><a href="#cb32-770" aria-hidden="true" tabindex="-1"></a><span class="fu"># Exploratory Data Analysis</span></span>
<span id="cb32-771"><a href="#cb32-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-772"><a href="#cb32-772" aria-hidden="true" tabindex="-1"></a>NTAs with many PASS inspections in 2024</span>
<span id="cb32-773"><a href="#cb32-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-774"><a href="#cb32-774" aria-hidden="true" tabindex="-1"></a>Among those, which NTAs still had high 311 rat complaint volumes in 2024</span>
<span id="cb32-775"><a href="#cb32-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-778"><a href="#cb32-778" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-779"><a href="#cb32-779" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-780"><a href="#cb32-780" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb32-781"><a href="#cb32-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-782"><a href="#cb32-782" aria-hidden="true" tabindex="-1"></a>passes_2024 <span class="ot">&lt;-</span> rat_inspection <span class="sc">%&gt;%</span></span>
<span id="cb32-783"><a href="#cb32-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-784"><a href="#cb32-784" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id =</span> nta_code,</span>
<span id="cb32-785"><a href="#cb32-785" aria-hidden="true" tabindex="-1"></a>    <span class="at">inspection_date =</span> <span class="fu">ymd</span>(inspection_date),</span>
<span id="cb32-786"><a href="#cb32-786" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(inspection_date)</span>
<span id="cb32-787"><a href="#cb32-787" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-788"><a href="#cb32-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb32-789"><a href="#cb32-789" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">==</span> <span class="dv">2024</span>,</span>
<span id="cb32-790"><a href="#cb32-790" aria-hidden="true" tabindex="-1"></a>    result <span class="sc">==</span> <span class="st">"Passed"</span>,</span>
<span id="cb32-791"><a href="#cb32-791" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(area_id)</span>
<span id="cb32-792"><a href="#cb32-792" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-793"><a href="#cb32-793" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-794"><a href="#cb32-794" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb32-795"><a href="#cb32-795" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pass_2024 =</span> <span class="fu">n</span>(),</span>
<span id="cb32-796"><a href="#cb32-796" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb32-797"><a href="#cb32-797" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-798"><a href="#cb32-798" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_pass_2024))</span>
<span id="cb32-799"><a href="#cb32-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-800"><a href="#cb32-800" aria-hidden="true" tabindex="-1"></a>passes_2024 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb32-801"><a href="#cb32-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-802"><a href="#cb32-802" aria-hidden="true" tabindex="-1"></a>calls_2024 <span class="ot">&lt;-</span> rat311_with_nta_df <span class="sc">%&gt;%</span></span>
<span id="cb32-803"><a href="#cb32-803" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-804"><a href="#cb32-804" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id =</span> NTA2020,</span>
<span id="cb32-805"><a href="#cb32-805" aria-hidden="true" tabindex="-1"></a>    <span class="at">year =</span> <span class="fu">year</span>(created_date)</span>
<span id="cb32-806"><a href="#cb32-806" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-807"><a href="#cb32-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb32-808"><a href="#cb32-808" aria-hidden="true" tabindex="-1"></a>    year <span class="sc">==</span> <span class="dv">2024</span>,</span>
<span id="cb32-809"><a href="#cb32-809" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">is.na</span>(area_id)</span>
<span id="cb32-810"><a href="#cb32-810" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-811"><a href="#cb32-811" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-812"><a href="#cb32-812" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb32-813"><a href="#cb32-813" aria-hidden="true" tabindex="-1"></a>    <span class="at">calls_2024 =</span> <span class="fu">n</span>(),</span>
<span id="cb32-814"><a href="#cb32-814" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb32-815"><a href="#cb32-815" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-816"><a href="#cb32-816" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(calls_2024))</span>
<span id="cb32-817"><a href="#cb32-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-818"><a href="#cb32-818" aria-hidden="true" tabindex="-1"></a>calls_2024 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb32-819"><a href="#cb32-819" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-820"><a href="#cb32-820" aria-hidden="true" tabindex="-1"></a>pass_call_2024 <span class="ot">&lt;-</span> passes_2024 <span class="sc">%&gt;%</span></span>
<span id="cb32-821"><a href="#cb32-821" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_2024, <span class="at">by =</span> <span class="st">"area_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-822"><a href="#cb32-822" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-823"><a href="#cb32-823" aria-hidden="true" tabindex="-1"></a>    <span class="at">calls_2024 =</span> <span class="fu">replace_na</span>(calls_2024, <span class="dv">0</span>)</span>
<span id="cb32-824"><a href="#cb32-824" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-825"><a href="#cb32-825" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_pass_2024), <span class="fu">desc</span>(calls_2024))</span>
<span id="cb32-826"><a href="#cb32-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-827"><a href="#cb32-827" aria-hidden="true" tabindex="-1"></a>pass_call_2024 <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span>
<span id="cb32-828"><a href="#cb32-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-829"><a href="#cb32-829" aria-hidden="true" tabindex="-1"></a>high_pass_threshold <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>n_pass_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-830"><a href="#cb32-830" aria-hidden="true" tabindex="-1"></a>high_call_threshold <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>calls_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-831"><a href="#cb32-831" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-832"><a href="#cb32-832" aria-hidden="true" tabindex="-1"></a>suspicious_areas_2024 <span class="ot">&lt;-</span> pass_call_2024 <span class="sc">%&gt;%</span></span>
<span id="cb32-833"><a href="#cb32-833" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-834"><a href="#cb32-834" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pass  =</span> n_pass_2024 <span class="sc">&gt;=</span> high_pass_threshold,</span>
<span id="cb32-835"><a href="#cb32-835" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_calls =</span> calls_2024 <span class="sc">&gt;=</span> high_call_threshold,</span>
<span id="cb32-836"><a href="#cb32-836" aria-hidden="true" tabindex="-1"></a>    <span class="at">mismatch   =</span> high_pass <span class="sc">&amp;</span> high_calls</span>
<span id="cb32-837"><a href="#cb32-837" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-838"><a href="#cb32-838" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mismatch) <span class="sc">%&gt;%</span></span>
<span id="cb32-839"><a href="#cb32-839" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(n_pass_2024), <span class="fu">desc</span>(calls_2024))</span>
<span id="cb32-840"><a href="#cb32-840" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-841"><a href="#cb32-841" aria-hidden="true" tabindex="-1"></a>suspicious_areas_2024</span>
<span id="cb32-842"><a href="#cb32-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-843"><a href="#cb32-843" aria-hidden="true" tabindex="-1"></a><span class="co"># Create table output using kableExtra</span></span>
<span id="cb32-844"><a href="#cb32-844" aria-hidden="true" tabindex="-1"></a>nta_lookup <span class="ot">&lt;-</span> nta <span class="sc">%&gt;%</span></span>
<span id="cb32-845"><a href="#cb32-845" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_drop_geometry</span>() <span class="sc">%&gt;%</span></span>
<span id="cb32-846"><a href="#cb32-846" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb32-847"><a href="#cb32-847" aria-hidden="true" tabindex="-1"></a>    <span class="at">area_id  =</span> NTA2020,</span>
<span id="cb32-848"><a href="#cb32-848" aria-hidden="true" tabindex="-1"></a>    <span class="at">nta_name =</span> NTAName</span>
<span id="cb32-849"><a href="#cb32-849" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-850"><a href="#cb32-850" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span>
<span id="cb32-851"><a href="#cb32-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-852"><a href="#cb32-852" aria-hidden="true" tabindex="-1"></a>pass_call_2024 <span class="sc">%&gt;%</span></span>
<span id="cb32-853"><a href="#cb32-853" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(nta_lookup, <span class="at">by =</span> <span class="st">"area_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-854"><a href="#cb32-854" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(n_pass_2024, <span class="at">n =</span> <span class="dv">6</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-855"><a href="#cb32-855" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb32-856"><a href="#cb32-856" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">NTA Code</span><span class="st">`</span> <span class="ot">=</span> area_id,</span>
<span id="cb32-857"><a href="#cb32-857" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">NTA Name</span><span class="st">`</span> <span class="ot">=</span> nta_name,</span>
<span id="cb32-858"><a href="#cb32-858" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Passed inspections (2024)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">comma</span>(n_pass_2024),</span>
<span id="cb32-859"><a href="#cb32-859" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">311 complaints (2024)</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">comma</span>(calls_2024)</span>
<span id="cb32-860"><a href="#cb32-860" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-861"><a href="#cb32-861" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb32-862"><a href="#cb32-862" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>),</span>
<span id="cb32-863"><a href="#cb32-863" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Top NTAs by passed inspections and their 311 complaint volume (2024)."</span></span>
<span id="cb32-864"><a href="#cb32-864" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-865"><a href="#cb32-865" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span>
<span id="cb32-866"><a href="#cb32-866" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-867"><a href="#cb32-867" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-868"><a href="#cb32-868" aria-hidden="true" tabindex="-1"></a>NTAs in the top percentile of both inspection volume and complaint volume were flagged as areas where intensive inspection activity coincided with high reporting levels. The above table highlights neighborhoods where complaint volume remains elevated despite frequent inspections in 2024, motivating a closer examination of how spatial scale shapes the relationship between inspections and 311 complaints.</span>
<span id="cb32-869"><a href="#cb32-869" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-872"><a href="#cb32-872" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-873"><a href="#cb32-873" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Create flags (including mismatch) ONCE</span></span>
<span id="cb32-874"><a href="#cb32-874" aria-hidden="true" tabindex="-1"></a>x_cut <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>n_pass_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-875"><a href="#cb32-875" aria-hidden="true" tabindex="-1"></a>y_cut <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_2024<span class="sc">$</span>calls_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-876"><a href="#cb32-876" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-877"><a href="#cb32-877" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> pass_call_2024 <span class="sc">%&gt;%</span></span>
<span id="cb32-878"><a href="#cb32-878" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-879"><a href="#cb32-879" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pass  =</span> n_pass_2024 <span class="sc">&gt;=</span> x_cut,</span>
<span id="cb32-880"><a href="#cb32-880" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_calls =</span> calls_2024 <span class="sc">&gt;=</span> y_cut,</span>
<span id="cb32-881"><a href="#cb32-881" aria-hidden="true" tabindex="-1"></a>    <span class="at">mismatch   =</span> high_pass <span class="sc">&amp;</span> high_calls,</span>
<span id="cb32-882"><a href="#cb32-882" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> n_pass_2024 <span class="sc">+</span> <span class="dv">1</span>,   <span class="co"># +1 so log scale works with zeros</span></span>
<span id="cb32-883"><a href="#cb32-883" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> calls_2024 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb32-884"><a href="#cb32-884" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-885"><a href="#cb32-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-886"><a href="#cb32-886" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) (Optional) label only the top 8 mismatch NTAs by complaints</span></span>
<span id="cb32-887"><a href="#cb32-887" aria-hidden="true" tabindex="-1"></a>label_df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb32-888"><a href="#cb32-888" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mismatch) <span class="sc">%&gt;%</span></span>
<span id="cb32-889"><a href="#cb32-889" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(calls_2024, <span class="at">n =</span> <span class="dv">8</span>)</span>
<span id="cb32-890"><a href="#cb32-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-891"><a href="#cb32-891" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) Plot</span></span>
<span id="cb32-892"><a href="#cb32-892" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb32-893"><a href="#cb32-893" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> mismatch), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-894"><a href="#cb32-894" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> x_cut <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb32-895"><a href="#cb32-895" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> y_cut <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb32-896"><a href="#cb32-896" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(</span>
<span id="cb32-897"><a href="#cb32-897" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> label_df,</span>
<span id="cb32-898"><a href="#cb32-898" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">label =</span> area_id),</span>
<span id="cb32-899"><a href="#cb32-899" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span>,</span>
<span id="cb32-900"><a href="#cb32-900" aria-hidden="true" tabindex="-1"></a>    <span class="at">max.overlaps =</span> <span class="cn">Inf</span></span>
<span id="cb32-901"><a href="#cb32-901" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-902"><a href="#cb32-902" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb32-903"><a href="#cb32-903" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb32-904"><a href="#cb32-904" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.25</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb32-905"><a href="#cb32-905" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-906"><a href="#cb32-906" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PASSED inspections vs 311 rodent complaints by NTA (2024)"</span>,</span>
<span id="cb32-907"><a href="#cb32-907" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed lines mark the 75th percentile; labels show top mismatch NTAs"</span>,</span>
<span id="cb32-908"><a href="#cb32-908" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PASSED inspections in 2024 (log scale)"</span>,</span>
<span id="cb32-909"><a href="#cb32-909" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"311 rodent complaints in 2024 (log scale)"</span></span>
<span id="cb32-910"><a href="#cb32-910" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-911"><a href="#cb32-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb32-912"><a href="#cb32-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-913"><a href="#cb32-913" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-914"><a href="#cb32-914" aria-hidden="true" tabindex="-1"></a>These areas are now plotted above. NTAs with high volumes of passed inspections and high 311 complaint volumes are highlighted, showing where inspection activity and resident reporting remain simultaneously elevated.</span>
<span id="cb32-915"><a href="#cb32-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-918"><a href="#cb32-918" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-919"><a href="#cb32-919" aria-hidden="true" tabindex="-1"></a><span class="co"># 2024 PASSES by CD</span></span>
<span id="cb32-920"><a href="#cb32-920" aria-hidden="true" tabindex="-1"></a>passes_cd_2024 <span class="ot">&lt;-</span> rat_inspection_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb32-921"><a href="#cb32-921" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cd_id =</span> <span class="fu">as.character</span>(BoroCD),</span>
<span id="cb32-922"><a href="#cb32-922" aria-hidden="true" tabindex="-1"></a>         <span class="at">year  =</span> <span class="fu">year</span>(inspection_date)) <span class="sc">%&gt;%</span></span>
<span id="cb32-923"><a href="#cb32-923" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2024</span>, result <span class="sc">==</span> <span class="st">"Passed"</span>, <span class="sc">!</span><span class="fu">is.na</span>(cd_id)) <span class="sc">%&gt;%</span></span>
<span id="cb32-924"><a href="#cb32-924" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-925"><a href="#cb32-925" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">n_pass_2024 =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb32-926"><a href="#cb32-926" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-927"><a href="#cb32-927" aria-hidden="true" tabindex="-1"></a><span class="co"># 2024 CALLS by CD</span></span>
<span id="cb32-928"><a href="#cb32-928" aria-hidden="true" tabindex="-1"></a>calls_cd_2024 <span class="ot">&lt;-</span> rat311_with_cd_df <span class="sc">%&gt;%</span></span>
<span id="cb32-929"><a href="#cb32-929" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">cd_id =</span> <span class="fu">as.character</span>(BoroCD),</span>
<span id="cb32-930"><a href="#cb32-930" aria-hidden="true" tabindex="-1"></a>         <span class="at">year  =</span> <span class="fu">year</span>(created_date)) <span class="sc">%&gt;%</span></span>
<span id="cb32-931"><a href="#cb32-931" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2024</span>, <span class="sc">!</span><span class="fu">is.na</span>(cd_id)) <span class="sc">%&gt;%</span></span>
<span id="cb32-932"><a href="#cb32-932" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(cd_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-933"><a href="#cb32-933" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">calls_2024 =</span> <span class="fu">n</span>(), <span class="at">.groups =</span> <span class="st">"drop"</span>)</span>
<span id="cb32-934"><a href="#cb32-934" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-935"><a href="#cb32-935" aria-hidden="true" tabindex="-1"></a>pass_call_cd_2024 <span class="ot">&lt;-</span> passes_cd_2024 <span class="sc">%&gt;%</span></span>
<span id="cb32-936"><a href="#cb32-936" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(calls_cd_2024, <span class="at">by =</span> <span class="st">"cd_id"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb32-937"><a href="#cb32-937" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">calls_2024 =</span> <span class="fu">replace_na</span>(calls_2024, <span class="dv">0</span>L))</span>
<span id="cb32-938"><a href="#cb32-938" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-939"><a href="#cb32-939" aria-hidden="true" tabindex="-1"></a>pass_call_cd_2024 <span class="sc">|&gt;</span></span>
<span id="cb32-940"><a href="#cb32-940" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(n_pass_2024, <span class="at">n =</span> <span class="dv">6</span>, <span class="at">with_ties =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb32-941"><a href="#cb32-941" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-942"><a href="#cb32-942" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_pass_2024 =</span> <span class="fu">comma</span>(n_pass_2024),</span>
<span id="cb32-943"><a href="#cb32-943" aria-hidden="true" tabindex="-1"></a>    <span class="at">calls_2024  =</span> <span class="fu">comma</span>(calls_2024)</span>
<span id="cb32-944"><a href="#cb32-944" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-945"><a href="#cb32-945" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(</span>
<span id="cb32-946"><a href="#cb32-946" aria-hidden="true" tabindex="-1"></a>    <span class="at">col.names =</span> <span class="fu">c</span>(<span class="st">"Community District"</span>, <span class="st">"Passed Inspections (2024)"</span>, <span class="st">"311 Complaints (2024)"</span>),</span>
<span id="cb32-947"><a href="#cb32-947" aria-hidden="true" tabindex="-1"></a>    <span class="at">align =</span> <span class="fu">c</span>(<span class="st">"l"</span>, <span class="st">"r"</span>, <span class="st">"r"</span>),</span>
<span id="cb32-948"><a href="#cb32-948" aria-hidden="true" tabindex="-1"></a>    <span class="at">caption =</span> <span class="st">"Top Community Districts by passed inspections and their 311 complaint volume (2024)."</span></span>
<span id="cb32-949"><a href="#cb32-949" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb32-950"><a href="#cb32-950" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable_styling</span>(<span class="at">full_width =</span> <span class="cn">FALSE</span>, <span class="at">bootstrap_options =</span> <span class="fu">c</span>(<span class="st">"striped"</span>, <span class="st">"hover"</span>))</span>
<span id="cb32-951"><a href="#cb32-951" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-952"><a href="#cb32-952" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-953"><a href="#cb32-953" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-956"><a href="#cb32-956" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-957"><a href="#cb32-957" aria-hidden="true" tabindex="-1"></a><span class="co"># Flags + plot</span></span>
<span id="cb32-958"><a href="#cb32-958" aria-hidden="true" tabindex="-1"></a>x_cut_cd <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_cd_2024<span class="sc">$</span>n_pass_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-959"><a href="#cb32-959" aria-hidden="true" tabindex="-1"></a>y_cut_cd <span class="ot">&lt;-</span> <span class="fu">quantile</span>(pass_call_cd_2024<span class="sc">$</span>calls_2024, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-960"><a href="#cb32-960" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-961"><a href="#cb32-961" aria-hidden="true" tabindex="-1"></a>df_cd <span class="ot">&lt;-</span> pass_call_cd_2024 <span class="sc">%&gt;%</span></span>
<span id="cb32-962"><a href="#cb32-962" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-963"><a href="#cb32-963" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pass  =</span> n_pass_2024 <span class="sc">&gt;=</span> x_cut_cd,</span>
<span id="cb32-964"><a href="#cb32-964" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_calls =</span> calls_2024 <span class="sc">&gt;=</span> y_cut_cd,</span>
<span id="cb32-965"><a href="#cb32-965" aria-hidden="true" tabindex="-1"></a>    <span class="at">mismatch   =</span> high_pass <span class="sc">&amp;</span> high_calls,</span>
<span id="cb32-966"><a href="#cb32-966" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> n_pass_2024 <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb32-967"><a href="#cb32-967" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> calls_2024 <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb32-968"><a href="#cb32-968" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-969"><a href="#cb32-969" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-970"><a href="#cb32-970" aria-hidden="true" tabindex="-1"></a>label_df_cd <span class="ot">&lt;-</span> df_cd <span class="sc">%&gt;%</span></span>
<span id="cb32-971"><a href="#cb32-971" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(mismatch) <span class="sc">%&gt;%</span></span>
<span id="cb32-972"><a href="#cb32-972" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(calls_2024, <span class="at">n =</span> <span class="dv">8</span>)</span>
<span id="cb32-973"><a href="#cb32-973" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-974"><a href="#cb32-974" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(df_cd, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y)) <span class="sc">+</span></span>
<span id="cb32-975"><a href="#cb32-975" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">alpha =</span> mismatch), <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-976"><a href="#cb32-976" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> x_cut_cd <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb32-977"><a href="#cb32-977" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> y_cut_cd <span class="sc">+</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb32-978"><a href="#cb32-978" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text_repel</span>(<span class="at">data =</span> label_df_cd, <span class="fu">aes</span>(<span class="at">label =</span> cd_id),</span>
<span id="cb32-979"><a href="#cb32-979" aria-hidden="true" tabindex="-1"></a>                  <span class="at">size =</span> <span class="dv">3</span>, <span class="at">max.overlaps =</span> <span class="cn">Inf</span>) <span class="sc">+</span></span>
<span id="cb32-980"><a href="#cb32-980" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb32-981"><a href="#cb32-981" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_log10</span>(<span class="at">labels =</span> comma) <span class="sc">+</span></span>
<span id="cb32-982"><a href="#cb32-982" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"FALSE"</span> <span class="ot">=</span> <span class="fl">0.25</span>, <span class="st">"TRUE"</span> <span class="ot">=</span> <span class="dv">1</span>), <span class="at">guide =</span> <span class="st">"none"</span>) <span class="sc">+</span></span>
<span id="cb32-983"><a href="#cb32-983" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb32-984"><a href="#cb32-984" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"PASSED inspections vs 311 rodent complaints by Community District (2024)"</span>,</span>
<span id="cb32-985"><a href="#cb32-985" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Dashed lines mark the 75th percentile; labels show top mismatch districts"</span>,</span>
<span id="cb32-986"><a href="#cb32-986" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"PASSED inspections in 2024 (log scale)"</span>,</span>
<span id="cb32-987"><a href="#cb32-987" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"311 rodent complaints in 2024 (log scale)"</span></span>
<span id="cb32-988"><a href="#cb32-988" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb32-989"><a href="#cb32-989" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span>
<span id="cb32-990"><a href="#cb32-990" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-991"><a href="#cb32-991" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-992"><a href="#cb32-992" aria-hidden="true" tabindex="-1"></a><span class="fu"># Statistical Analysis Using Difference-in-Differences</span></span>
<span id="cb32-993"><a href="#cb32-993" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-994"><a href="#cb32-994" aria-hidden="true" tabindex="-1"></a>A weekly panel of rat-related 311 complaints by local area was constructed, and the week in which each neighborhood first received a passed inspection (PASS) was identified. An event-centered difference-in-differences design is adopted, in which time is indexed relative to the first passed inspection in each neighborhood. A Poisson regression with neighborhood fixed effects and an indicator for weeks following a passed inspection is estimated using a balanced window of eight weeks before and after the inspection. The Poisson specification is appropriate given the count nature of the outcome and allows for a flexible mean–variance relationship while accommodating a large share of zero-valued observations. This specification compares changes in 311 complaint volume before and after a passed inspection within the same neighborhood, net of time-invariant neighborhood characteristics. Identification relies on the assumption that, absent a passed inspection, complaint trends within neighborhoods would have evolved similarly in the pre- and post-inspection periods.</span>
<span id="cb32-995"><a href="#cb32-995" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-996"><a href="#cb32-996" aria-hidden="true" tabindex="-1"></a><span class="fu">## DiD Model Estimates</span></span>
<span id="cb32-997"><a href="#cb32-997" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-998"><a href="#cb32-998" aria-hidden="true" tabindex="-1"></a>All three specifications are estimated using the <span class="in">`fixest`</span> package to maintain a consistent estimation framework across different spatial scales. In each case, the outcome is a count of rat-related 311 complaints aggregated to the relevant week. Models are estimated with <span class="in">`fepois`</span>, which fits a fixed-effects Poisson regression via Poisson quasi–maximum likelihood while efficiently absorbing high-dimensional fixed effects. This approach is well suited to complaint counts that are nonnegative and often zero, and it allows unit fixed effects to be included without manually creating large sets of dummy variables. Across specifications, standard errors are clustered at the unit level to account for within-unit serial correlation in complaint activity over time.</span>
<span id="cb32-999"><a href="#cb32-999" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1000"><a href="#cb32-1000" aria-hidden="true" tabindex="-1"></a><span class="fu">### 150m Radius Model</span></span>
<span id="cb32-1001"><a href="#cb32-1001" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1002"><a href="#cb32-1002" aria-hidden="true" tabindex="-1"></a>First, the following code segment shows the model used for the 150 radius spatial scale.</span>
<span id="cb32-1003"><a href="#cb32-1003" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1006"><a href="#cb32-1006" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1007"><a href="#cb32-1007" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit Poisson DiD model using fixed-effects Poisson using fixest package</span></span>
<span id="cb32-1008"><a href="#cb32-1008" aria-hidden="true" tabindex="-1"></a>m150_w <span class="ot">&lt;-</span> <span class="fu">fepois</span>(</span>
<span id="cb32-1009"><a href="#cb32-1009" aria-hidden="true" tabindex="-1"></a>  calls_w <span class="sc">~</span> post_pass_w <span class="sc">|</span> neigh_id_w,</span>
<span id="cb32-1010"><a href="#cb32-1010" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> panel_neigh_w,</span>
<span id="cb32-1011"><a href="#cb32-1011" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> neigh_id_w</span>
<span id="cb32-1012"><a href="#cb32-1012" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1013"><a href="#cb32-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1014"><a href="#cb32-1014" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(m150_w)</span>
<span id="cb32-1015"><a href="#cb32-1015" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1016"><a href="#cb32-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1017"><a href="#cb32-1017" aria-hidden="true" tabindex="-1"></a><span class="fu">### NTA Model</span></span>
<span id="cb32-1018"><a href="#cb32-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1019"><a href="#cb32-1019" aria-hidden="true" tabindex="-1"></a>Next, the following code segment shows the model used for the NTA level spatial scale.</span>
<span id="cb32-1020"><a href="#cb32-1020" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1023"><a href="#cb32-1023" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1024"><a href="#cb32-1024" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">fepois</span>(</span>
<span id="cb32-1025"><a href="#cb32-1025" aria-hidden="true" tabindex="-1"></a>  calls <span class="sc">~</span> post_pass <span class="sc">|</span> area_id,</span>
<span id="cb32-1026"><a href="#cb32-1026" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> panel_event,</span>
<span id="cb32-1027"><a href="#cb32-1027" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> area_id   <span class="co"># cluster by area</span></span>
<span id="cb32-1028"><a href="#cb32-1028" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1029"><a href="#cb32-1029" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1030"><a href="#cb32-1030" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(m)</span>
<span id="cb32-1031"><a href="#cb32-1031" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1032"><a href="#cb32-1032" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1033"><a href="#cb32-1033" aria-hidden="true" tabindex="-1"></a><span class="fu">### Community District Model</span></span>
<span id="cb32-1034"><a href="#cb32-1034" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1035"><a href="#cb32-1035" aria-hidden="true" tabindex="-1"></a>Lastly, the following code segment shows the model used for the Community District level spatial scale.</span>
<span id="cb32-1036"><a href="#cb32-1036" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1039"><a href="#cb32-1039" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1040"><a href="#cb32-1040" aria-hidden="true" tabindex="-1"></a>m_cd <span class="ot">&lt;-</span> <span class="fu">fepois</span>(</span>
<span id="cb32-1041"><a href="#cb32-1041" aria-hidden="true" tabindex="-1"></a>  calls_cd <span class="sc">~</span> post_pass_cd <span class="sc">|</span> cd_id,</span>
<span id="cb32-1042"><a href="#cb32-1042" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> panel_event_cd,</span>
<span id="cb32-1043"><a href="#cb32-1043" aria-hidden="true" tabindex="-1"></a>  <span class="at">vcov =</span> <span class="sc">~</span> cd_id</span>
<span id="cb32-1044"><a href="#cb32-1044" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1045"><a href="#cb32-1045" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1046"><a href="#cb32-1046" aria-hidden="true" tabindex="-1"></a><span class="fu">etable</span>(m_cd)</span>
<span id="cb32-1047"><a href="#cb32-1047" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1048"><a href="#cb32-1048" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1049"><a href="#cb32-1049" aria-hidden="true" tabindex="-1"></a><span class="fu">## Model Validation</span></span>
<span id="cb32-1050"><a href="#cb32-1050" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1051"><a href="#cb32-1051" aria-hidden="true" tabindex="-1"></a>Before presenting the main estimates, diagnostic checks were considered to assess the plausibility of the identifying assumptions.</span>
<span id="cb32-1052"><a href="#cb32-1052" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1053"><a href="#cb32-1053" aria-hidden="true" tabindex="-1"></a><span class="fu">### Stable Unit Treatment Value Assumption (SUTVA)</span></span>
<span id="cb32-1054"><a href="#cb32-1054" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1055"><a href="#cb32-1055" aria-hidden="true" tabindex="-1"></a>Spillovers across neighborhoods are likely to be limited because rat inspections target specific properties and complaint reporting is highly localized. Residents typically report conditions in their immediate vicinity, making it unlikely that a passed inspection in one neighborhood directly affects complaint behavior in non-adjacent areas.</span>
<span id="cb32-1056"><a href="#cb32-1056" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1057"><a href="#cb32-1057" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parallel Trends</span></span>
<span id="cb32-1058"><a href="#cb32-1058" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1061"><a href="#cb32-1061" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1062"><a href="#cb32-1062" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb32-1063"><a href="#cb32-1063" aria-hidden="true" tabindex="-1"></a>avg_trend_150 <span class="ot">&lt;-</span> panel_neigh_w <span class="sc">%&gt;%</span></span>
<span id="cb32-1064"><a href="#cb32-1064" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rel_week_w) <span class="sc">%&gt;%</span></span>
<span id="cb32-1065"><a href="#cb32-1065" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_calls =</span> <span class="fu">mean</span>(calls_w, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-1066"><a href="#cb32-1066" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rel_week_w)</span>
<span id="cb32-1067"><a href="#cb32-1067" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1068"><a href="#cb32-1068" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb32-1069"><a href="#cb32-1069" aria-hidden="true" tabindex="-1"></a>  avg_trend_150<span class="sc">$</span>rel_week_w,</span>
<span id="cb32-1070"><a href="#cb32-1070" aria-hidden="true" tabindex="-1"></a>  avg_trend_150<span class="sc">$</span>mean_calls,</span>
<span id="cb32-1071"><a href="#cb32-1071" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"b"</span>,</span>
<span id="cb32-1072"><a href="#cb32-1072" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Weeks Relative to PASS"</span>,</span>
<span id="cb32-1073"><a href="#cb32-1073" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Average 311 Complaints (within 150 m)"</span>,</span>
<span id="cb32-1074"><a href="#cb32-1074" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Pre-Trends: 150 m Inspection-Centered Neighborhoods"</span></span>
<span id="cb32-1075"><a href="#cb32-1075" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1076"><a href="#cb32-1076" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb32-1077"><a href="#cb32-1077" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1078"><a href="#cb32-1078" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1079"><a href="#cb32-1079" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1080"><a href="#cb32-1080" aria-hidden="true" tabindex="-1"></a>Event-time averages for inspection-centered neighborhoods exhibit a pronounced increase in complaint activity immediately prior to PASS inspections, reflecting the fact that inspections are triggered by accumulated complaints. For this reason, the identifying variation comes from comparing post-inspection outcomes to the immediate pre-inspection period rather than to distant pre-periods. The analysis therefore relies on a local parallel trends assumption, under which complaint levels would have remained at their pre-inspection level absent a PASS result.</span>
<span id="cb32-1081"><a href="#cb32-1081" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1084"><a href="#cb32-1084" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1085"><a href="#cb32-1085" aria-hidden="true" tabindex="-1"></a>avg_trend <span class="ot">&lt;-</span> panel_event <span class="sc">%&gt;%</span></span>
<span id="cb32-1086"><a href="#cb32-1086" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rel_week) <span class="sc">%&gt;%</span></span>
<span id="cb32-1087"><a href="#cb32-1087" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_calls =</span> <span class="fu">mean</span>(calls, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-1088"><a href="#cb32-1088" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rel_week)</span>
<span id="cb32-1089"><a href="#cb32-1089" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1090"><a href="#cb32-1090" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb32-1091"><a href="#cb32-1091" aria-hidden="true" tabindex="-1"></a>  avg_trend<span class="sc">$</span>rel_week,</span>
<span id="cb32-1092"><a href="#cb32-1092" aria-hidden="true" tabindex="-1"></a>  avg_trend<span class="sc">$</span>mean_calls,</span>
<span id="cb32-1093"><a href="#cb32-1093" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"b"</span>,</span>
<span id="cb32-1094"><a href="#cb32-1094" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Weeks Relative to PASS"</span>,</span>
<span id="cb32-1095"><a href="#cb32-1095" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Average 311 Complaints"</span></span>
<span id="cb32-1096"><a href="#cb32-1096" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1097"><a href="#cb32-1097" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb32-1098"><a href="#cb32-1098" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1099"><a href="#cb32-1099" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1100"><a href="#cb32-1100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1101"><a href="#cb32-1101" aria-hidden="true" tabindex="-1"></a>Event-time averages exhibit some week-to-week variability in the pre-inspection period, which is expected given low complaint counts and aggregation at the neighborhood level. However, there is no evidence of a systematic downward trend prior to PASS inspections. In addition, placebo timing tests yield null effects, providing no evidence of differential pre-trends.</span>
<span id="cb32-1102"><a href="#cb32-1102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1105"><a href="#cb32-1105" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1106"><a href="#cb32-1106" aria-hidden="true" tabindex="-1"></a>avg_trend_cd <span class="ot">&lt;-</span> panel_event_cd <span class="sc">%&gt;%</span></span>
<span id="cb32-1107"><a href="#cb32-1107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(rel_week_cd) <span class="sc">%&gt;%</span></span>
<span id="cb32-1108"><a href="#cb32-1108" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">mean_calls =</span> <span class="fu">mean</span>(calls_cd, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb32-1109"><a href="#cb32-1109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(rel_week_cd)</span>
<span id="cb32-1110"><a href="#cb32-1110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1111"><a href="#cb32-1111" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb32-1112"><a href="#cb32-1112" aria-hidden="true" tabindex="-1"></a>  avg_trend_cd<span class="sc">$</span>rel_week_cd,</span>
<span id="cb32-1113"><a href="#cb32-1113" aria-hidden="true" tabindex="-1"></a>  avg_trend_cd<span class="sc">$</span>mean_calls,</span>
<span id="cb32-1114"><a href="#cb32-1114" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"b"</span>,</span>
<span id="cb32-1115"><a href="#cb32-1115" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"Weeks Relative to PASS"</span>,</span>
<span id="cb32-1116"><a href="#cb32-1116" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"Average 311 Complaints (Community District)"</span>,</span>
<span id="cb32-1117"><a href="#cb32-1117" aria-hidden="true" tabindex="-1"></a>  <span class="at">main =</span> <span class="st">"Pre-Trends: Community Districts"</span></span>
<span id="cb32-1118"><a href="#cb32-1118" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1119"><a href="#cb32-1119" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">v =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb32-1120"><a href="#cb32-1120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1121"><a href="#cb32-1121" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1122"><a href="#cb32-1122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1123"><a href="#cb32-1123" aria-hidden="true" tabindex="-1"></a>At the community district level, average complaint activity shows no pronounced pre-inspection pattern and remains close to zero prior to PASS inspections. This reflects the coarse spatial aggregation of community districts, within which localized inspection-related complaint dynamics are largely diluted.</span>
<span id="cb32-1124"><a href="#cb32-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1125"><a href="#cb32-1125" aria-hidden="true" tabindex="-1"></a><span class="fu">## Results</span></span>
<span id="cb32-1126"><a href="#cb32-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1127"><a href="#cb32-1127" aria-hidden="true" tabindex="-1"></a>Raw coefficient results are not intuitive because Poisson was used in the model. Instead percentage changes can be reported using the following formula:</span>
<span id="cb32-1128"><a href="#cb32-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1129"><a href="#cb32-1129" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-1130"><a href="#cb32-1130" aria-hidden="true" tabindex="-1"></a>\% \Delta = 100 \times \left(\exp(\beta) - 1\right)</span>
<span id="cb32-1131"><a href="#cb32-1131" aria-hidden="true" tabindex="-1"></a>$$</span>
<span id="cb32-1132"><a href="#cb32-1132" aria-hidden="true" tabindex="-1"></a>The table below reports the difference-in-differences estimates of the effect of PASS inspections on rat-related 311 complaints across three spatial scales. At the community district level, the estimated effect is small and statistically indistinguishable from zero, reflecting substantial spatial dilution. Estimates at the NTA level are larger in magnitude but imprecise. In contrast, inspection-centered neighborhoods defined within a 150 m radius exhibit a large and statistically significant decline in complaints following a PASS inspection, consistent with highly localized treatment effects.</span>
<span id="cb32-1133"><a href="#cb32-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1136"><a href="#cb32-1136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1137"><a href="#cb32-1137" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Models to compare ----</span></span>
<span id="cb32-1138"><a href="#cb32-1138" aria-hidden="true" tabindex="-1"></a>models <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb32-1139"><a href="#cb32-1139" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Community District"</span> <span class="ot">=</span> m_cd,</span>
<span id="cb32-1140"><a href="#cb32-1140" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NTA"</span>                <span class="ot">=</span> m,</span>
<span id="cb32-1141"><a href="#cb32-1141" aria-hidden="true" tabindex="-1"></a>  <span class="st">"150 m radius"</span>       <span class="ot">=</span> m150_w</span>
<span id="cb32-1142"><a href="#cb32-1142" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1143"><a href="#cb32-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1144"><a href="#cb32-1144" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Implied percent change for Poisson coefficients: %Δ = 100 * (exp(β) - 1) ----</span></span>
<span id="cb32-1145"><a href="#cb32-1145" aria-hidden="true" tabindex="-1"></a>post_betas <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb32-1146"><a href="#cb32-1146" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Community District"</span> <span class="ot">=</span> <span class="fu">coef</span>(m_cd)[[<span class="st">"post_pass_cd"</span>]],</span>
<span id="cb32-1147"><a href="#cb32-1147" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NTA"</span>                <span class="ot">=</span> <span class="fu">coef</span>(m)[[<span class="st">"post_pass"</span>]],</span>
<span id="cb32-1148"><a href="#cb32-1148" aria-hidden="true" tabindex="-1"></a>  <span class="st">"150 m radius"</span>       <span class="ot">=</span> <span class="fu">coef</span>(m150_w)[[<span class="st">"post_pass_w"</span>]]</span>
<span id="cb32-1149"><a href="#cb32-1149" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1150"><a href="#cb32-1150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1151"><a href="#cb32-1151" aria-hidden="true" tabindex="-1"></a>pct_change <span class="ot">&lt;-</span> <span class="dv">100</span> <span class="sc">*</span> (<span class="fu">exp</span>(post_betas) <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb32-1152"><a href="#cb32-1152" aria-hidden="true" tabindex="-1"></a>pct_change_fmt <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%.1f%%"</span>, pct_change)</span>
<span id="cb32-1153"><a href="#cb32-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1154"><a href="#cb32-1154" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure names exist and match the table columns (prevents "subscript out of bounds")</span></span>
<span id="cb32-1155"><a href="#cb32-1155" aria-hidden="true" tabindex="-1"></a>pct_change_fmt <span class="ot">&lt;-</span> <span class="fu">setNames</span>(</span>
<span id="cb32-1156"><a href="#cb32-1156" aria-hidden="true" tabindex="-1"></a>  pct_change_fmt,</span>
<span id="cb32-1157"><a href="#cb32-1157" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"Community District"</span>, <span class="st">"NTA"</span>, <span class="st">"150 m radius"</span>)</span>
<span id="cb32-1158"><a href="#cb32-1158" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1159"><a href="#cb32-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1160"><a href="#cb32-1160" aria-hidden="true" tabindex="-1"></a>add_row <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb32-1161"><a href="#cb32-1161" aria-hidden="true" tabindex="-1"></a>  <span class="at">term =</span> <span class="st">"Implied % change (100×(exp(β)−1))"</span>,</span>
<span id="cb32-1162"><a href="#cb32-1162" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Community District"</span> <span class="ot">=</span> pct_change_fmt[[<span class="st">"Community District"</span>]],</span>
<span id="cb32-1163"><a href="#cb32-1163" aria-hidden="true" tabindex="-1"></a>  <span class="st">"NTA"</span>                <span class="ot">=</span> pct_change_fmt[[<span class="st">"NTA"</span>]],</span>
<span id="cb32-1164"><a href="#cb32-1164" aria-hidden="true" tabindex="-1"></a>  <span class="st">"150 m radius"</span>       <span class="ot">=</span> pct_change_fmt[[<span class="st">"150 m radius"</span>]],</span>
<span id="cb32-1165"><a href="#cb32-1165" aria-hidden="true" tabindex="-1"></a>  <span class="at">check.names =</span> <span class="cn">FALSE</span></span>
<span id="cb32-1166"><a href="#cb32-1166" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1167"><a href="#cb32-1167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1168"><a href="#cb32-1168" aria-hidden="true" tabindex="-1"></a><span class="co"># ---- Results table ----</span></span>
<span id="cb32-1169"><a href="#cb32-1169" aria-hidden="true" tabindex="-1"></a><span class="fu">modelsummary</span>(</span>
<span id="cb32-1170"><a href="#cb32-1170" aria-hidden="true" tabindex="-1"></a>  models,</span>
<span id="cb32-1171"><a href="#cb32-1171" aria-hidden="true" tabindex="-1"></a>  <span class="at">statistic =</span> <span class="st">"({std.error})"</span>,</span>
<span id="cb32-1172"><a href="#cb32-1172" aria-hidden="true" tabindex="-1"></a>  <span class="at">stars =</span> <span class="cn">TRUE</span>,</span>
<span id="cb32-1173"><a href="#cb32-1173" aria-hidden="true" tabindex="-1"></a>  <span class="at">coef_map =</span> <span class="fu">c</span>(</span>
<span id="cb32-1174"><a href="#cb32-1174" aria-hidden="true" tabindex="-1"></a>    <span class="st">"post_pass_cd"</span> <span class="ot">=</span> <span class="st">"Post-PASS"</span>,</span>
<span id="cb32-1175"><a href="#cb32-1175" aria-hidden="true" tabindex="-1"></a>    <span class="st">"post_pass"</span>    <span class="ot">=</span> <span class="st">"Post-PASS"</span>,</span>
<span id="cb32-1176"><a href="#cb32-1176" aria-hidden="true" tabindex="-1"></a>    <span class="st">"post_pass_w"</span>  <span class="ot">=</span> <span class="st">"Post-PASS"</span></span>
<span id="cb32-1177"><a href="#cb32-1177" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb32-1178"><a href="#cb32-1178" aria-hidden="true" tabindex="-1"></a>  <span class="at">add_rows =</span> add_row,</span>
<span id="cb32-1179"><a href="#cb32-1179" aria-hidden="true" tabindex="-1"></a>  <span class="at">output =</span> <span class="st">"html"</span></span>
<span id="cb32-1180"><a href="#cb32-1180" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1181"><a href="#cb32-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1182"><a href="#cb32-1182" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1183"><a href="#cb32-1183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1184"><a href="#cb32-1184" aria-hidden="true" tabindex="-1"></a>Comparative Point Plot Across Spatial Scales</span>
<span id="cb32-1185"><a href="#cb32-1185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1188"><a href="#cb32-1188" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1189"><a href="#cb32-1189" aria-hidden="true" tabindex="-1"></a><span class="co"># Helper: convert log effect + SE into percent change + 95% interval</span></span>
<span id="cb32-1190"><a href="#cb32-1190" aria-hidden="true" tabindex="-1"></a>to_pct_ci <span class="ot">&lt;-</span> <span class="cf">function</span>(beta, se, <span class="at">z =</span> <span class="fl">1.96</span>) {</span>
<span id="cb32-1191"><a href="#cb32-1191" aria-hidden="true" tabindex="-1"></a>  lo <span class="ot">&lt;-</span> beta <span class="sc">-</span> z <span class="sc">*</span> se</span>
<span id="cb32-1192"><a href="#cb32-1192" aria-hidden="true" tabindex="-1"></a>  hi <span class="ot">&lt;-</span> beta <span class="sc">+</span> z <span class="sc">*</span> se</span>
<span id="cb32-1193"><a href="#cb32-1193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1194"><a href="#cb32-1194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(</span>
<span id="cb32-1195"><a href="#cb32-1195" aria-hidden="true" tabindex="-1"></a>    <span class="at">estimate_pct =</span> (<span class="fu">exp</span>(beta) <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb32-1196"><a href="#cb32-1196" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_pct    =</span> (<span class="fu">exp</span>(lo)   <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span>,</span>
<span id="cb32-1197"><a href="#cb32-1197" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_pct    =</span> (<span class="fu">exp</span>(hi)   <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb32-1198"><a href="#cb32-1198" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-1199"><a href="#cb32-1199" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-1200"><a href="#cb32-1200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1201"><a href="#cb32-1201" aria-hidden="true" tabindex="-1"></a><span class="co"># 1) Community Districts: m_cd (fixest::fepois), coefficient is post_pass_cd</span></span>
<span id="cb32-1202"><a href="#cb32-1202" aria-hidden="true" tabindex="-1"></a>b_cd  <span class="ot">&lt;-</span> <span class="fu">coef</span>(m_cd)[[<span class="st">"post_pass_cd"</span>]]</span>
<span id="cb32-1203"><a href="#cb32-1203" aria-hidden="true" tabindex="-1"></a>se_cd <span class="ot">&lt;-</span> <span class="fu">se</span>(m_cd)[[<span class="st">"post_pass_cd"</span>]]</span>
<span id="cb32-1204"><a href="#cb32-1204" aria-hidden="true" tabindex="-1"></a>ci_cd <span class="ot">&lt;-</span> <span class="fu">to_pct_ci</span>(b_cd, se_cd)</span>
<span id="cb32-1205"><a href="#cb32-1205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1206"><a href="#cb32-1206" aria-hidden="true" tabindex="-1"></a><span class="co"># 2) 150m: m150_w (fixest::fepois), coefficient is post_pass_w</span></span>
<span id="cb32-1207"><a href="#cb32-1207" aria-hidden="true" tabindex="-1"></a>b_150  <span class="ot">&lt;-</span> <span class="fu">coef</span>(m150_w)[[<span class="st">"post_pass_w"</span>]]</span>
<span id="cb32-1208"><a href="#cb32-1208" aria-hidden="true" tabindex="-1"></a>se_150 <span class="ot">&lt;-</span> <span class="fu">se</span>(m150_w)[[<span class="st">"post_pass_w"</span>]]</span>
<span id="cb32-1209"><a href="#cb32-1209" aria-hidden="true" tabindex="-1"></a>ci_150 <span class="ot">&lt;-</span> <span class="fu">to_pct_ci</span>(b_150, se_150)</span>
<span id="cb32-1210"><a href="#cb32-1210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1211"><a href="#cb32-1211" aria-hidden="true" tabindex="-1"></a><span class="co"># 3) NTA: model (glm), coefficient is post_pass</span></span>
<span id="cb32-1212"><a href="#cb32-1212" aria-hidden="true" tabindex="-1"></a>b_nta  <span class="ot">&lt;-</span> <span class="fu">coef</span>(m)[[<span class="st">"post_pass"</span>]]</span>
<span id="cb32-1213"><a href="#cb32-1213" aria-hidden="true" tabindex="-1"></a>se_nta <span class="ot">&lt;-</span> <span class="fu">coef</span>(m)[[<span class="st">"post_pass"</span>]]</span>
<span id="cb32-1214"><a href="#cb32-1214" aria-hidden="true" tabindex="-1"></a>ci_nta <span class="ot">&lt;-</span> <span class="fu">to_pct_ci</span>(b_nta, se_nta)</span>
<span id="cb32-1215"><a href="#cb32-1215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1216"><a href="#cb32-1216" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine into one table (ready for a comparative point plot)</span></span>
<span id="cb32-1217"><a href="#cb32-1217" aria-hidden="true" tabindex="-1"></a>results_all <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb32-1218"><a href="#cb32-1218" aria-hidden="true" tabindex="-1"></a>  <span class="at">scale =</span> <span class="fu">c</span>(<span class="st">"150m radius"</span>, <span class="st">"NTA"</span>, <span class="st">"Community District"</span>),</span>
<span id="cb32-1219"><a href="#cb32-1219" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimate_pct =</span> <span class="fu">c</span>(ci_150[<span class="st">"estimate_pct"</span>], ci_nta[<span class="st">"estimate_pct"</span>], ci_cd[<span class="st">"estimate_pct"</span>]),</span>
<span id="cb32-1220"><a href="#cb32-1220" aria-hidden="true" tabindex="-1"></a>  <span class="at">lower_pct    =</span> <span class="fu">c</span>(ci_150[<span class="st">"lower_pct"</span>],    ci_nta[<span class="st">"lower_pct"</span>],    ci_cd[<span class="st">"lower_pct"</span>]),</span>
<span id="cb32-1221"><a href="#cb32-1221" aria-hidden="true" tabindex="-1"></a>  <span class="at">upper_pct    =</span> <span class="fu">c</span>(ci_150[<span class="st">"upper_pct"</span>],    ci_nta[<span class="st">"upper_pct"</span>],    ci_cd[<span class="st">"upper_pct"</span>]),</span>
<span id="cb32-1222"><a href="#cb32-1222" aria-hidden="true" tabindex="-1"></a>  <span class="at">row.names =</span> <span class="cn">NULL</span></span>
<span id="cb32-1223"><a href="#cb32-1223" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb32-1224"><a href="#cb32-1224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1225"><a href="#cb32-1225" aria-hidden="true" tabindex="-1"></a>results_all</span>
<span id="cb32-1226"><a href="#cb32-1226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1227"><a href="#cb32-1227" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1228"><a href="#cb32-1228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1229"><a href="#cb32-1229" aria-hidden="true" tabindex="-1"></a>Compute "complaint drop" vs "expected drop" per NTA.</span>
<span id="cb32-1230"><a href="#cb32-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1231"><a href="#cb32-1231" aria-hidden="true" tabindex="-1"></a>actual_drop = how much calls actually fell after PASS</span>
<span id="cb32-1232"><a href="#cb32-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1233"><a href="#cb32-1233" aria-hidden="true" tabindex="-1"></a>pred_drop = how much the model says they should have fallen</span>
<span id="cb32-1234"><a href="#cb32-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1235"><a href="#cb32-1235" aria-hidden="true" tabindex="-1"></a>drop_score = pred_drop – actual_drop</span>
<span id="cb32-1236"><a href="#cb32-1236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1237"><a href="#cb32-1237" aria-hidden="true" tabindex="-1"></a>Big positive drop_score = “calls didn’t drop as much as expected” → bias signal.</span>
<span id="cb32-1238"><a href="#cb32-1238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1241"><a href="#cb32-1241" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1242"><a href="#cb32-1242" aria-hidden="true" tabindex="-1"></a><span class="co"># Predicted calls from the model</span></span>
<span id="cb32-1243"><a href="#cb32-1243" aria-hidden="true" tabindex="-1"></a>panel_event<span class="sc">$</span>pred_calls <span class="ot">&lt;-</span> <span class="fu">predict</span>(m, <span class="at">newdata =</span> panel_event, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb32-1244"><a href="#cb32-1244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1245"><a href="#cb32-1245" aria-hidden="true" tabindex="-1"></a><span class="co"># Pre/post averages and DropScore</span></span>
<span id="cb32-1246"><a href="#cb32-1246" aria-hidden="true" tabindex="-1"></a>drops <span class="ot">&lt;-</span> panel_event <span class="sc">%&gt;%</span></span>
<span id="cb32-1247"><a href="#cb32-1247" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(area_id) <span class="sc">%&gt;%</span></span>
<span id="cb32-1248"><a href="#cb32-1248" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb32-1249"><a href="#cb32-1249" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_pre  =</span> <span class="fu">mean</span>(calls[post_pass <span class="sc">==</span> <span class="dv">0</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-1250"><a href="#cb32-1250" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_post =</span> <span class="fu">mean</span>(calls[post_pass <span class="sc">==</span> <span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-1251"><a href="#cb32-1251" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_pre    =</span> <span class="fu">mean</span>(pred_calls[post_pass <span class="sc">==</span> <span class="dv">0</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-1252"><a href="#cb32-1252" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_post   =</span> <span class="fu">mean</span>(pred_calls[post_pass <span class="sc">==</span> <span class="dv">1</span>], <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb32-1253"><a href="#cb32-1253" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">"drop"</span></span>
<span id="cb32-1254"><a href="#cb32-1254" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-1255"><a href="#cb32-1255" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-1256"><a href="#cb32-1256" aria-hidden="true" tabindex="-1"></a>    <span class="at">actual_drop =</span> actual_pre <span class="sc">-</span> actual_post,</span>
<span id="cb32-1257"><a href="#cb32-1257" aria-hidden="true" tabindex="-1"></a>    <span class="at">pred_drop   =</span> pred_pre   <span class="sc">-</span> pred_post,</span>
<span id="cb32-1258"><a href="#cb32-1258" aria-hidden="true" tabindex="-1"></a>    <span class="at">drop_score  =</span> pred_drop  <span class="sc">-</span> actual_drop</span>
<span id="cb32-1259"><a href="#cb32-1259" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb32-1260"><a href="#cb32-1260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1261"><a href="#cb32-1261" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1262"><a href="#cb32-1262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1263"><a href="#cb32-1263" aria-hidden="true" tabindex="-1"></a>Flag "bias NTAs" High calls before PASS + no drop afterward = bias.</span>
<span id="cb32-1264"><a href="#cb32-1264" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1267"><a href="#cb32-1267" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb32-1268"><a href="#cb32-1268" aria-hidden="true" tabindex="-1"></a><span class="co"># Thresholds for unusually high pre-PASS calls and unusually high non-response score</span></span>
<span id="cb32-1269"><a href="#cb32-1269" aria-hidden="true" tabindex="-1"></a>q75_pre  <span class="ot">&lt;-</span> <span class="fu">quantile</span>(drops<span class="sc">$</span>actual_pre,  <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-1270"><a href="#cb32-1270" aria-hidden="true" tabindex="-1"></a>q75_drop <span class="ot">&lt;-</span> <span class="fu">quantile</span>(drops<span class="sc">$</span>drop_score, <span class="fl">0.75</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-1271"><a href="#cb32-1271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1272"><a href="#cb32-1272" aria-hidden="true" tabindex="-1"></a>biased_areas <span class="ot">&lt;-</span> drops <span class="sc">%&gt;%</span></span>
<span id="cb32-1273"><a href="#cb32-1273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb32-1274"><a href="#cb32-1274" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_pre  =</span> actual_pre <span class="sc">&gt;=</span> q75_pre,</span>
<span id="cb32-1275"><a href="#cb32-1275" aria-hidden="true" tabindex="-1"></a>    <span class="at">high_drop =</span> drop_score <span class="sc">&gt;=</span> q75_drop,</span>
<span id="cb32-1276"><a href="#cb32-1276" aria-hidden="true" tabindex="-1"></a>    <span class="at">bias_flag =</span> high_pre <span class="sc">&amp;</span> high_drop</span>
<span id="cb32-1277"><a href="#cb32-1277" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb32-1278"><a href="#cb32-1278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(drop_score))</span>
<span id="cb32-1279"><a href="#cb32-1279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1280"><a href="#cb32-1280" aria-hidden="true" tabindex="-1"></a>biased_areas <span class="sc">%&gt;%</span></span>
<span id="cb32-1281"><a href="#cb32-1281" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(bias_flag) <span class="sc">%&gt;%</span></span>
<span id="cb32-1282"><a href="#cb32-1282" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>()</span>
<span id="cb32-1283"><a href="#cb32-1283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1284"><a href="#cb32-1284" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb32-1285"><a href="#cb32-1285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1286"><a href="#cb32-1286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1287"><a href="#cb32-1287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1288"><a href="#cb32-1288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1289"><a href="#cb32-1289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-1290"><a href="#cb32-1290" aria-hidden="true" tabindex="-1"></a><span class="fu"># Conclusion/ Further Steps</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>